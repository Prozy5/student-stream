<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SS Clips Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:radial-gradient(circle at top,#0b1430,#000);
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,system-ui;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 24px;
  background:rgba(255,255,255,.06);
}
button{
  padding:8px 14px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}
.logout{background:#ef4444;color:#000}
.panel{
  padding:20px;
}
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:14px;
}
.card{
  background:rgba(255,255,255,.08);
  padding:14px;
  border-radius:14px;
}
.controls{
  margin-top:20px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
input,select,textarea{
  padding:8px;
  border-radius:8px;
  border:none;
}
table{
  width:100%;
  margin-top:20px;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.1);
  vertical-align:top;
}
.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
}
.pending{background:#facc15;color:#000}
.approved{background:#22c55e;color:#000}
.rejected{background:#ef4444}
.featured{background:#38bdf8;color:#000}
.actions button{margin-right:6px}
video{max-width:120px;border-radius:10px}
textarea{width:100%;resize:none}
</style>
</head>

<body>

<header>
  <strong>SS Clips — Admin Control</strong>
  <button class="logout" onclick="logout()">Logout</button>
</header>

<div class="panel">

<section class="stats">
  <div class="card">Total <b id="s_total">0</b></div>
  <div class="card">Pending <b id="s_pending">0</b></div>
  <div class="card">Approved <b id="s_approved">0</b></div>
  <div class="card">Featured <b id="s_featured">0</b></div>
  <div class="card">Paid <b id="s_paid">0</b></div>
  <div class="card">Revenue $<b id="s_revenue">0</b></div>
</section>

<div class="controls">
  <input id="search" placeholder="Search email or creator">
  <select id="filter">
    <option value="">All</option>
    <option value="pending">Pending</option>
    <option value="approved">Approved</option>
    <option value="rejected">Rejected</option>
  </select>
  <button onclick="bulk('approved')">Bulk Approve</button>
  <button onclick="bulk('rejected')">Bulk Reject</button>
  <button onclick="bulkFeature()">Bulk Feature</button>
</div>

<table>
<thead>
<tr>
<th></th>
<th>Clip</th>
<th>Creator</th>
<th>Status</th>
<th>Paid</th>
<th>Revenue</th>
<th>Admin Notes</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

</div>

<script>
const supabase = supabase.createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

let selected=new Set(), adminId=null;

(async()=>{
  const {data:{session}}=await supabase.auth.getSession();
  if(!session)location.href="/ss-clips/admin-login.html";

  adminId=session.user.id;
  const {data:admin}=await supabase.from("admins").select("*").eq("user_id",adminId).single();
  if(!admin)location.href="/";

  load();
})();

async function logout(){
  await supabase.auth.signOut();
  location.href="/ss-clips/admin-login.html";
}

async function log(action,id){
  await supabase.from("admin_logs").insert({admin_id:adminId,clip_id:id,action});
}

async function load(){
  const {data}=await supabase.from("clips").select("*").order("created_at",{ascending:false});

  let t=0,p=0,a=0,f=0,paid=0,rev=0;
  rows.innerHTML="";

  data.forEach(c=>{
    t++;
    if(c.status==="pending")p++;
    if(c.status==="approved")a++;
    if(c.featured)f++;
    if(c.payment_status==="paid")paid++;
    rev+=Number(c.revenue||0);

    rows.innerHTML+=`
    <tr>
      <td><input type="checkbox" onchange="toggle('${c.id}')"></td>
      <td><video src="${c.video_url}" controls muted></video></td>
      <td>${c.creator_email||"—"}</td>
      <td><span class="badge ${c.status}">${c.status}</span></td>
      <td>${c.payment_status}</td>
      <td>$<input value="${c.revenue||0}" style="width:70px" onchange="setRevenue('${c.id}',this.value)"></td>
      <td><textarea onchange="setNote('${c.id}',this.value)">${c.admin_note||""}</textarea></td>
      <td class="actions">
        <button onclick="setStatus('${c.id}','approved')">Approve</button>
        <button onclick="setStatus('${c.id}','rejected')">Reject</button>
        <button onclick="toggleFeature('${c.id}',${!c.featured})">${c.featured?"Unfeature":"Feature"}</button>
        <button onclick="markPaid('${c.id}')">Mark Paid</button>
        <button onclick="del('${c.id}')">Delete</button>
      </td>
    </tr>`;
  });

  s_total.textContent=t;
  s_pending.textContent=p;
  s_approved.textContent=a;
  s_featured.textContent=f;
  s_paid.textContent=paid;
  s_revenue.textContent=rev.toFixed(2);
}

function toggle(id){selected.has(id)?selected.delete(id):selected.add(id)}

async function bulk(status){
  for(const id of selected) await setStatus(id,status,false);
  selected.clear();load();
}

async function bulkFeature(){
  for(const id of selected) await toggleFeature(id,true,false);
  selected.clear();load();
}

async function setStatus(id,status,refresh=true){
  await supabase.from("clips").update({status}).eq("id",id);
  await log(status,id);
  if(refresh)load();
}

async function toggleFeature(id,val,refresh=true){
  await supabase.from("clips").update({featured:val}).eq("id",id);
  await log(val?"featured":"unfeatured",id);
  if(refresh)load();
}

async function markPaid(id){
  await supabase.from("clips").update({payment_status:"paid"}).eq("id",id);
  await log("paid",id);load();
}

async function setRevenue(id,val){
  await supabase.from("clips").update({revenue:val}).eq("id",id);
}

async function setNote(id,val){
  await supabase.from("clips").update({admin_note:val}).eq("id",id);
}

async function del(id){
  if(!confirm("Delete clip?"))return;
  await supabase.from("clips").delete().eq("id",id);
  await log("deleted",id);load();
}

filter.onchange=load;
search.oninput=()=>{
  [...rows.children].forEach(r=>{
    r.style.display=r.innerText.toLowerCase().includes(search.value.toLowerCase())?"":"none";
  });
};
</script>

</body>
</html>