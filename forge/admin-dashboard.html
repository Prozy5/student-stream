<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forge Admin Dashboard</title>

  <!-- SUPABASE -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://iabzmoxzbqzcqgypxctr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
    );

    /* ==========================
       LOAD CLIENTS
    ========================== */
    async function loadClients(){
      const { data, error } = await supabase
        .from("forge_clients")
        .select("*")
        .order("created_at", { ascending:false });

      if(error){
        alert("Client load error");
        return;
      }

      const box = document.getElementById("clientsBox");
      box.innerHTML = "";

      data.forEach(client=>{
        box.innerHTML += `
          <div class="miniCard">
            <b>${client.full_name}</b><br>
            <span>@${client.social_handle || "none"}</span><br>
            <small>${client.plan} Â· ${client.status}</small>
          </div>
        `;
      });
    }

    /* ==========================
       LOAD TASKS
    ========================== */
    async function loadTasks(){
      const { data, error } = await supabase
        .from("forge_tasks")
        .select("*, forge_clients(full_name)")
        .order("created_at", { ascending:false });

      if(error){
        alert("Task load error");
        return;
      }

      const box = document.getElementById("tasksBox");
      box.innerHTML = "";

      data.forEach(task=>{
        box.innerHTML += `
          <div class="miniCard">
            <b>${task.title}</b><br>
            <small>Client: ${task.forge_clients.full_name}</small><br>
            <span>Status: ${task.task_status}</span>
          </div>
        `;
      });
    }

    /* ==========================
       LOAD MESSAGES
    ========================== */
    async function loadMessages(){
      const { data, error } = await supabase
        .from("forge_messages")
        .select("*, forge_clients(full_name)")
        .order("created_at", { ascending:false });

      if(error){
        alert("Message load error");
        return;
      }

      const box = document.getElementById("messagesBox");
      box.innerHTML = "";

      data.forEach(msg=>{
        box.innerHTML += `
          <div class="miniCard">
            <b>${msg.forge_clients.full_name}</b><br>
            <small>${msg.sender}</small><br>
            <span>${msg.message}</span>
          </div>
        `;
      });
    }

    /* ==========================
       ADD TASK
    ========================== */
    window.addTask = async function(e){
      e.preventDefault();

      const clientID = document.getElementById("taskClient").value;
      const title = document.getElementById("taskTitle").value;

      await supabase.from("forge_tasks").insert([
        { client_id: clientID, title }
      ]);

      e.target.reset();
      loadTasks();
    }

    /* ==========================
       SEND MESSAGE
    ========================== */
    window.sendMessage = async function(e){
      e.preventDefault();

      const clientID = document.getElementById("msgClient").value;
      const message = document.getElementById("msgText").value;

      await supabase.from("forge_messages").insert([
        { client_id: clientID, message }
      ]);

      e.target.reset();
      loadMessages();
    }

    /* ==========================
       INIT DASHBOARD
    ========================== */
    async function init(){
      await loadClients();
      await loadTasks();
      await loadMessages();

      // Load dropdown clients
      const { data } = await supabase.from("forge_clients").select("*");

      const taskDrop = document.getElementById("taskClient");
      const msgDrop = document.getElementById("msgClient");

      data.forEach(c=>{
        taskDrop.innerHTML += `<option value="${c.id}">${c.full_name}</option>`;
        msgDrop.innerHTML += `<option value="${c.id}">${c.full_name}</option>`;
      });
    }

    init();
  </script>

  <style>
    body{
      margin:0;
      font-family:system-ui;
      background:#050807;
      color:white;
    }

    header{
      padding:20px;
      font-size:22px;
      font-weight:900;
      border-bottom:1px solid rgba(255,255,255,0.1);
    }

    .wrap{
      padding:30px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:25px;
    }

    .card{
      background:rgba(20,30,22,0.92);
      border:1px solid rgba(108,255,159,0.18);
      border-radius:20px;
      padding:20px;
    }

    h2{
      margin:0 0 12px;
      font-size:16px;
      color:#6cff9f;
    }

    .miniCard{
      padding:12px;
      border-radius:14px;
      margin-top:10px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.06);
    }

    form input, form select{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:none;
      margin-top:10px;
      background:rgba(255,255,255,0.06);
      color:white;
    }

    button{
      width:100%;
      padding:12px;
      margin-top:12px;
      border:none;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      background:rgba(108,255,159,0.22);
      color:#6cff9f;
    }
  </style>
</head>

<body>

<header>
  Forge Admin Command Center (Clients + Tasks + Messaging)
</header>

<div class="wrap">

  <!-- CLIENTS -->
  <div class="card">
    <h2>Clients</h2>
    <div id="clientsBox"></div>
  </div>

  <!-- TASKS -->
  <div class="card">
    <h2>Tasks</h2>
    <div id="tasksBox"></div>

    <form onsubmit="addTask(event)">
      <select id="taskClient"></select>
      <input id="taskTitle" placeholder="New Task Title" required/>
      <button>Add Task</button>
    </form>
  </div>

  <!-- MESSAGES -->
  <div class="card">
    <h2>Client Messages</h2>
    <div id="messagesBox"></div>

    <form onsubmit="sendMessage(event)">
      <select id="msgClient"></select>
      <input id="msgText" placeholder="Send message..." required/>
      <button>Send Message</button>
    </form>
  </div>

</div>

</body>
</html>