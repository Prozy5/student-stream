<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forge AI – Command Center</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

/* ---------------- STATE ---------------- */
let state = {
  clients: [],
  tasks: [],
  messages: []
};

/* ---------------- INIT ---------------- */
async function init(){
  await loadAll();
  startClock();
  setInterval(loadAll, 20000); // auto refresh
}

async function loadAll(){
  await Promise.all([
    loadClients(),
    loadTasks(),
    loadMessages()
  ]);
  updateStats();
  renderActivity();
}

/* ---------------- LOADERS ---------------- */
async function loadClients(){
  const { data } = await supabase
    .from("forge_clients")
    .select("*")
    .order("created_at",{ascending:false});
  state.clients = data || [];
  renderClients();
}

async function loadTasks(){
  const { data } = await supabase
    .from("forge_tasks")
    .select("*, forge_clients(full_name)")
    .order("created_at",{ascending:false});
  state.tasks = data || [];
  renderTasks();
}

async function loadMessages(){
  const { data } = await supabase
    .from("forge_messages")
    .select("*, forge_clients(full_name)")
    .order("created_at",{ascending:false})
    .limit(6);
  state.messages = data || [];
  renderMessages();
}

/* ---------------- RENDER ---------------- */
function updateStats(){
  animate("statClients", state.clients.length);
  animate("statTasks", state.tasks.length);
  animate("statMessages", state.messages.length);

  const open = state.tasks.filter(t=>t.task_status!=="DONE").length;
  const threat = document.getElementById("threatLevel");

  if(open > 8){
    threat.innerText = "HIGH";
    threat.className="danger";
  } else if(open > 4){
    threat.innerText="MEDIUM";
    threat.className="warning";
  } else {
    threat.innerText="LOW";
    threat.className="safe";
  }

  const revenue = state.clients.length * 99;
  animate("statRevenue", revenue);
}

function renderClients(){
  document.getElementById("clientTable").innerHTML =
    state.clients.map(c=>`
      <tr>
        <td>${c.full_name}</td>
        <td>@${c.social_handle || "—"}</td>
        <td><span class="pill">${c.plan}</span></td>
        <td>${c.status}</td>
      </tr>
    `).join("");
}

function renderTasks(){
  const cols={
    TODO:document.getElementById("todo"),
    PROGRESS:document.getElementById("progress"),
    DONE:document.getElementById("done")
  };
  Object.values(cols).forEach(c=>c.innerHTML="");

  state.tasks.forEach(t=>{
    const card=`
      <div class="taskCard">
        <b>${t.title}</b>
        <small>${t.forge_clients?.full_name||""}</small>
      </div>`;
    if(cols[t.task_status]) cols[t.task_status].innerHTML+=card;
  });
}

function renderMessages(){
  document.getElementById("messages").innerHTML=
    state.messages.map(m=>`
      <div class="msg">
        <b>${m.forge_clients?.full_name}</b>
        <p>${m.message}</p>
      </div>
    `).join("");
}

function renderActivity(){
  const feed=document.getElementById("activity");
  const recent=[
    ...state.tasks.slice(0,3).map(t=>`Task created: ${t.title}`),
    ...state.messages.slice(0,3).map(m=>`Message from ${m.forge_clients?.full_name}`)
  ];
  feed.innerHTML=recent.map(i=>`<div class="activityItem">${i}</div>`).join("");
}

/* ---------------- UTIL ---------------- */
function animate(id,val){
  let el=document.getElementById(id);
  let cur=0;
  const step=Math.ceil(val/25)||1;
  const i=setInterval(()=>{
    cur+=step;
    if(cur>=val){cur=val;clearInterval(i);}
    el.innerText=cur;
  },20);
}

function startClock(){
  setInterval(()=>{
    document.getElementById("clock").innerText=
      new Date().toLocaleTimeString();
  },1000);
}

init();
</script>

<style>
:root{
--green:#6cff9f;
--bg1:#040a06;
--bg2:#010302;
--danger:#ff5e5e;
--warning:#ffb84d;
}

body{
margin:0;
font-family:Inter,system-ui;
background:
radial-gradient(circle at top,var(--bg1),var(--bg2));
color:white;
overflow-x:hidden;
}

/* subtle animated grid */
body::after{
content:"";
position:fixed;
inset:0;
background-image:
linear-gradient(rgba(108,255,159,.05) 1px,transparent 1px),
linear-gradient(90deg,rgba(108,255,159,.05) 1px,transparent 1px);
background-size:60px 60px;
animation:gridMove 30s linear infinite;
pointer-events:none;
}
@keyframes gridMove{
from{transform:translateY(0);}
to{transform:translateY(60px);}
}

.layout{
display:grid;
grid-template-columns:250px 1fr;
min-height:100vh;
}

.sidebar{
background:#08120d;
padding:30px;
border-right:1px solid rgba(255,255,255,.05);
}

.logo{
color:var(--green);
font-weight:900;
margin-bottom:40px;
font-size:22px;
}

.nav a{
display:block;
color:rgba(255,255,255,.6);
text-decoration:none;
margin-bottom:15px;
padding:10px;
border-radius:8px;
transition:.2s;
}
.nav a:hover{
background:rgba(108,255,159,.1);
color:var(--green);
}

.main{
padding:30px;
}

.topbar{
display:flex;
justify-content:space-between;
margin-bottom:25px;
}

.clock{color:var(--green);font-weight:700;}

.stats{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:18px;
margin-bottom:25px;
}

.card{
background:rgba(255,255,255,.03);
border:1px solid rgba(255,255,255,.05);
padding:20px;
border-radius:16px;
}

.card h2{
margin:0;
font-size:28px;
color:var(--green);
}

.safe{color:var(--green);}
.warning{color:var(--warning);}
.danger{color:var(--danger);}

.grid{
display:grid;
grid-template-columns:2fr 1fr;
gap:20px;
}

.panel{
background:rgba(255,255,255,.02);
border:1px solid rgba(255,255,255,.05);
padding:20px;
border-radius:18px;
}

.panel h3{
font-size:13px;
opacity:.6;
margin-bottom:15px;
text-transform:uppercase;
}

table{width:100%;border-collapse:collapse;}
td{padding:10px;border-bottom:1px solid rgba(255,255,255,.05);}

.pill{
background:rgba(108,255,159,.1);
padding:4px 10px;
border-radius:999px;
color:var(--green);
font-size:12px;
}

.board{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:10px;
}

.taskCard{
background:rgba(108,255,159,.08);
border:1px solid rgba(108,255,159,.2);
padding:10px;
border-radius:10px;
margin-bottom:10px;
transition:.2s;
}
.taskCard:hover{
transform:translateY(-3px);
box-shadow:0 0 15px rgba(108,255,159,.3);
}

.msg{
background:rgba(255,255,255,.03);
padding:10px;
border-radius:10px;
margin-bottom:10px;
}

.activityItem{
font-size:13px;
opacity:.7;
margin-bottom:8px;
}

@media(max-width:1000px){
.layout{grid-template-columns:1fr;}
.sidebar{display:none;}
.grid{grid-template-columns:1fr;}
}
</style>
</head>

<body>

<div class="layout">
<aside class="sidebar">
<div class="logo">Forge AI</div>
<div class="nav">
<a href="#">Dashboard</a>
<a href="#">Clients</a>
<a href="#">Tasks</a>
<a href="#">Security</a>
</div>
</aside>

<main class="main">

<div class="topbar">
<div>AI Core Operational</div>
<div class="clock" id="clock"></div>
</div>

<div class="stats">
<div class="card"><h2 id="statClients">0</h2><p>Clients</p></div>
<div class="card"><h2 id="statTasks">0</h2><p>Tasks</p></div>
<div class="card"><h2 id="statMessages">0</h2><p>Messages</p></div>
<div class="card"><h2 id="statRevenue">0</h2><p>Revenue ($)</p></div>
<div class="card"><h2 id="threatLevel" class="safe">LOW</h2><p>Threat Level</p></div>
</div>

<div class="grid">

<div class="panel">
<h3>Client Pipeline</h3>
<table><tbody id="clientTable"></tbody></table>

<h3 style="margin-top:20px;">Task Board</h3>
<div class="board">
<div><h4>TODO</h4><div id="todo"></div></div>
<div><h4>PROGRESS</h4><div id="progress"></div></div>
<div><h4>DONE</h4><div id="done"></div></div>
</div>
</div>

<div class="panel">
<h3>Recent Messages</h3>
<div id="messages"></div>

<h3 style="margin-top:20px;">Live Activity</h3>
<div id="activity"></div>
</div>

</div>

</main>
</div>

</body>
</html>