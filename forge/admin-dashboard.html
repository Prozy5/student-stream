<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forge AI – Command Center</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

/* ---------------- STATE ---------------- */
let state = {
  clients: [],
  tasks: [],
  messages: [],
  securityEvents: [] // ADDED
};

/* ---------------- INIT ---------------- */
async function init(){
  await loadAll();
  startClock();
  setInterval(loadAll, 20000);
  enableRealtime();
}

function enableRealtime(){
  supabase.channel("forge-live")
    .on("postgres_changes",{event:"*",schema:"public"},()=>{
      loadAll();
    })
    .subscribe();
}

async function loadAll(){
  await Promise.all([
    loadClients(),
    loadTasks(),
    loadMessages(),
    loadSecurityEvents() // ADDED
  ]);
  updateStats();
  renderActivity();
  updateAdvancedMetrics();
  updateSecurityMetrics(); // ADDED
}

/* ---------------- LOADERS ---------------- */
async function loadClients(){
  const { data } = await supabase
    .from("forge_clients")
    .select("*")
    .order("created_at",{ascending:false});
  state.clients = data || [];
  renderClients();
}

async function loadTasks(){
  const { data } = await supabase
    .from("forge_tasks")
    .select("*, forge_clients(full_name)")
    .order("created_at",{ascending:false});
  state.tasks = data || [];
  renderTasks();
}

async function loadMessages(){
  const { data } = await supabase
    .from("forge_messages")
    .select("*, forge_clients(full_name)")
    .order("created_at",{ascending:false})
    .limit(6);
  state.messages = data || [];
  renderMessages();
}

/* ----------- NEW SECURITY LOADER ----------- */
async function loadSecurityEvents(){
  const { data } = await supabase
    .from("forge_security_events")
    .select("*")
    .order("created_at",{ascending:false})
    .limit(10);

  state.securityEvents = data || [];
  renderSecurityEvents();
}

/* ---------------- ORIGINAL STATS ---------------- */
function updateStats(){
  animate("statClients", state.clients.length);
  animate("statTasks", state.tasks.length);
  animate("statMessages", state.messages.length);

  const open = state.tasks.filter(t=>t.task_status!=="DONE").length;
  const threat = document.getElementById("threatLevel");

  if(open > 10){
    threat.innerText="CRITICAL";
    threat.className="danger";
  } else if(open > 6){
    threat.innerText="HIGH";
    threat.className="danger";
  } else if(open > 3){
    threat.innerText="MEDIUM";
    threat.className="warning";
  } else {
    threat.innerText="LOW";
    threat.className="safe";
  }

  const revenue = state.clients.length * 99;
  animate("statRevenue", revenue);
}

/* ---------------- NEW ADVANCED METRICS ---------------- */
function updateAdvancedMetrics(){

  const total = state.clients.length;
  const active = state.clients.filter(c=>c.status==="ACTIVE").length;

  const mrr = active * 99;
  const churn = total === 0 ? 0 :
    Math.round(((total - active) / total) * 100);

  const openTasks = state.tasks.filter(t=>t.task_status!=="DONE").length;
  const health = Math.max(0, 100 - churn - (openTasks * 2));

  animate("statMRR", mrr);
  animate("statChurn", churn);
  animate("statHealth", health);

  const growthBar = document.getElementById("growthBar");
  if(growthBar){
    const growthPercent = total === 0 ? 5 : Math.min(100, total * 10);
    growthBar.style.width = growthPercent + "%";
  }
}

/* ------------- NEW SECURITY METRICS ------------- */
function updateSecurityMetrics(){

  const totalEvents = state.securityEvents.length;
  const critical = state.securityEvents.filter(e=>e.severity==="CRITICAL").length;
  const warning = state.securityEvents.filter(e=>e.severity==="WARNING").length;

  animate("statSecurityEvents", totalEvents);

  const securityScore = Math.max(0, 100 - (critical*20) - (warning*5));
  animate("statSecurityScore", securityScore);

  const status = document.getElementById("securityStatus");
  if(status){
    if(critical > 0){
      status.innerText="BREACH RISK";
      status.className="danger";
    } else if(warning > 2){
      status.innerText="MONITORING";
      status.className="warning";
    } else {
      status.innerText="SECURE";
      status.className="safe";
    }
  }
}

/* ---------------- RENDER ---------------- */
function renderClients(){
  document.getElementById("clientTable").innerHTML =
    state.clients.map(c=>`
      <tr>
        <td>${c.full_name}</td>
        <td>@${c.social_handle || "—"}</td>
        <td><span class="pill">${c.plan}</span></td>
        <td>${c.status}</td>
      </tr>
    `).join("");
}

function renderTasks(){
  const cols={
    TODO:document.getElementById("todo"),
    PROGRESS:document.getElementById("progress"),
    DONE:document.getElementById("done")
  };
  Object.values(cols).forEach(c=>c.innerHTML="");

  state.tasks.forEach(t=>{
    const card=`
      <div class="taskCard">
        <b>${t.title}</b>
        <small>${t.forge_clients?.full_name||""}</small>
      </div>`;
    if(cols[t.task_status]) cols[t.task_status].innerHTML+=card;
  });
}

function renderMessages(){
  document.getElementById("messages").innerHTML=
    state.messages.map(m=>`
      <div class="msg">
        <b>${m.forge_clients?.full_name}</b>
        <p>${m.message}</p>
      </div>
    `).join("");
}

function renderActivity(){
  const feed=document.getElementById("activity");
  const recent=[
    ...state.tasks.slice(0,3).map(t=>`Task created: ${t.title}`),
    ...state.messages.slice(0,3).map(m=>`Message from ${m.forge_clients?.full_name}`)
  ];
  feed.innerHTML=recent.map(i=>`<div class="activityItem">${i}</div>`).join("");
}

/* ----------- NEW SECURITY RENDER ----------- */
function renderSecurityEvents(){
  const container = document.getElementById("securityLog");
  if(!container) return;

  container.innerHTML = state.securityEvents.map(e=>`
    <div class="securityItem ${e.severity?.toLowerCase()}">
      <b>${e.event_type}</b>
      <div style="font-size:12px;opacity:.6">${e.description}</div>
    </div>
  `).join("");
}

/* ---------------- UTIL ---------------- */
function animate(id,val){
  const el=document.getElementById(id);
  if(!el) return;
  let cur=0;
  const step=Math.ceil(val/25)||1;
  const i=setInterval(()=>{
    cur+=step;
    if(cur>=val){cur=val;clearInterval(i);}
    el.innerText=cur;
  },20);
}

function startClock(){
  setInterval(()=>{
    document.getElementById("clock").innerText=
      new Date().toLocaleTimeString();
  },1000);
}

init();
</script>

<style>
/* ---- ADDING SECURITY UI (no deletions) ---- */

.securityItem{
padding:10px;
margin-bottom:8px;
border-radius:8px;
background:rgba(255,255,255,.03);
border-left:4px solid var(--green);
}

.securityItem.warning{
border-left:4px solid var(--warning);
}

.securityItem.critical{
border-left:4px solid var(--danger);
}
</style>
</head>

<body>

<!-- EVERYTHING YOU ALREADY HAD REMAINS EXACTLY THE SAME ABOVE -->

<!-- ADD THIS SECURITY PANEL BELOW LIVE ACTIVITY PANEL -->

<div class="panel" style="margin:30px;">
<h3>Security Monitoring</h3>

<div class="stats">
<div class="card"><h2 id="statSecurityEvents">0</h2><p>Security Events</p></div>
<div class="card"><h2 id="statSecurityScore">100</h2><p>Security Score</p></div>
<div class="card"><h2 id="securityStatus" class="safe">SECURE</h2><p>Status</p></div>
</div>

<div id="securityLog"></div>
</div>

</body>
</html>