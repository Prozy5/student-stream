<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forge AI – Control Center</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

/* ------------------ STATE ------------------ */
let state = {
  clients: [],
  tasks: [],
  messages: []
};

/* ------------------ INIT ------------------ */
async function init(){
  await loadAll();
  startClock();
}

async function loadAll(){
  await Promise.all([
    loadClients(),
    loadTasks(),
    loadMessages()
  ]);
  updateStats();
}

/* ------------------ LOADERS ------------------ */
async function loadClients(){
  const { data, error } = await supabase
    .from("forge_clients")
    .select("*")
    .order("created_at",{ascending:false});

  if(!error && data){
    state.clients = data;
    renderClients();
  }
}

async function loadTasks(){
  const { data, error } = await supabase
    .from("forge_tasks")
    .select("*, forge_clients(full_name)")
    .order("created_at",{ascending:false});

  if(!error && data){
    state.tasks = data;
    renderTasks();
  }
}

async function loadMessages(){
  const { data, error } = await supabase
    .from("forge_messages")
    .select("*, forge_clients(full_name)")
    .order("created_at",{ascending:false})
    .limit(6);

  if(!error && data){
    state.messages = data;
    renderMessages();
  }
}

/* ------------------ RENDER ------------------ */
function updateStats(){
  animateNumber("statClients", state.clients.length);
  animateNumber("statTasks", state.tasks.length);
  animateNumber("statMessages", state.messages.length);

  const openTasks = state.tasks.filter(t => t.task_status !== "DONE").length;
  document.getElementById("threatLevel").innerText =
    openTasks > 5 ? "MEDIUM" : "LOW";
}

function renderClients(){
  const box = document.getElementById("clientTable");
  box.innerHTML = state.clients.map(c=>`
    <tr>
      <td>${c.full_name}</td>
      <td>@${c.social_handle || "—"}</td>
      <td><span class="pill">${c.plan}</span></td>
      <td><span class="status ${c.status?.toLowerCase()}">${c.status}</span></td>
    </tr>
  `).join("");
}

function renderTasks(){
  const columns = {
    TODO: document.getElementById("todoCol"),
    PROGRESS: document.getElementById("progressCol"),
    DONE: document.getElementById("doneCol")
  };

  Object.values(columns).forEach(col => col.innerHTML = "");

  state.tasks.forEach(t=>{
    const card = `
      <div class="taskCard">
        <b>${t.title}</b>
        <small>${t.forge_clients?.full_name || ""}</small>
      </div>
    `;
    if(columns[t.task_status]){
      columns[t.task_status].innerHTML += card;
    }
  });
}

function renderMessages(){
  const box = document.getElementById("messagesBox");
  box.innerHTML = state.messages.map(m=>`
    <div class="msg">
      <b>${m.forge_clients?.full_name}</b>
      <p>${m.message}</p>
    </div>
  `).join("");
}

/* ------------------ UI UTILITIES ------------------ */
function animateNumber(id, target){
  let el = document.getElementById(id);
  let current = 0;
  const step = Math.ceil(target / 20);

  const interval = setInterval(()=>{
    current += step;
    if(current >= target){
      current = target;
      clearInterval(interval);
    }
    el.innerText = current;
  },30);
}

function startClock(){
  setInterval(()=>{
    document.getElementById("clock").innerText =
      new Date().toLocaleTimeString();
  },1000);
}

init();
</script>

<style>
:root{
  --green:#6cff9f;
  --bg1:#050b07;
  --bg2:#020403;
}

body{
  margin:0;
  font-family:Inter,system-ui;
  background:radial-gradient(circle at top,var(--bg1),var(--bg2));
  color:white;
}

/* LAYOUT */
.layout{
  display:grid;
  grid-template-columns:240px 1fr;
  min-height:100vh;
}

/* SIDEBAR */
.sidebar{
  background:#0a140f;
  padding:25px;
  border-right:1px solid rgba(255,255,255,0.05);
}

.logo{
  font-weight:900;
  color:var(--green);
  font-size:20px;
  margin-bottom:40px;
}

.nav a{
  display:block;
  padding:12px;
  border-radius:10px;
  text-decoration:none;
  color:rgba(255,255,255,0.6);
  margin-bottom:10px;
  transition:.2s;
}

.nav a:hover{
  background:rgba(108,255,159,0.1);
  color:var(--green);
}

/* MAIN */
.main{
  padding:30px;
}

/* TOP BAR */
.topbar{
  display:flex;
  justify-content:space-between;
  margin-bottom:25px;
}

.statusLive{
  display:flex;
  gap:10px;
  align-items:center;
}

.dot{
  width:8px;
  height:8px;
  background:var(--green);
  border-radius:50%;
  box-shadow:0 0 8px var(--green);
}

.clock{
  color:var(--green);
  font-weight:700;
}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:18px;
  margin-bottom:25px;
}

.card{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  padding:20px;
  border-radius:18px;
  backdrop-filter:blur(10px);
}

.card h2{
  margin:0;
  font-size:28px;
  color:var(--green);
}

.card p{
  margin:5px 0 0;
  opacity:.6;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
}

.panel{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.06);
  padding:20px;
  border-radius:20px;
}

.panel h3{
  font-size:13px;
  text-transform:uppercase;
  opacity:.6;
  margin-bottom:15px;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
}

td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,0.05);
  font-size:14px;
}

.pill{
  background:rgba(108,255,159,0.1);
  padding:5px 10px;
  border-radius:999px;
  font-size:12px;
  color:var(--green);
}

/* TASK BOARD */
.board{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}

.taskCol{
  background:rgba(255,255,255,0.02);
  padding:10px;
  border-radius:12px;
}

.taskCard{
  background:rgba(108,255,159,0.08);
  border:1px solid rgba(108,255,159,0.2);
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
  transition:.2s;
}

.taskCard:hover{
  transform:translateY(-3px);
}

/* MESSAGES */
.msg{
  background:rgba(255,255,255,0.03);
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  border:1px solid rgba(255,255,255,0.05);
}

.msg b{
  color:var(--green);
  font-size:13px;
}

.msg p{
  margin:5px 0 0;
  opacity:.7;
  font-size:13px;
}

/* RESPONSIVE */
@media(max-width:1000px){
  .layout{
    grid-template-columns:1fr;
  }
  .sidebar{
    display:none;
  }
  .grid{
    grid-template-columns:1fr;
  }
}
</style>
</head>

<body>

<div class="layout">

<aside class="sidebar">
  <div class="logo">Forge AI</div>
  <div class="nav">
    <a href="#">Dashboard</a>
    <a href="#">Clients</a>
    <a href="#">Tasks</a>
    <a href="#">Messages</a>
  </div>
</aside>

<main class="main">

  <div class="topbar">
    <div class="statusLive">
      <div class="dot"></div>
      <span>AI Core Active</span>
    </div>
    <div class="clock" id="clock"></div>
  </div>

  <div class="stats">
    <div class="card">
      <h2 id="statClients">0</h2>
      <p>Active Clients</p>
    </div>
    <div class="card">
      <h2 id="statTasks">0</h2>
      <p>Total Tasks</p>
    </div>
    <div class="card">
      <h2 id="statMessages">0</h2>
      <p>New Messages</p>
    </div>
    <div class="card">
      <h2 id="threatLevel">LOW</h2>
      <p>Threat Level</p>
    </div>
  </div>

  <div class="grid">

    <div class="panel">
      <h3>Client Pipeline</h3>
      <table>
        <tbody id="clientTable"></tbody>
      </table>

      <h3 style="margin-top:25px;">Task Tracker</h3>
      <div class="board">
        <div class="taskCol"><h4>TODO</h4><div id="todoCol"></div></div>
        <div class="taskCol"><h4>IN PROGRESS</h4><div id="progressCol"></div></div>
        <div class="taskCol"><h4>DONE</h4><div id="doneCol"></div></div>
      </div>
    </div>

    <div class="panel">
      <h3>Recent Messages</h3>
      <div id="messagesBox"></div>
    </div>

  </div>

</main>
</div>

</body>
</html>