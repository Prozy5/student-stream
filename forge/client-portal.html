<!DOCTYPE html>
<html>
<head>
  <title>Forge Dashboard</title>
</head>
<body style="background:#050806;color:white;font-family:system-ui;padding:40px;">

<h1>Client Dashboard</h1>

<div id="profile"></div>

<hr>

<h2>Your Tasks</h2>
<ul id="tasks"></ul>

<hr>

<h2>Upload Vault</h2>
<input type="file" id="file">
<button onclick="upload()">Upload</button>
<p id="uploadStatus"></p>

<hr>

<h2>Message Forge</h2>
<input id="msg" placeholder="Send a message">
<button onclick="sendMsg()">Send</button>

<ul id="messages"></ul>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

const user = (await supabase.auth.getUser()).data.user;

if(!user){
  location.href="forge-portal-login.html";
}

async function loadDashboard(){

  // Profile
  const { data: profile } = await supabase
    .from("forge_clients")
    .select("*")
    .eq("id", user.id)
    .single();

  document.getElementById("profile").innerHTML =
    `<h3>${profile.full_name}</h3>
     Plan: ${profile.plan} <br>
     Active: ${profile.subscription_active}`;

  // Tasks
  const { data: tasks } = await supabase
    .from("forge_tasks")
    .select("*");

  document.getElementById("tasks").innerHTML =
    tasks.map(t=>`<li>${t.title} (${t.status})</li>`).join("");

  // Messages
  const { data: msgs } = await supabase
    .from("forge_messages")
    .select("*")
    .order("created_at");

  document.getElementById("messages").innerHTML =
    msgs.map(m=>`<li><b>${m.sender}:</b> ${m.message}</li>`).join("");
}

loadDashboard();

window.sendMsg = async function(){
  const message = document.getElementById("msg").value;

  await supabase.from("forge_messages").insert([{
    client_id:user.id,
    sender:"client",
    message
  }]);

  location.reload();
};

window.upload = async function(){
  const file = document.getElementById("file").files[0];

  const { error } = await supabase.storage
    .from("forge-vault")
    .upload(`${user.id}/${file.name}`, file);

  document.getElementById("uploadStatus").innerText =
    error ? "❌ Upload failed" : "✅ Uploaded!";
};
</script>

</body>
</html>