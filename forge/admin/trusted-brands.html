<!DOCTYPE html>
<html>
<head>
  <title>Trusted Brands Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #0f1115;
      font-family: Inter, sans-serif;
      color: white;
    }

    .container {
      width: 95%;
      max-width: 1200px;
      margin: 40px auto;
    }

    h1 {
      color: #3CF58A;
      font-size: 34px;
      margin-bottom: 5px;
    }

    .sub {
      color: #9aa3af;
      margin-bottom: 30px;
    }

    .panel {
      background: #161a22;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #2a2f3a;
      margin-bottom: 40px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background: #0f1115;
      border: 1px solid #2a2f3a;
      color: white;
      border-radius: 6px;
    }

    button {
      padding: 8px 14px;
      background: #3CF58A;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 5px;
    }

    .brands-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .brand-item {
      background: #161a22;
      border: 1px solid #2a2f3a;
      padding: 15px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
    }

    .brand-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .brand-left img {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }

    .status-badge {
      background: #3CF58A;
      color: black;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 10px;
    }

    .danger {
      background: #ff4d4d;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #161a22;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
    }
  </style>
</head>
<body>

<div class="container">

  <h1>Trusted Brands</h1>
  <div class="sub">Enterprise Brand Registry â€“ StudentStream Network</div>

  <!-- Add Brand -->
  <div class="panel">
    <h3>Add Brand</h3>
    <input type="text" id="name" placeholder="Brand Name">
    <input type="url" id="website" placeholder="Website URL">
    <input type="file" id="logo">
    <button onclick="addBrand()">Upload & Add</button>
  </div>

  <!-- Brand List -->
  <div class="brands-list" id="brandsList"></div>

</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>Edit Brand</h3>
    <input type="text" id="editName">
    <input type="url" id="editWebsite">
    <select id="editStatus">
      <option>Active</option>
      <option>Pending</option>
      <option>Suspended</option>
    </select>
    <button onclick="saveEdit()">Save</button>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

let currentEditId = null;

async function loadBrands() {
  const { data } = await supabase
    .from("trusted_brands")
    .select("*")
    .order("sort_order", { ascending: true });

  const list = document.getElementById("brandsList");
  list.innerHTML = "";

  data.forEach(brand => {
    const item = document.createElement("div");
    item.className = "brand-item";
    item.dataset.id = brand.id;

    item.innerHTML = `
      <div class="brand-left">
        <img src="${brand.logo_url}">
        <div>
          <strong>${brand.name}</strong>
          <span class="status-badge">${brand.status}</span>
        </div>
      </div>
      <div>
        <button onclick="editBrand('${brand.id}','${brand.name}','${brand.website_url}','${brand.status}')">Edit</button>
        <button class="danger" onclick="deleteBrand('${brand.id}')">Delete</button>
      </div>
    `;

    list.appendChild(item);
  });

  new Sortable(list, {
    animation: 150,
    onEnd: async function () {
      const items = list.querySelectorAll(".brand-item");
      for (let i = 0; i < items.length; i++) {
        await supabase
          .from("trusted_brands")
          .update({ sort_order: i + 1 })
          .eq("id", items[i].dataset.id);
      }
    }
  });
}

async function addBrand() {
  const name = document.getElementById("name").value;
  const website = document.getElementById("website").value;
  const file = document.getElementById("logo").files[0];

  const filePath = `${Date.now()}-${file.name}`;

  await supabase.storage
    .from("brand-logos")
    .upload(filePath, file);

  const { data } = supabase.storage
    .from("brand-logos")
    .getPublicUrl(filePath);

  await supabase.from("trusted_brands").insert([{
    name: name,
    website_url: website,
    logo_url: data.publicUrl,
    sort_order: 999,
    is_active: true,
    status: "Active"
  }]);

  loadBrands();
}

function editBrand(id, name, website, status) {
  currentEditId = id;
  document.getElementById("editName").value = name;
  document.getElementById("editWebsite").value = website;
  document.getElementById("editStatus").value = status;
  document.getElementById("editModal").style.display = "flex";
}

async function saveEdit() {
  const name = document.getElementById("editName").value;
  const website = document.getElementById("editWebsite").value;
  const status = document.getElementById("editStatus").value;

  await supabase.from("trusted_brands")
    .update({ name, website_url: website, status })
    .eq("id", currentEditId);

  document.getElementById("editModal").style.display = "none";
  loadBrands();
}

async function deleteBrand(id) {
  if (!confirm("Delete this brand?")) return;
  await supabase.from("trusted_brands").delete().eq("id", id);
  loadBrands();
}

loadBrands();
</script>

</body>
</html>