<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Forge Global Intelligence Command</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body{margin:0;background:#020f1f;font-family:Arial;color:white}
h2{padding:15px;margin:0}
#map{height:45vh}

.section{padding:15px}
.dashboard{display:grid;grid-template-columns:repeat(4,1fr);gap:15px}
.card{
background:linear-gradient(145deg,#071c36,#0d2c55);
padding:20px;border-radius:12px;
box-shadow:0 0 20px rgba(0,212,255,.15);
}
.list-box{
background:#06182f;padding:15px;border-radius:10px;
max-height:250px;overflow:auto;margin-bottom:15px
}
input,button{
padding:6px;margin:4px 0;border-radius:6px;border:none
}
button{cursor:pointer;background:#00d4ff;color:black;font-weight:bold}
button:hover{opacity:.8}

.pulse{width:14px;height:14px;border-radius:50%;position:relative}
.pulse::after{
content:'';position:absolute;width:100%;height:100%;
border-radius:50%;animation:pulse 2s infinite;opacity:.6
}
@keyframes pulse{
0%{transform:scale(1);opacity:.6}
100%{transform:scale(3);opacity:0}
}
.green{background:#00ff88}
.green::after{background:#00ff88}
.yellow{background:#ffd000}
.yellow::after{background:#ffd000}
.red{background:#ff3b3b}
.red::after{background:#ff3b3b}

.alert{padding:8px;margin-bottom:6px;border-radius:6px;font-size:13px}
.low{background:#063}
.medium{background:#664400}
.high{background:#660000}
</style>
</head>

<body>

<h2>Forge Global Intelligence Command</h2>
<div id="map"></div>

<div class="section">
<div class="dashboard">
<div class="card"><h3>Active MRR</h3><h1 id="mrr">$0</h1></div>
<div class="card"><h3>Revenue at Risk</h3><h1 id="risk">$0</h1></div>
<div class="card"><h3>Churn Rate</h3><h1 id="churn">0%</h1></div>
<div class="card"><h3>Fusion Score</h3><h1 id="fusion">0</h1></div>
</div>
</div>

<div class="section" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px">

<div class="list-box">
<h3>Clients</h3>
<input id="newClientName" placeholder="Company name">
<button onclick="addClient()">Add Client</button>
<div id="clientList"></div>
</div>

<div class="list-box">
<h3>Tasks</h3>
<input id="newTaskTitle" placeholder="Task title">
<button onclick="addTask()">Create Task</button>
<div id="taskList"></div>
</div>

<div class="list-box">
<h3>Security Monitoring</h3>
<button onclick="injectEvent()">Inject Critical Event</button>
<div id="securityFeed"></div>
</div>

</div>

<div class="section">
<div class="list-box">
<h3>Incidents</h3>
<div id="incidentPanel"></div>
</div>
</div>

<script>
const SUPABASE_URL="https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const map=L.map('map',{zoomControl:false}).setView([20,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let clusterGroup=L.markerClusterGroup();
map.addLayer(clusterGroup);
let heatLayer;

async function loadIntel(){

clusterGroup.clearLayers();
if(heatLayer)map.removeLayer(heatLayer);

const {data:clients}=await sb.from("clients").select("*");
const {data:tasks}=await sb.from("tasks").select("*");
const {data:events}=await sb.from("security_events").select("*").order("created_at",{ascending:false}).limit(10);
const {data:incidents}=await sb.from("incidents").select("*").order("created_at",{ascending:false});

let totalMRR=0,riskMRR=0,churned=0,active=0,heatData=[];
let clientHTML="",taskHTML="",securityHTML="",incidentHTML="";

clients?.forEach(c=>{
let revenue=c.monthly_revenue||0;
let riskScore=c.churn_risk||0;
let status=c.status||"active";

if(status==="active"){active++;totalMRR+=revenue;if(riskScore>0.6)riskMRR+=revenue}
if(status==="churned")churned++;

let riskClass=riskScore>0.6?"red":riskScore>0.4?"yellow":"green";

clientHTML+=`
<div>
<b>${c.company_name}</b> — $${revenue}
<button onclick="deleteClient('${c.id}')">❌</button>
</div>`;

if(c.latitude&&c.longitude){
heatData.push([c.latitude,c.longitude,revenue/10000]);
clusterGroup.addLayer(
L.marker([c.latitude,c.longitude],{
icon:L.divIcon({
html:`<div class="pulse ${riskClass}"></div>`,
iconSize:[20,20]
})
}).bindPopup(`<b>${c.company_name}</b><br>$${revenue}`)
);
}
});

tasks?.forEach(t=>{
taskHTML+=`
<div class="alert medium">
${t.title} (${t.status})
<button onclick="completeTask('${t.id}')">✔</button>
</div>`;
});

events?.forEach(e=>{
securityHTML+=`
<div class="alert ${e.severity}">
${e.event_type} - ${e.severity}
</div>`;
});

incidents?.forEach(i=>{
incidentHTML+=`
<div class="alert ${i.severity}">
${i.title} (${i.status})
<button onclick="resolveIncident('${i.id}')">Resolve</button>
</div>`;
});

heatLayer=L.heatLayer(heatData,{radius:30,blur:25,maxZoom:5}).addTo(map);

let churnRate=active>0?((churned/(active+churned))*100).toFixed(1):0;
let fusionScore=Math.round((totalMRR/1000)-(riskMRR/2000)-churnRate);

document.getElementById("mrr").innerText="$"+totalMRR.toLocaleString();
document.getElementById("risk").innerText="$"+riskMRR.toLocaleString();
document.getElementById("churn").innerText=churnRate+"%";
document.getElementById("fusion").innerText=fusionScore;
document.getElementById("clientList").innerHTML=clientHTML;
document.getElementById("taskList").innerHTML=taskHTML;
document.getElementById("securityFeed").innerHTML=securityHTML;
document.getElementById("incidentPanel").innerHTML=incidentHTML;
}

async function addClient(){
const name=document.getElementById("newClientName").value;
if(!name)return;
await sb.from("clients").insert({company_name:name});
document.getElementById("newClientName").value="";
loadIntel();
}

async function deleteClient(id){
await sb.from("clients").delete().eq("id",id);
loadIntel();
}

async function addTask(){
const title=document.getElementById("newTaskTitle").value;
if(!title)return;
await sb.from("tasks").insert({title});
document.getElementById("newTaskTitle").value="";
loadIntel();
}

async function completeTask(id){
await sb.from("tasks").update({status:"completed"}).eq("id",id);
loadIntel();
}

async function injectEvent(){
await sb.from("security_events").insert({
event_type:"Manual Critical Threat",
severity:"critical"
});
loadIntel();
}

async function resolveIncident(id){
await sb.from("incidents").update({status:"resolved"}).eq("id",id);
loadIntel();
}

sb.channel('live-all')
.on('postgres_changes',{event:'*',schema:'public',table:'clients'},loadIntel)
.on('postgres_changes',{event:'*',schema:'public',table:'tasks'},loadIntel)
.on('postgres_changes',{event:'*',schema:'public',table:'security_events'},loadIntel)
.on('postgres_changes',{event:'*',schema:'public',table:'incidents'},loadIntel)
.subscribe();

loadIntel();
</script>

</body>
</html>