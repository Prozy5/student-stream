<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Forge Global Intelligence Command</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Heatmap + Clustering -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body {
  margin:0;
  background:#020f1f;
  font-family:Arial;
  color:white;
}

#map {
  height:60vh;
  border-radius:12px;
}

.dashboard {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
  padding:15px;
}

.card {
  background:linear-gradient(145deg,#071c36,#0d2c55);
  padding:20px;
  border-radius:12px;
  box-shadow:0 0 20px rgba(0,212,255,.15);
}

.pulse {
  width:12px;
  height:12px;
  background:#00d4ff;
  border-radius:50%;
  position:relative;
}

.pulse::after{
  content:'';
  position:absolute;
  width:100%;
  height:100%;
  border-radius:50%;
  background:#00d4ff;
  animation:pulse 2s infinite;
  opacity:.6;
}

@keyframes pulse{
  0%{ transform:scale(1); opacity:.6; }
  100%{ transform:scale(3); opacity:0; }
}
</style>
</head>

<body>

<h2 style="padding:15px;">Forge Global Intelligence Command</h2>
<div id="map"></div>

<div class="dashboard">
  <div class="card">
    <h3>Active MRR</h3>
    <h1 id="mrr">$0</h1>
  </div>

  <div class="card">
    <h3>Revenue at Risk</h3>
    <h1 id="risk">$0</h1>
  </div>

  <div class="card">
    <h3>Churn Rate</h3>
    <h1 id="churn">0%</h1>
  </div>

  <div class="card">
    <h3>Fusion Score</h3>
    <h1 id="fusion">0</h1>
  </div>
</div>

<script>

/* ================= SUPABASE CONFIG ================= */
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= MAP INIT ================= */
const map = L.map('map',{zoomControl:false}).setView([20,0],2);

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
).addTo(map);

let clusterGroup = L.markerClusterGroup();
map.addLayer(clusterGroup);
let heatLayer;

/* ================= LOAD DATA ================= */
async function loadIntel(){

  clusterGroup.clearLayers();
  if(heatLayer) map.removeLayer(heatLayer);

  const { data: clients } = await sb
    .from("clients")
    .select("*");

  if(!clients) return;

  let totalMRR = 0;
  let riskMRR = 0;
  let churned = 0;
  let active = 0;
  let heatData = [];

  const headquarters = [29.9511,-90.0715]; // CHANGE TO YOUR HQ

  clients.forEach(client=>{

    const revenue = client.monthly_revenue || 0;
    const riskScore = client.churn_risk || 0;
    const status = client.status || "active";

    if(status === "active"){
      active++;
      totalMRR += revenue;
      if(riskScore > 0.6) riskMRR += revenue;
    }

    if(status === "churned") churned++;

    if(client.latitude && client.longitude){

      heatData.push([
        client.latitude,
        client.longitude,
        revenue / 10000
      ]);

      const icon = L.divIcon({
        className:'pulse-marker',
        html:`<div class="pulse"></div>`,
        iconSize:[20,20]
      });

      const marker = L.marker(
        [client.latitude,client.longitude],
        {icon}
      ).bindPopup(`
        <b>${client.company_name}</b><br>
        Revenue: $${revenue}<br>
        Risk: ${(riskScore*100).toFixed(0)}%
      `);

      clusterGroup.addLayer(marker);

      L.polyline(
        [headquarters,[client.latitude,client.longitude]],
        {
          color:"#00d4ff",
          weight:1,
          opacity:0.3,
          dashArray:"4 6"
        }
      ).addTo(map);
    }
  });

  heatLayer = L.heatLayer(heatData,{
    radius:30,
    blur:25,
    maxZoom:5
  }).addTo(map);

  const churnRate = active > 0
    ? ((churned / (active+churned)) * 100).toFixed(1)
    : 0;

  const fusionScore = Math.round(
    (totalMRR/1000) - (riskMRR/2000) - churnRate
  );

  document.getElementById("mrr").innerText =
    "$" + totalMRR.toLocaleString();

  document.getElementById("risk").innerText =
    "$" + riskMRR.toLocaleString();

  document.getElementById("churn").innerText =
    churnRate + "%";

  document.getElementById("fusion").innerText =
    fusionScore;
}

/* ================= REALTIME SYNC ================= */
sb.channel('live-clients')
  .on('postgres_changes',
    {event:'*', schema:'public', table:'clients'},
    ()=> loadIntel()
  )
  .subscribe();

/* ================= START ================= */
loadIntel();

</script>

</body>
</html>