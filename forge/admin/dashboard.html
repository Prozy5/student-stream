<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Forge Global Intelligence Command - Enterprise</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body{
margin:0;
background:radial-gradient(circle at top,#041a33,#020b17);
font-family:Arial;
color:white;
}

header{
padding:20px;
font-size:22px;
font-weight:bold;
background:linear-gradient(90deg,#071c36,#0b2b52);
display:flex;
justify-content:space-between;
}

#map{height:45vh;}

.section{padding:20px}

.panel{
background:#06182f;
padding:20px;
border-radius:14px;
margin-bottom:20px;
box-shadow:0 0 20px rgba(0,212,255,.08);
}

.advisory-panel{
margin-top:15px;
padding:18px;
border-radius:12px;
background:rgba(255,255,255,.05);
backdrop-filter:blur(18px);
border:1px solid rgba(255,255,255,.08);
line-height:1.6;
}

.hidden{display:none;}

input{
width:100%;
padding:8px;
margin-bottom:8px;
border-radius:6px;
border:none;
background:#0c2b4f;
color:white;
}

button{
width:100%;
padding:8px;
border:none;
border-radius:6px;
background:#00d4ff;
color:black;
font-weight:bold;
cursor:pointer;
}
</style>
</head>

<body>

<header>
Forge Global Intelligence Command — Enterprise
<div>● LIVE</div>
</header>

<div id="map"></div>

<div class="section">

<div class="panel">
<h3>AI SECURITY ENGINE (Admin Only)</h3>

<input type="password" id="groqKeyInput" placeholder="Enter Groq API Key (Session Only)">
<button onclick="setGroqKey()">Activate AI</button>

<div id="aiSummary" style="margin-top:15px;"></div>
<div id="advisoryPanel" class="advisory-panel hidden"></div>
</div>

</div>

<script>
const SUPABASE_URL="https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let GROQ_API_KEY="";

function setGroqKey(){
GROQ_API_KEY=document.getElementById("groqKeyInput").value.trim();
if(GROQ_API_KEY){
alert("AI Activated For This Session");
}else{
alert("Invalid Key");
}
}

const map=L.map('map',{zoomControl:false}).setView([20,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

function calculateAIScore(events,incidents){
let score=0;
events.forEach(e=>{
if(e.severity==="critical") score+=40;
if(e.severity==="high") score+=20;
if(e.severity==="medium") score+=10;
});
incidents.forEach(i=>{
if(i.severity==="critical") score+=30;
if(i.severity==="high") score+=15;
});
return score;
}

function getVolatility(score){
if(score>80) return "High";
if(score>40) return "Moderate";
return "Low";
}

async function runStrategicAI(score,volatility,events,incidents){

if(!GROQ_API_KEY){
document.getElementById("advisoryPanel").classList.add("hidden");
return;
}

if(volatility==="Low"){
document.getElementById("advisoryPanel").classList.add("hidden");
return;
}

const systemPrompt=`
You are a senior security strategy advisor briefing executive leadership.
Maintain calm analytical tone.
No exaggeration.
Structured output.
`;

const userPrompt=`
Threat Score: ${score}
Volatility: ${volatility}
Critical Events: ${events.filter(e=>e.severity==="critical").length}
High Events: ${events.filter(e=>e.severity==="high").length}
Open Incidents: ${incidents.length}

Provide:
1. Executive Overview
2. Stability Assessment
3. Key Risk Drivers
${volatility==="High" ? `
4. Immediate Containment Actions
5. Strategic Monitoring Recommendation
6. Risk Mitigation Priorities
` : `
4. Strategic Monitoring Recommendation
`}
`;

try{
const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":`Bearer ${GROQ_API_KEY}`
},
body:JSON.stringify({
model:"llama3-70b-8192",
messages:[
{role:"system",content:systemPrompt},
{role:"user",content:userPrompt}
],
temperature:0.4
})
});

const data=await res.json();
if(!data.choices){return;}

const text=data.choices[0].message.content;

const formatted=text.split(/\n\d+\.\s/).filter(Boolean)
.map(section=>`<p>${section.trim()}</p>`).join("");

document.getElementById("advisoryPanel").innerHTML=formatted;
document.getElementById("advisoryPanel").classList.remove("hidden");

}catch(err){
console.log("AI Error",err);
}
}

async function loadIntel(){
const {data:events}=await sb.from("security_events").select("*");
const {data:incidents}=await sb.from("incidents").select("*");

let aiScore=calculateAIScore(events||[],incidents||[]);
let volatility=getVolatility(aiScore);

document.getElementById("aiSummary").innerHTML=
`Threat Score: ${aiScore} | Volatility: ${volatility}`;

runStrategicAI(aiScore,volatility,events||[],incidents||[]);
}

loadIntel();
</script>

</body>
</html>