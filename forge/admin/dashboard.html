<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forge AI – Command Center</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJIUzI1NiIsInR5cCI6IkpXVCJ9"
);

/* ---------------- STATE ---------------- */
let state = {
  clients: [],
  tasks: [],
  messages: []
};

let securityState = {
  riskScore: 0,
  anomalies: 0,
  events: [],
  locked: false
};

/* ---------------- INIT ---------------- */
async function init(){
  await loadAll();
  startClock();
  setInterval(loadAll, 20000);
  setInterval(runSecurityScan,15000);
  enableRealtime();
  setupTabs();
}

/* ---------------- TAB SYSTEM ---------------- */
function setupTabs(){

  const links = document.querySelectorAll(".nav a");

  const pages = {
    dashboard: document.getElementById("dashboardPage"),
    clients: document.getElementById("clientsPage"),
    tasks: document.getElementById("tasksPage"),
    security: document.getElementById("securityPage")
  };

  function switchTab(tab){

    Object.values(pages).forEach(page=>{
      if(page) page.style.display="none";
    });

    links.forEach(l=>l.classList.remove("activeTab"));

    if(pages[tab]){
      pages[tab].style.display="block";
    }

    const active = document.querySelector(`.nav a[data-tab="${tab}"]`);
    if(active) active.classList.add("activeTab");
  }

  links.forEach(link=>{
    link.addEventListener("click",(e)=>{
      e.preventDefault();
      switchTab(link.dataset.tab);
    });
  });

}

/* ---------------- REALTIME ---------------- */
function enableRealtime(){
  supabase.channel("forge-live")
    .on("postgres_changes",{event:"*",schema:"public"},()=>{
      loadAll();
    })
    .subscribe();
}

async function loadAll(){
  await Promise.all([
    loadClients(),
    loadTasks(),
    loadMessages()
  ]);
  updateStats();
  renderActivity();
  updateAdvancedMetrics();
}

/* ---------------- LOADERS ---------------- */
async function loadClients(){
  const { data } = await supabase
    .from("forge_clients")
    .select("*")
    .order("created_at",{ascending:false});
  state.clients = data || [];
  renderClients();
}

async function loadTasks(){
  const { data } = await supabase
    .from("forge_tasks")
    .select("*, forge_clients(full_name)")
    .order("created_at",{ascending:false});
  state.tasks = data || [];
  renderTasks();
}

async function loadMessages(){
  const { data } = await supabase
    .from("forge_messages")
    .select("*, forge_clients(full_name)")
    .order("created_at",{ascending:false})
    .limit(6);
  state.messages = data || [];
  renderMessages();
}

/* ---------------- STATS ---------------- */
function updateStats(){
  animate("statClients", state.clients.length);
  animate("statTasks", state.tasks.length);
  animate("statMessages", state.messages.length);

  const open = state.tasks.filter(t=>t.task_status!=="DONE").length;
  const threat = document.getElementById("threatLevel");

  if(open > 10){
    threat.innerText="CRITICAL";
    threat.className="danger";
  } else if(open > 6){
    threat.innerText="HIGH";
    threat.className="danger";
  } else if(open > 3){
    threat.innerText="MEDIUM";
    threat.className="warning";
  } else {
    threat.innerText="LOW";
    threat.className="safe";
  }

  const revenue = state.clients.length * 99;
  animate("statRevenue", revenue);
}

/* ---------------- ADVANCED METRICS ---------------- */
function updateAdvancedMetrics(){
  const total = state.clients.length;
  const active = state.clients.filter(c=>c.status==="ACTIVE").length;

  const mrr = active * 99;
  const churn = total === 0 ? 0 :
    Math.round(((total - active) / total) * 100);

  const openTasks = state.tasks.filter(t=>t.task_status!=="DONE").length;
  const health = Math.max(0, 100 - churn - (openTasks * 2));

  animate("statMRR", mrr);
  animate("statChurn", churn);
  animate("statHealth", health);
}

/* ---------------- SECURITY ENGINE ---------------- */
function runSecurityScan(){

  let risk = 0;
  let anomalies = 0;

  const openTasks = state.tasks.filter(t=>t.task_status!=="DONE").length;
  if(openTasks > 12){
    risk += 30;
    anomalies++;
    logSecurity("High open task volume detected");
  }

  if(Math.random() > 0.92){
    risk += 25;
    anomalies++;
    logSecurity("AI anomaly detected");
  }

  securityState.riskScore = Math.min(100, risk);
  securityState.anomalies = anomalies;

  updateSecurityUI();
}

function logSecurity(text){
  securityState.events.unshift({
    message:text,
    time:new Date().toLocaleTimeString()
  });

  if(securityState.events.length > 10){
    securityState.events.pop();
  }
}

function updateSecurityUI(){
  animate("riskScore", securityState.riskScore);
  animate("anomalyCount", securityState.anomalies);

  document.getElementById("securityFeed").innerHTML =
    securityState.events.map(e=>`
      <div class="securityItem">
        <b>${e.time}</b> — ${e.message}
      </div>
    `).join("");
}

/* ---------------- RENDER ---------------- */
function renderClients(){
  document.getElementById("clientTable").innerHTML =
    state.clients.map(c=>`
      <tr>
        <td>${c.full_name}</td>
        <td>@${c.social_handle || "—"}</td>
        <td><span class="pill">${c.plan}</span></td>
        <td>${c.status}</td>
      </tr>
    `).join("");
}

function renderTasks(){
  const cols={
    TODO:document.getElementById("todo"),
    PROGRESS:document.getElementById("progress"),
    DONE:document.getElementById("done")
  };
  Object.values(cols).forEach(c=>c.innerHTML="");

  state.tasks.forEach(t=>{
    const card=`
      <div class="taskCard">
        <b>${t.title}</b>
      </div>`;
    if(cols[t.task_status]) cols[t.task_status].innerHTML+=card;
  });
}

function renderMessages(){
  document.getElementById("messages").innerHTML=
    state.messages.map(m=>`
      <div class="msg">
        <b>${m.forge_clients?.full_name}</b>
        <p>${m.message}</p>
      </div>
    `).join("");
}

function renderActivity(){
  const feed=document.getElementById("activity");
  const recent=[
    ...state.tasks.slice(0,3).map(t=>`Task created: ${t.title}`)
  ];
  feed.innerHTML=recent.map(i=>`<div class="activityItem">${i}</div>`).join("");
}

/* ---------------- UTIL ---------------- */
function animate(id,val){
  const el=document.getElementById(id);
  if(!el) return;
  el.innerText = val;
}

function startClock(){
  setInterval(()=>{
    document.getElementById("clock").innerText=
      new Date().toLocaleTimeString();
  },1000);
}

init();
</script>

<style>
:root{
--green:#6cff9f;
--bg1:#040a06;
--bg2:#010302;
--danger:#ff5e5e;
--warning:#ffb84d;
}

body{
margin:0;
font-family:Inter,system-ui;
background:radial-gradient(circle at top,var(--bg1),var(--bg2));
color:white;
overflow-x:hidden;
}

.layout{
display:grid;
grid-template-columns:250px 1fr;
min-height:100vh;
}

.sidebar{
background:#08120d;
padding:30px;
border-right:1px solid rgba(255,255,255,.05);
}

.logo{
color:var(--green);
font-weight:900;
margin-bottom:40px;
font-size:22px;
}

.nav a{
display:block;
color:rgba(255,255,255,.6);
text-decoration:none;
margin-bottom:15px;
padding:10px;
border-radius:8px;
transition:.2s;
}
.nav a:hover{
background:rgba(108,255,159,.1);
color:var(--green);
}

.activeTab{
background:rgba(108,255,159,.15);
color:var(--green)!important;
}

.main{padding:30px;}
</style>
</head>

<body>

<div class="layout">
<aside class="sidebar">
<div class="logo">Forge AI</div>
<div class="nav">
<a href="#" data-tab="dashboard" class="activeTab">Dashboard</a>
<a href="#" data-tab="clients">Clients</a>
<a href="#" data-tab="tasks">Tasks</a>
<a href="#" data-tab="security">Security</a>
</div>
</aside>

<main class="main">

<div id="dashboardPage">
<h2>Dashboard</h2>
</div>

<div id="clientsPage" style="display:none;">
<h2>Clients</h2>
</div>

<div id="tasksPage" style="display:none;">
<h2>Tasks</h2>
</div>

<div id="securityPage" style="display:none;">
<h2>Security</h2>
<div id="securityFeed"></div>
</div>

</main>
</div>

</body>
</html>