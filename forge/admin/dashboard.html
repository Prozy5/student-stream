<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Forge Global Intelligence Command</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body{
margin:0;
background:#030b18;
font-family:Arial;
color:white;
overflow-x:hidden;
}
header{
padding:18px;
font-size:22px;
font-weight:bold;
background:linear-gradient(90deg,#071c36,#0b2b52);
box-shadow:0 4px 25px rgba(0,0,0,.6);
display:flex;
justify-content:space-between;
align-items:center;
}
.status-dot{
width:10px;
height:10px;
background:#00ff88;
border-radius:50%;
box-shadow:0 0 10px #00ff88;
animation:pulseLive 2s infinite;
}
@keyframes pulseLive{
0%{opacity:1}
50%{opacity:.3}
100%{opacity:1}
}

#map{height:40vh;}

.section{padding:20px}

.dashboard{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:20px;
}

.card{
background:rgba(10,30,60,.6);
backdrop-filter:blur(8px);
padding:20px;
border-radius:14px;
box-shadow:0 0 25px rgba(0,212,255,.1);
}

.card h3{
margin:0;
font-size:12px;
opacity:.7;
letter-spacing:1px;
}
.card h1{
margin:5px 0 0 0;
font-size:24px;
}

.grid{
display:grid;
grid-template-columns:1fr 1fr 1fr;
gap:20px;
margin-top:25px;
}

.panel{
background:#06182f;
padding:15px;
border-radius:12px;
}

.panel h3{margin-top:0;font-size:14px}

.item{
padding:6px;
margin-bottom:6px;
border-radius:6px;
font-size:12px;
display:flex;
justify-content:space-between;
background:#0c2748;
}

.low{background:#063}
.medium{background:#664400}
.high{background:#660000}
.critical{
background:#990000;
animation:flash 1s infinite;
}
@keyframes flash{
0%{opacity:1}
50%{opacity:.6}
100%{opacity:1}
}

canvas{margin-top:20px}

button{
padding:6px 10px;
border:none;
border-radius:6px;
cursor:pointer;
background:#00d4ff;
font-weight:bold;
}

</style>
</head>
<body>

<header>
Forge Global Intelligence Command
<div class="status-dot"></div>
</header>

<div id="map"></div>

<div class="section">

<div class="dashboard">
<div class="card"><h3>ACTIVE MRR</h3><h1 id="mrr">$0</h1></div>
<div class="card"><h3>REVENUE AT RISK</h3><h1 id="risk">$0</h1></div>
<div class="card"><h3>CHURN RATE</h3><h1 id="churn">0%</h1></div>
<div class="card"><h3>FUSION SCORE</h3><h1 id="fusion">0</h1></div>
<div class="card"><h3>CRITICAL THREATS</h3><h1 id="criticalCount">0</h1></div>
</div>

<canvas id="revenueChart" height="80"></canvas>

<div class="grid">

<div class="panel">
<h3>CLIENTS</h3>
<div id="clientList"></div>
</div>

<div class="panel">
<h3>SECURITY FEED</h3>
<div id="securityFeed"></div>
<button onclick="injectEvent()">Inject Critical Threat</button>
</div>

<div class="panel">
<h3>INCIDENT CONTROL</h3>
<div id="incidentPanel"></div>
</div>

</div>

</div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">
</audio>

<script>
const SUPABASE_URL="https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const map=L.map('map',{zoomControl:false}).setView([20,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
let clusterGroup=L.markerClusterGroup();
map.addLayer(clusterGroup);
let heatLayer;

const chartCtx=document.getElementById('revenueChart').getContext('2d');
let revenueChart=new Chart(chartCtx,{
type:'line',
data:{labels:[],datasets:[{label:'MRR Trend',data:[],borderColor:'#00d4ff',fill:false}]},
options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}
});

function animateValue(id,end){
let obj=document.getElementById(id);
let start=parseInt(obj.innerText.replace(/[^0-9]/g,''))||0;
let range=end-start;
let current=start;
let increment=range/30;
let i=0;
let timer=setInterval(()=>{
current+=increment;
i++;
obj.innerText=id==="churn"?current.toFixed(1)+"%":"$"+Math.round(current).toLocaleString();
if(i>=30)clearInterval(timer);
},20);
}

async function loadIntel(){

clusterGroup.clearLayers();
if(heatLayer)map.removeLayer(heatLayer);

const {data:clients}=await sb.from("clients").select("*");
const {data:events}=await sb.from("security_events").select("*").order("created_at",{ascending:false}).limit(10);
const {data:incidents}=await sb.from("incidents").select("*");

let totalMRR=0,riskMRR=0,active=0,churned=0,critical=0;
let clientHTML="",securityHTML="",incidentHTML="";
let heatData=[];

clients?.forEach(c=>{
let revenue=c.monthly_revenue||0;
let risk=c.churn_risk||0;
if(c.status==="active"){active++;totalMRR+=revenue;if(risk>0.6)riskMRR+=revenue}
if(c.status==="churned")churned++;

clientHTML+=`<div class="item">${c.company_name} â€” $${revenue}</div>`;

if(c.latitude&&c.longitude){
heatData.push([c.latitude,c.longitude,revenue/10000]);
clusterGroup.addLayer(
L.circleMarker([c.latitude,c.longitude],{
radius:6,
color:risk>0.6?'red':risk>0.4?'yellow':'#00ff88'
})
);
}
});

events?.forEach(e=>{
if(e.severity==="critical"){critical++;document.getElementById("alertSound").play();}
securityHTML+=`<div class="item ${e.severity}">${e.event_type}</div>`;
});

incidents?.forEach(i=>{
incidentHTML+=`<div class="item ${i.severity}">${i.title} (${i.status})</div>`;
});

heatLayer=L.heatLayer(heatData,{radius:30,blur:20}).addTo(map);

let churnRate=active>0?((churned/(active+churned))*100):0;
let fusionScore=Math.round((totalMRR/1000)-(riskMRR/2000)-churnRate);

animateValue("mrr",totalMRR);
animateValue("risk",riskMRR);
document.getElementById("churn").innerText=churnRate.toFixed(1)+"%";
document.getElementById("fusion").innerText=fusionScore;
document.getElementById("criticalCount").innerText=critical;
document.getElementById("clientList").innerHTML=clientHTML;
document.getElementById("securityFeed").innerHTML=securityHTML;
document.getElementById("incidentPanel").innerHTML=incidentHTML;

revenueChart.data.labels.push("");
revenueChart.data.datasets[0].data.push(totalMRR);
if(revenueChart.data.labels.length>20){
revenueChart.data.labels.shift();
revenueChart.data.datasets[0].data.shift();
}
revenueChart.update();
}

async function injectEvent(){
await sb.from("security_events").insert({
event_type:"Manual Critical Threat",
severity:"critical"
});
}

sb.channel('live')
.on('postgres_changes',{event:'*',schema:'public',table:'clients'},loadIntel)
.on('postgres_changes',{event:'*',schema:'public',table:'security_events'},loadIntel)
.on('postgres_changes',{event:'*',schema:'public',table:'incidents'},loadIntel)
.subscribe();

loadIntel();
</script>

</body>
</html>