<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Forge Admin Command Center</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0e1117;
  color: white;
  display: flex;
}

.sidebar {
  width: 220px;
  background: #111827;
  height: 100vh;
  padding-top: 20px;
  position: fixed;
}

.sidebar a {
  display: block;
  padding: 15px;
  color: #9ca3af;
  text-decoration: none;
  transition: 0.2s;
}

.sidebar a:hover {
  background: #1f2937;
  color: white;
}

.main {
  margin-left: 220px;
  padding: 30px;
  width: 100%;
}

.card {
  background: #161b22;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 8px;
}

.metric {
  font-size: 28px;
  font-weight: bold;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #333;
}

.status-green { color: #22c55e; }
.status-red { color: #ef4444; }
.status-yellow { color: #f59e0b; }

.hidden { display: none; }
</style>
</head>
<body>

<div class="sidebar">
  <a href="#" onclick="showTab('dashboard')">Dashboard</a>
  <a href="#" onclick="showTab('clients')">Clients</a>
  <a href="#" onclick="showTab('security')">Security</a>
</div>

<div class="main">

  <!-- DASHBOARD -->
  <div id="dashboard" class="tab">
    <h1>Forge Command Center</h1>

    <div class="card">
      <div>Active MRR</div>
      <div id="mrr" class="metric">$0</div>
    </div>

    <div class="card">
      <div>Revenue At Risk</div>
      <div id="risk" class="metric">$0</div>
    </div>

    <div class="card">
      <div>Churn %</div>
      <div id="churn" class="metric">0%</div>
    </div>

    <div class="card">
      <div>Fusion Score</div>
      <div id="fusion" class="metric">0</div>
    </div>
  </div>

  <!-- CLIENTS -->
  <div id="clients" class="tab hidden">
    <h2>Subscription Health</h2>
    <table>
      <thead>
        <tr>
          <th>Client</th>
          <th>Amount</th>
          <th>Churn Risk</th>
          <th>Health Score</th>
        </tr>
      </thead>
      <tbody id="healthTable"></tbody>
    </table>
  </div>

  <!-- SECURITY -->
  <div id="security" class="tab hidden">
    <h2>Security Monitoring</h2>
    <div class="card">
      <div>Global Threat Index</div>
      <div id="gti" class="metric">0</div>
    </div>
  </div>

</div>

<script>
// ==========================
// ðŸ” SUPABASE CONFIG
// ==========================
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ==========================
// TAB SWITCHING
// ==========================
function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
  document.getElementById(tab).classList.remove('hidden');
}

// ==========================
// LOAD DASHBOARD METRICS
// ==========================
async function loadDashboard() {

  const { data: revenue } = await supabase
    .from("forge_admin_revenue_analytics")
    .select("*")
    .single();

  if (revenue) {
    document.getElementById("mrr").innerText =
      "$" + revenue.active_mrr;
  }

  const { data: risk } = await supabase
    .from("forge_revenue_at_risk")
    .select("*")
    .single();

  if (risk) {
    document.getElementById("risk").innerText =
      "$" + risk.revenue_at_risk;
  }

  const { data: churn } = await supabase
    .from("forge_churn_rate")
    .select("*")
    .single();

  if (churn) {
    document.getElementById("churn").innerText =
      churn.churn_percentage + "%";
  }

  const { data: fusion } = await supabase
    .from("forge_fusion_score")
    .select("*")
    .single();

  if (fusion) {
    document.getElementById("fusion").innerText =
      fusion.forge_fusion_score;
  }

  const { data: gti } = await supabase
    .from("forge_system_state")
    .select("global_threat_index")
    .eq("id", 1)
    .single();

  if (gti) {
    document.getElementById("gti").innerText =
      gti.global_threat_index;
  }
}

// ==========================
// LOAD CLIENT HEALTH TABLE
// ==========================
async function loadHealth() {
  const { data } = await supabase
    .from("forge_subscription_health")
    .select("*");

  const table = document.getElementById("healthTable");
  table.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${row.client_id}</td>
      <td>$${row.amount}</td>
      <td>${row.churn_risk_score}</td>
      <td>${row.subscription_health_score}</td>
    `;

    table.appendChild(tr);
  });
}

// ==========================
// REALTIME SUBSCRIPTIONS
// ==========================
supabase
  .channel("realtime-dashboard")
  .on(
    "postgres_changes",
    { event: "*", schema: "public" },
    () => {
      loadDashboard();
      loadHealth();
    }
  )
  .subscribe();

// Initial load
loadDashboard();
loadHealth();

</script>

</body>
</html>