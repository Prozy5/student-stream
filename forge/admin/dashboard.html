<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Forge Global Command Center</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#040d1f;
  font-family:Segoe UI, sans-serif;
  color:white;
}

.header{
  padding:25px 40px;
  font-size:20px;
  font-weight:500;
}

.dashboard{
  display:grid;
  grid-template-columns: 1.4fr 1fr;
  gap:25px;
  padding:0 40px 40px;
}

/* LEFT SIDE */
.left-panel{
  display:flex;
  flex-direction:column;
  gap:20px;
}

.map-box{
  background:linear-gradient(145deg,#08152e,#050e22);
  border-radius:20px;
  padding:20px;
  box-shadow:0 0 60px rgba(0,170,255,.2);
}

#map{
  height:450px;
  border-radius:15px;
}

.chart-box{
  background:linear-gradient(145deg,#0b1b39,#07122a);
  border-radius:16px;
  padding:20px;
  box-shadow:0 0 40px rgba(0,170,255,.12);
}

/* RIGHT SIDE */
.right-panel{
  display:grid;
  grid-template-rows: repeat(4, 1fr);
  gap:20px;
}

.card{
  background:linear-gradient(145deg,#0b1b39,#07122a);
  border-radius:16px;
  padding:20px;
  box-shadow:0 0 40px rgba(0,170,255,.12);
}

.card-title{
  font-size:12px;
  opacity:.7;
  letter-spacing:.5px;
}

.metric{
  font-size:26px;
  font-weight:bold;
  margin-top:8px;
}
</style>
</head>
<body>

<div class="header">
Forge Global Client Intelligence Command
</div>

<div class="dashboard">

  <!-- LEFT -->
  <div class="left-panel">

    <div class="map-box">
      <div id="map"></div>
    </div>

    <div class="chart-box">
      <canvas id="revenueChart"></canvas>
    </div>

  </div>

  <!-- RIGHT -->
  <div class="right-panel">

    <div class="card">
      <div class="card-title">ACTIVE MRR</div>
      <div id="mrr" class="metric">$0</div>
    </div>

    <div class="card">
      <div class="card-title">REVENUE AT RISK</div>
      <div id="risk" class="metric">$0</div>
    </div>

    <div class="card">
      <div class="card-title">CHURN RATE</div>
      <div id="churn" class="metric">0%</div>
    </div>

    <div class="card">
      <div class="card-title">FUSION SCORE</div>
      <div id="fusion" class="metric">0</div>
    </div>

  </div>

</div>

<script>
/* ---------------- SUPABASE ---------------- */
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------------- MAP ---------------- */
const map = L.map('map', { zoomControl:false }).setView([20,0], 2);

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
).addTo(map);

let markersLayer = L.layerGroup().addTo(map);

async function loadClients(){
  markersLayer.clearLayers();

  const { data:clients } = await sb
    .from("clients")
    .select("company_name, latitude, longitude, monthly_revenue");

  if(!clients) return;

  clients.forEach(c=>{
    if(c.latitude && c.longitude){
      const marker = L.circleMarker(
        [c.latitude, c.longitude],
        {
          radius:8,
          color:"#00d4ff",
          fillColor:"#00d4ff",
          fillOpacity:0.9
        }
      ).addTo(markersLayer);

      marker.bindPopup(`
        <b>${c.company_name}</b><br>
        Revenue: $${c.monthly_revenue ?? 0}
      `);
    }
  });
}

/* Realtime Insert */
sb.channel('clients-live')
  .on(
    'postgres_changes',
    { event:'INSERT', schema:'public', table:'clients' },
    payload => loadClients()
  )
  .subscribe();

/* ---------------- METRICS ---------------- */
async function loadMetrics(){

  const {data:rev} = await sb.from("forge_admin_revenue_analytics").select("*").single();
  document.getElementById("mrr").innerText =
    "$"+(rev?.active_mrr ?? 0);

  const {data:risk} = await sb.from("forge_revenue_at_risk").select("*").single();
  document.getElementById("risk").innerText =
    "$"+(risk?.revenue_at_risk ?? 0);

  const {data:churn} = await sb.from("forge_churn_rate").select("*").single();
  document.getElementById("churn").innerText =
    (churn?.churn_percentage ?? 0)+"%";

  const {data:fusion} = await sb.from("forge_fusion_score").select("*").single();
  document.getElementById("fusion").innerText =
    fusion?.forge_fusion_score ?? 0;
}

/* ---------------- REVENUE CHART ---------------- */
async function loadRevenueChart(){

  const {data} = await sb
    .from("clients")
    .select("company_name, monthly_revenue");

  if(!data) return;

  const labels = data.map(c=>c.company_name);
  const values = data.map(c=>c.monthly_revenue ?? 0);

  new Chart(document.getElementById("revenueChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{
        data:values,
        backgroundColor:"rgba(0,212,255,.6)"
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:"white"}},
        y:{ticks:{color:"white"}}
      }
    }
  });
}

/* ---------------- INIT ---------------- */
loadClients();
loadMetrics();
loadRevenueChart();

</script>

</body>
</html>