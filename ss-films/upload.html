<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Upload Studio ‚Äì SS Films</title>

<style>
body{
  margin:0;
  background:#070b10;
  color:white;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}

header{
  padding:14px;
  font-size:20px;
  font-weight:600;
  border-bottom:1px solid #111;
}

.container{
  padding:14px;
  max-width:800px;
  margin:auto;
}

.card{
  background:#0f141b;
  border-radius:16px;
  padding:14px;
  margin-bottom:14px;
}

.upload-box{
  border:2px dashed #2a3340;
  border-radius:14px;
  padding:30px;
  text-align:center;
  cursor:pointer;
}

.upload-box:hover{border-color:#4da3ff}

.preview{
  width:100%;
  max-height:260px;
  object-fit:cover;
  border-radius:12px;
  display:none;
}

input,textarea,select{
  width:100%;
  padding:10px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  background:#141a22;
  color:white;
}

button{
  width:100%;
  padding:12px;
  margin-top:12px;
  border:none;
  border-radius:12px;
  background:#4da3ff;
  color:black;
  font-weight:600;
  cursor:pointer;
}

.progress{
  height:6px;
  background:#1a1f27;
  border-radius:5px;
  overflow:hidden;
  margin-top:10px;
  display:none;
}

.progress span{
  display:block;
  height:100%;
  width:0%;
  background:#4da3ff;
}

.stats{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  opacity:.8;
}
</style>
</head>
<body>

<header>Upload Studio</header>

<div class="container">

<div class="card stats">
  <div>üé¨ Films: <span id="filmCount">0</span></div>
  <div>üëÅ Views: <span id="totalViews">0</span></div>
  <div>‚ù§Ô∏è Likes: <span id="totalLikes">0</span></div>
</div>

<div class="card">

  <div class="upload-box" id="uploadBox">
    <p>üìÅ Click or drag film here</p>
  </div>

  <video id="videoPreview" class="preview" controls></video>

  <input id="title" placeholder="Film title">
  <textarea id="description" rows="3" placeholder="Description"></textarea>

  <select id="category"></select>

  <label style="display:flex;align-items:center;gap:8px;margin-top:10px">
    <input type="checkbox" id="publish" checked>
    Publish immediately
  </label>

  <div class="progress"><span></span></div>

  <button onclick="uploadFilm()">Upload Film</button>

</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient("https://iabzmoxzbqzcqgypxctr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ");

const uploadBox=document.getElementById("uploadBox");
const videoPreview=document.getElementById("videoPreview");
const progressBar=document.querySelector(".progress");
const progressSpan=document.querySelector(".progress span");

let selectedFile=null;

uploadBox.onclick=()=>pickFile();

uploadBox.ondragover=e=>e.preventDefault();
uploadBox.ondrop=e=>{
  e.preventDefault();
  handleFile(e.dataTransfer.files[0]);
};

function pickFile(){
  const input=document.createElement("input");
  input.type="file";
  input.accept="video/*";
  input.onchange=()=>handleFile(input.files[0]);
  input.click();
}

function handleFile(file){
  selectedFile=file;
  videoPreview.src=URL.createObjectURL(file);
  videoPreview.style.display="block";
}

async function loadCategories(){
  const {data}=await supabase.from("film_categories").select("*");
  const sel=document.getElementById("category");
  data.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.id;
    o.innerText=c.name;
    sel.appendChild(o);
  });
}

async function loadStats(){
  const {data:{user}}=await supabase.auth.getUser();
  if(!user) return;

  const {data}=await supabase.from("films").select("views").eq("creator_id",user.id);

  document.getElementById("filmCount").innerText=data.length;
  document.getElementById("totalViews").innerText=data.reduce((a,b)=>a+(b.views||0),0);
  document.getElementById("totalLikes").innerText="‚Äî";
}

window.uploadFilm=async()=>{
  if(!selectedFile) return alert("Select a film");

  const title=document.getElementById("title").value;
  if(!title) return alert("Enter title");

  const {data:{user}}=await supabase.auth.getUser();
  if(!user) return alert("Login required");

  progressBar.style.display="block";

  const filename=`${user.id}/${Date.now()}_${selectedFile.name}`;

  const {error}=await supabase.storage
    .from("films")
    .upload(filename,selectedFile,{
      onUploadProgress:p=>{
        const percent=Math.round(p.loaded/p.total*100);
        progressSpan.style.width=percent+"%";
      }
    });

  if(error) return alert("Upload failed");

  const videoUrl=supabase.storage.from("films").getPublicUrl(filename).data.publicUrl;

  await supabase.from("films").insert({
    title,
    description:document.getElementById("description").value,
    category_id:document.getElementById("category").value,
    video_url:videoUrl,
    thumbnail_url:"",
    creator_id:user.id,
    is_published:document.getElementById("publish").checked
  });

  alert("Uploaded!");

  location.reload();
}

loadCategories();
loadStats();
</script>

</body>
</html>