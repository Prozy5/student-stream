<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Browse ‚Äì SS Films</title>

<style>
body{
  margin:0;
  background:#070b10;
  color:#fff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background:#070b10cc;
  backdrop-filter:blur(10px);
  padding:12px;
}

.top{
  display:flex;
  gap:10px;
}

input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#141a22;
  color:white;
}

select{
  padding:10px;
  border:none;
  border-radius:10px;
  background:#141a22;
  color:white;
}

.categories{
  display:flex;
  gap:8px;
  overflow-x:auto;
  margin-top:10px;
}

.cat{
  padding:6px 12px;
  background:#141a22;
  border-radius:20px;
  font-size:13px;
  cursor:pointer;
  white-space:nowrap;
}

.cat.active{
  background:#4da3ff;
  color:black;
}

.grid{
  padding:12px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:12px;
}

.card img{
  width:100%;
  height:200px;
  object-fit:cover;
  border-radius:12px;
}

.title{
  font-size:13px;
  margin-top:5px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.meta{
  font-size:11px;
  opacity:.7;
}
</style>
</head>
<body>

<header>
  <div class="top">
    <input id="search" placeholder="Search films...">
    <select id="sort">
      <option value="new">Newest</option>
      <option value="views">Trending</option>
      <option value="likes">Popular</option>
    </select>
  </div>
  <div class="categories" id="categories"></div>
</header>

<div class="grid" id="grid"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient("https://iabzmoxzbqzcqgypxctr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ");

const grid = document.getElementById("grid");
const searchInput = document.getElementById("search");
const sortSelect = document.getElementById("sort");
const categoriesDiv = document.getElementById("categories");

let films=[];
let categories=[];
let selectedCategory=null;

function card(f){
  return `
  <div class="card" onclick="location.href='watch.html?id=${f.id}'">
    <img src="${f.thumbnail_url}">
    <div class="title">${f.title}</div>
    <div class="meta">üëÅ ${f.views||0}</div>
  </div>`;
}

async function loadFilms(){
  const {data}=await supabase
    .from("films")
    .select("*")
    .eq("is_published",true);

  films=data||[];
  render();
}

async function loadCategories(){
  const {data}=await supabase.from("film_categories").select("*");
  categories=data||[];

  categoriesDiv.innerHTML=`<div class="cat active" onclick="selectCat(null,this)">All</div>`;

  categories.forEach(c=>{
    const el=document.createElement("div");
    el.className="cat";
    el.innerText=c.name;
    el.onclick=()=>selectCat(c.id,el);
    categoriesDiv.appendChild(el);
  });
}

window.selectCat=(id,el)=>{
  selectedCategory=id;
  document.querySelectorAll(".cat").forEach(c=>c.classList.remove("active"));
  el.classList.add("active");
  render();
}

function render(){
  let list=[...films];

  const q=searchInput.value.toLowerCase();
  if(q){
    list=list.filter(f=>f.title.toLowerCase().includes(q));
  }

  if(selectedCategory){
    list=list.filter(f=>f.category_id===selectedCategory);
  }

  const sort=sortSelect.value;
  if(sort==="views") list.sort((a,b)=>(b.views||0)-(a.views||0));
  if(sort==="likes") list.sort((a,b)=>(b.likes||0)-(a.likes||0));
  if(sort==="new") list.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));

  grid.innerHTML=list.map(card).join("");
}

searchInput.oninput=render;
sortSelect.onchange=render;

loadFilms();
loadCategories();
</script>

</body>
</html>