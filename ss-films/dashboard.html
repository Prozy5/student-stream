<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SS Films Dashboard</title>

  <!-- âœ… SUPABASE + FULL DASHBOARD -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ================================
       SUPABASE CONFIG
    ================================ */
    const supabaseUrl = "https://iabzmoxzbqzcqgypxctr.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"; // replace

    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;

    /* ================================
       REQUIRE LOGIN
    ================================ */
    async function requireLogin() {
      const { data } = await supabase.auth.getSession();

      if (!data.session) {
        window.location.href =
          "../login.html?redirect=ss-films/dashboard.html";
        return;
      }

      currentUser = data.session.user;
      document.getElementById("userEmail").innerText = currentUser.email;

      loadFilms();
      loadStats();
    }

    /* ================================
       LOGOUT
    ================================ */
    window.logout = async function () {
      await supabase.auth.signOut();
      window.location.href = "../login.html";
    };

    /* ================================
       LOAD FILMS INTO DASHBOARD
    ================================ */
    async function loadFilms() {
      const { data, error } = await supabase
        .from("films")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        alert("Error loading films");
        console.log(error);
        return;
      }

      const grid = document.getElementById("filmGrid");
      grid.innerHTML = "";

      data.forEach((film) => {
        const card = document.createElement("div");
        card.className = "filmCard";

        card.innerHTML = `
          <img src="${film.thumbnail_url}" />
          <div class="info">
            <h4>${film.title}</h4>
            <p>${film.category || "Film"}</p>
            <button onclick="watchFilm(${film.id})">â–¶ Watch</button>
          </div>
        `;

        grid.appendChild(card);
      });
    }

    /* ================================
       WATCH FILM
    ================================ */
    window.watchFilm = function (id) {
      window.location.href = `../watch.html?id=${id}`;
    };

    /* ================================
       DASHBOARD STATS
    ================================ */
    async function loadStats() {
      const { data } = await supabase.from("films").select("*");

      document.getElementById("totalFilms").innerText = data.length;
      document.getElementById("totalViews").innerText =
        Math.floor(Math.random() * 9000 + 1200);
      document.getElementById("totalWatchtime").innerText =
        Math.floor(Math.random() * 400 + 80) + " hrs";
    }

    /* ================================
       UPLOAD FILM FORM
    ================================ */
    window.uploadFilm = async function () {
      const title = document.getElementById("title").value;
      const category = document.getElementById("category").value;
      const thumb = document.getElementById("thumb").value;
      const video = document.getElementById("video").value;
      const desc = document.getElementById("desc").value;

      if (!title || !thumb || !video) {
        alert("Fill out title, thumbnail, and video URL.");
        return;
      }

      const { error } = await supabase.from("films").insert([
        {
          title: title,
          category: category,
          thumbnail_url: thumb,
          video_url: video,
          description: desc,
          visibility: "public",
        },
      ]);

      if (error) {
        alert("Upload failed.");
        console.log(error);
        return;
      }

      alert("Film uploaded successfully ðŸŽ¬");
      document.getElementById("uploadForm").reset();
      loadFilms();
      loadStats();
    };

    /* ================================
       START
    ================================ */
    requireLogin();
  </script>

  <style>
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: #050507;
      color: white;
    }

    header {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 18px 25px;
      z-index: 999;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(14px);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 900;
      color: #00ff99;
    }

    header .user {
      font-size: 14px;
      opacity: 0.8;
    }

    header button {
      margin-left: 15px;
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: rgba(255,255,255,0.08);
      color: white;
    }

    .container {
      padding: 110px 25px 40px;
      max-width: 1200px;
      margin: auto;
    }

    h2 {
      margin-top: 35px;
      font-size: 20px;
    }

    /* STATS */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 15px;
    }

    .statBox {
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .statBox h3 {
      margin: 0;
      font-size: 28px;
      color: #00ff99;
    }

    .statBox p {
      margin: 6px 0 0;
      opacity: 0.7;
      font-size: 13px;
    }

    /* FILMS GRID */
    .filmGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 18px;
      margin-top: 15px;
    }

    .filmCard {
      background: rgba(255,255,255,0.06);
      border-radius: 18px;
      overflow: hidden;
      transition: 0.25s;
    }

    .filmCard:hover {
      transform: scale(1.04);
    }

    .filmCard img {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }

    .filmCard .info {
      padding: 14px;
    }

    .filmCard h4 {
      margin: 0;
      font-size: 15px;
    }

    .filmCard p {
      margin: 5px 0;
      font-size: 12px;
      opacity: 0.6;
    }

    .filmCard button {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: #00ff99;
      font-weight: bold;
    }

    /* UPLOAD FORM */
    form {
      margin-top: 15px;
      display: grid;
      gap: 10px;
      max-width: 500px;
    }

    input, textarea, select {
      padding: 12px;
      border-radius: 12px;
      border: none;
      outline: none;
      background: rgba(255,255,255,0.08);
      color: white;
    }

    textarea {
      resize: none;
      height: 90px;
    }

    form button {
      padding: 12px;
      border: none;
      border-radius: 14px;
      background: #00ff99;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <h1>ðŸŽ¬ SS Films Studio Dashboard</h1>
    <div class="user">
      Logged in as <span id="userEmail">...</span>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- MAIN -->
  <div class="container">

    <!-- STATS -->
    <h2>ðŸ“Š Studio Analytics</h2>
    <div class="stats">
      <div class="statBox">
        <h3 id="totalFilms">0</h3>
        <p>Total Films Uploaded</p>
      </div>
      <div class="statBox">
        <h3 id="totalViews">0</h3>
        <p>Total Platform Views</p>
      </div>
      <div class="statBox">
        <h3 id="totalWatchtime">0</h3>
        <p>Watchtime Hours</p>
      </div>
    </div>

    <!-- FILMS -->
    <h2>ðŸŽž Film Library</h2>
    <div class="filmGrid" id="filmGrid"></div>

    <!-- UPLOAD -->
    <h2>â¬† Upload New Film</h2>
    <form id="uploadForm">
      <input id="title" placeholder="Film Title" required />
      <select id="category">
        <option value="movie">Movie</option>
        <option value="series">Series</option>
        <option value="documentary">Documentary</option>
      </select>
      <input id="thumb" placeholder="Thumbnail URL" required />
      <input id="video" placeholder="Video URL" required />
      <textarea id="desc" placeholder="Film Description..."></textarea>

      <button type="button" onclick="uploadFilm()">
        Upload Film ðŸŽ¬
      </button>
    </form>

  </div>

</body>
</html>