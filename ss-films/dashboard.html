<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SS Films Dashboard</title>

  <!-- ‚úÖ SUPABASE -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ===========================
       SUPABASE CONFIG
    =========================== */
    const supabaseUrl = "https://iabzmoxzbqzcqgypxctr.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

    const supabase = createClient(supabaseUrl, supabaseKey);

    let user = null;
    let allFilms = [];

    /* ===========================
       REQUIRE LOGIN
    =========================== */
    async function requireAuth() {
      const { data } = await supabase.auth.getSession();

      if (!data.session) {
        window.location.href = "login.html?redirect=dashboard.html";
        return;
      }

      user = data.session.user;
      document.getElementById("userEmail").innerText = user.email;
    }

    /* ===========================
       LOGOUT
    =========================== */
    window.logoutUser = async function () {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    };

    /* ===========================
       LOAD FILMS
    =========================== */
    async function loadDashboard() {
      const { data, error } = await supabase
        .from("films")
        .select("*")
        .eq("visibility", "public")
        .order("created_at", { ascending: false });

      if (error) {
        alert("Error loading dashboard films.");
        return;
      }

      allFilms = data;

      renderRow("trendingRow", data.slice(0, 6));
      renderRow("continueRow", []); // Placeholder
      renderRow("watchlistRow", []); // Placeholder

      // Premium Row (locked content)
      const premium = data.filter(f => f.premium === true);
      renderPremiumRow(premium);
    }

    /* ===========================
       RENDER NORMAL ROW
    =========================== */
    function renderRow(rowId, films) {
      const row = document.getElementById(rowId);
      row.innerHTML = "";

      if (films.length === 0) {
        row.innerHTML = `<p class="empty">Nothing here yet...</p>`;
        return;
      }

      films.forEach(film => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img src="${film.thumbnail_url}">
          <div class="overlay">
            <h4>${film.title}</h4>
          </div>
        `;

        card.onclick = () => {
          window.location.href = `watch.html?id=${film.id}`;
        };

        row.appendChild(card);
      });
    }

    /* ===========================
       PREMIUM ROW (LOCKED üîí)
    =========================== */
    function renderPremiumRow(films) {
      const row = document.getElementById("premiumRow");
      row.innerHTML = "";

      if (films.length === 0) {
        row.innerHTML = `<p class="empty">No premium films yet...</p>`;
        return;
      }

      films.forEach(film => {
        const card = document.createElement("div");
        card.className = "card locked";

        card.innerHTML = `
          <img src="${film.thumbnail_url}">
          <div class="overlay">
            <h4>${film.title}</h4>
            <span class="lockTag">üîí Premium</span>
          </div>
        `;

        card.onclick = () => openUpgrade();

        row.appendChild(card);
      });
    }

    /* ===========================
       UPGRADE POPUP
    =========================== */
    window.openUpgrade = function () {
      document.getElementById("upgradeModal").style.display = "flex";
    };

    window.closeUpgrade = function () {
      document.getElementById("upgradeModal").style.display = "none";
    };

    window.subscribeNow = function () {
      alert("üí≥ Subscription system coming next (Stripe + Premium Access)");
    };

    /* ===========================
       INIT
    =========================== */
    requireAuth().then(loadDashboard);
  </script>

  <style>
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: #050507;
      color: white;
    }

    header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 900;
      color: #00ff99;
    }

    .userBox {
      text-align: right;
      font-size: 13px;
      opacity: 0.7;
    }

    .logoutBtn {
      margin-top: 6px;
      padding: 8px 14px;
      border: none;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      color: white;
      cursor: pointer;
    }

    .section {
      padding: 18px 20px;
    }

    .section h2 {
      margin-bottom: 12px;
      font-size: 20px;
    }

    .row {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .row::-webkit-scrollbar {
      display: none;
    }

    .card {
      min-width: 160px;
      height: 220px;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: 0.25s;
    }

    .card:hover {
      transform: scale(1.06);
    }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .overlay {
      position: absolute;
      bottom: 0;
      width: 100%;
      padding: 12px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    }

    .overlay h4 {
      margin: 0;
      font-size: 14px;
    }

    .empty {
      opacity: 0.5;
      font-size: 14px;
    }

    .lockTag {
      display: inline-block;
      margin-top: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      background: rgba(0,255,153,0.2);
      color: #00ff99;
    }

    /* Upgrade Modal */
    #upgradeModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modalBox {
      width: 90%;
      max-width: 400px;
      padding: 28px;
      border-radius: 18px;
      background: rgba(255,255,255,0.08);
      text-align: center;
      backdrop-filter: blur(16px);
    }

    .modalBox h3 {
      margin: 0;
      font-size: 22px;
      color: #00ff99;
    }

    .modalBox p {
      opacity: 0.75;
      margin: 14px 0;
    }

    .modalBox button {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
      border: none;
      border-radius: 14px;
      font-weight: bold;
      cursor: pointer;
    }

    .subBtn {
      background: #00ff99;
    }

    .closeBtn {
      background: rgba(255,255,255,0.1);
      color: white;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <h1>üé¨ SS Films Dashboard</h1>

    <div class="userBox">
      Logged in as:<br>
      <span id="userEmail"></span><br>
      <button class="logoutBtn" onclick="logoutUser()">Logout</button>
    </div>
  </header>

  <!-- TRENDING -->
  <section class="section">
    <h2>üî• Trending Now</h2>
    <div class="row" id="trendingRow"></div>
  </section>

  <!-- CONTINUE WATCHING -->
  <section class="section">
    <h2>‚ñ∂ Continue Watching</h2>
    <div class="row" id="continueRow"></div>
  </section>

  <!-- WATCHLIST -->
  <section class="section">
    <h2>‚≠ê My Watchlist</h2>
    <div class="row" id="watchlistRow"></div>
  </section>

  <!-- PREMIUM -->
  <section class="section">
    <h2>üîí Premium Exclusives</h2>
    <div class="row" id="premiumRow"></div>
  </section>

  <!-- UPGRADE MODAL -->
  <div id="upgradeModal">
    <div class="modalBox">
      <h3>Upgrade to SS Films Premium</h3>
      <p>Unlock exclusive originals, premieres, and bonus content.</p>

      <button class="subBtn" onclick="subscribeNow()">
        Subscribe Now ($4.99/mo)
      </button>

      <button class="closeBtn" onclick="closeUpgrade()">
        Not Now
      </button>
    </div>
  </div>

</body>
</html>