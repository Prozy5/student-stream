<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Ä¢ SS Films</title>

  <!-- Supabase Module -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ================================
       SUPABASE CONFIG
    ================================ */
    const supabaseUrl = "https://iabzmoxzbqzcqgypxctr.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    /* ================================
       ELEMENTS
    ================================ */
    const trendingRow = document.getElementById("trendingRow");
    const continueRow = document.getElementById("continueRow");
    const watchlistRow = document.getElementById("watchlistRow");
    const userEmailEl = document.getElementById("userEmail");

    let currentUser = null;

    /* ================================
       LOGIN REQUIRED
    ================================ */
    async function requireAuth() {
      const { data } = await supabase.auth.getSession();

      if (!data.session) {
        window.location.href = "login.html?redirect=dashboard.html";
        return;
      }

      currentUser = data.session.user;
      userEmailEl.innerText = currentUser.email;

      loadDashboard();
    }

    /* ================================
       LOAD DASHBOARD DATA
    ================================ */
    async function loadDashboard() {
      loadTrending();
      loadContinueWatching();
      loadWatchlist();
    }

    /* ================================
       TRENDING FILMS (Most Views)
    ================================ */
    async function loadTrending() {
      const { data, error } = await supabase
        .from("films")
        .select("*")
        .eq("visibility", "public")
        .order("views", { ascending: false })
        .limit(10);

      if (error) return console.log(error);

      renderRow(trendingRow, data);
    }

    /* ================================
       CONTINUE WATCHING
    ================================ */
    async function loadContinueWatching() {
      const { data, error } = await supabase
        .from("continue_watching")
        .select("film_id, progress_seconds, films(*)")
        .eq("user_id", currentUser.id)
        .order("updated_at", { ascending: false });

      if (error) return console.log(error);

      const films = data.map(item => ({
        ...item.films,
        progress: item.progress_seconds
      }));

      renderRow(continueRow, films, true);
    }

    /* ================================
       WATCHLIST
    ================================ */
    async function loadWatchlist() {
      const { data, error } = await supabase
        .from("watchlist")
        .select("film_id, films(*)")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) return console.log(error);

      const films = data.map(item => item.films);

      renderRow(watchlistRow, films);
    }

    /* ================================
       RENDER FILM ROW
    ================================ */
    function renderRow(rowEl, films, showProgress = false) {
      rowEl.innerHTML = "";

      if (!films || films.length === 0) {
        rowEl.innerHTML = `<p class="emptyText">Nothing here yet...</p>`;
        return;
      }

      films.forEach(film => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img src="${film.thumbnail_url}" />

          <div class="cardOverlay">
            <h4>${film.title}</h4>

            ${
              showProgress
                ? `<div class="progressBar">
                     <div class="progressFill" style="width:${Math.min(
                       film.progress / 3,
                       100
                     )}%"></div>
                   </div>`
                : ""
            }

            <div class="actions">
              <button class="playBtn">‚ñ∂</button>
              <button class="addBtn">Ôºã</button>
              <button class="likeBtn">‚ù§</button>
            </div>
          </div>
        `;

        /* PLAY */
        card.querySelector(".playBtn").onclick = () => {
          window.location.href = `watch.html?id=${film.id}`;
        };

        /* ADD TO WATCHLIST */
        card.querySelector(".addBtn").onclick = async () => {
          await supabase.from("watchlist").insert({
            user_id: currentUser.id,
            film_id: film.id
          });
          loadWatchlist();
        };

        /* LIKE FILM */
        card.querySelector(".likeBtn").onclick = async () => {
          await supabase.from("film_likes").insert({
            user_id: currentUser.id,
            film_id: film.id
          });
          alert("‚ù§Ô∏è Liked!");
        };

        rowEl.appendChild(card);
      });
    }

    /* ================================
       LOGOUT
    ================================ */
    window.logout = async function () {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    };

    requireAuth();
  </script>

  <style>
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: #050507;
      color: white;
    }

    header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.75);
      position: sticky;
      top: 0;
      z-index: 999;
      backdrop-filter: blur(12px);
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 900;
      color: #00ff99;
    }

    .profile {
      text-align: right;
      font-size: 13px;
      opacity: 0.8;
    }

    .logoutBtn {
      margin-top: 6px;
      padding: 8px 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,0.1);
      color: white;
      font-weight: bold;
    }

    section {
      padding: 25px;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .row {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .row::-webkit-scrollbar {
      display: none;
    }

    .card {
      min-width: 190px;
      height: 270px;
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: 0.25s;
    }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card:hover {
      transform: scale(1.08);
    }

    .cardOverlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 14px;
    }

    .cardOverlay h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 800;
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .actions button {
      flex: 1;
      padding: 8px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      background: rgba(255,255,255,0.12);
      color: white;
    }

    .actions button:hover {
      background: rgba(255,255,255,0.25);
    }

    .progressBar {
      height: 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.2);
      margin-top: 8px;
      overflow: hidden;
    }

    .progressFill {
      height: 100%;
      background: #00ff99;
      width: 40%;
    }

    .emptyText {
      opacity: 0.6;
      font-size: 14px;
    }
  </style>
</head>

<body>

<header>
  <h1>üé¨ SS Films Dashboard</h1>

  <div class="profile">
    Logged in as:<br>
    <span id="userEmail">Loading...</span><br>
    <button class="logoutBtn" onclick="logout()">Logout</button>
  </div>
</header>

<section>
  <h2>üî• Trending Now</h2>
  <div class="row" id="trendingRow"></div>
</section>

<section>
  <h2>‚èØ Continue Watching</h2>
  <div class="row" id="continueRow"></div>
</section>

<section>
  <h2>‚≠ê My Watchlist</h2>
  <div class="row" id="watchlistRow"></div>
</section>

</body>
</html>