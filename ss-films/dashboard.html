<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SS Films Creator Dashboard V7</title>

  <!-- âœ… SUPABASE -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ===========================
       SUPABASE CONFIG
    =========================== */
    const supabaseUrl = "https://iabzmoxzbqzcqgypxctr.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

    const supabase = createClient(supabaseUrl, supabaseKey);

    let user = null;

    /* ===========================
       REQUIRE LOGIN
    =========================== */
    async function requireAuth() {
      const { data } = await supabase.auth.getSession();

      if (!data.session) {
        window.location.href = "login.html?redirect=dashboard.html";
        return;
      }

      user = data.session.user;
      document.getElementById("userEmail").innerText = user.email;

      loadMyFilms();
      loadEarnings();
    }

    /* ===========================
       LOGOUT
    =========================== */
    window.logoutUser = async function () {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    };

    /* ===========================
       LOAD CREATOR FILMS
    =========================== */
    async function loadMyFilms() {
      const { data } = await supabase
        .from("films")
        .select("*")
        .eq("creator_id", user.id)
        .order("created_at", { ascending: false });

      const row = document.getElementById("myFilmsRow");
      row.innerHTML = "";

      if (!data || data.length === 0) {
        row.innerHTML = `<p class="empty">No uploads yetâ€¦</p>`;
        return;
      }

      data.forEach(film => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img src="${film.thumbnail_url}" />
          <div class="overlay">
            <h4>${film.title}</h4>
            <p>${film.views || 0} views</p>
          </div>
        `;

        row.appendChild(card);
      });
    }

    /* ===========================
       CREATOR EARNINGS
    =========================== */
    async function loadEarnings() {
      const { data } = await supabase
        .from("films")
        .select("views")
        .eq("creator_id", user.id);

      let totalViews = 0;
      data.forEach(f => totalViews += f.views || 0);

      // Monetization Example: $2 per 1,000 views
      const earnings = (totalViews / 1000) * 2;

      document.getElementById("totalViews").innerText = totalViews;
      document.getElementById("totalEarnings").innerText =
        "$" + earnings.toFixed(2);
    }

    /* ===========================
       UPLOAD FILM + THUMBNAIL FILES
       INSTANTLY PUBLISHED
    =========================== */
    window.uploadFilm = async function () {
      const title = document.getElementById("filmTitle").value.trim();
      const desc = document.getElementById("filmDesc").value.trim();

      const videoFile = document.getElementById("filmVideo").files[0];
      const thumbFile = document.getElementById("filmThumb").files[0];

      const msg = document.getElementById("uploadMsg");
      msg.innerText = "";

      if (!title || !videoFile || !thumbFile) {
        msg.style.color = "red";
        msg.innerText = "âŒ Title + Video + Thumbnail required.";
        return;
      }

      msg.style.color = "#00ff99";
      msg.innerText = "Uploadingâ€¦ please wait...";

      /* ===========================
         1. Upload Thumbnail
      =========================== */
      const thumbPath = `${user.id}/thumb-${Date.now()}-${thumbFile.name}`;

      const { error: thumbErr } = await supabase.storage
        .from("films")
        .upload(thumbPath, thumbFile);

      if (thumbErr) {
        msg.style.color = "red";
        msg.innerText = "Thumbnail upload failed.";
        return;
      }

      const thumbUrl =
        supabase.storage.from("films").getPublicUrl(thumbPath).data.publicUrl;

      /* ===========================
         2. Upload Video
      =========================== */
      const videoPath = `${user.id}/video-${Date.now()}-${videoFile.name}`;

      const { error: videoErr } = await supabase.storage
        .from("films")
        .upload(videoPath, videoFile);

      if (videoErr) {
        msg.style.color = "red";
        msg.innerText = "Video upload failed.";
        return;
      }

      const videoUrl =
        supabase.storage.from("films").getPublicUrl(videoPath).data.publicUrl;

      /* ===========================
         3. Insert Film (PUBLISHED)
      =========================== */
      await supabase.from("films").insert([
        {
          title,
          description: desc,
          thumbnail_url: thumbUrl,
          video_url: videoUrl,
          creator_id: user.id,

          // âœ… INSTANTLY LIVE
          visibility: "public",
          status: "approved",

          views: 0,
          created_at: new Date()
        }
      ]);

      msg.innerText = "âœ… Uploaded & Published instantly!";

      setTimeout(() => location.reload(), 1200);
    };

    requireAuth();
  </script>

  <style>
    body {
      margin: 0;
      font-family: Inter, Arial;
      background: #050507;
      color: white;
    }

    header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-size: 22px;
      color: #00ff99;
      margin: 0;
    }

    .logoutBtn {
      padding: 10px 14px;
      border-radius: 14px;
      border: none;
      background: rgba(255,255,255,0.08);
      color: white;
      cursor: pointer;
    }

    .section {
      padding: 22px;
    }

    .earnBox {
      background: rgba(255,255,255,0.06);
      padding: 18px;
      border-radius: 16px;
      margin-top: 10px;
    }

    .studio input, textarea {
      width: 100%;
      margin-top: 10px;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: rgba(255,255,255,0.08);
      color: white;
    }

    .studio input[type="file"] {
      padding: 10px;
    }

    .studio button {
      width: 100%;
      margin-top: 14px;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: #00ff99;
      font-weight: bold;
      cursor: pointer;
    }

    .row {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      padding-top: 10px;
    }

    .card {
      min-width: 160px;
      height: 220px;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
    }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .overlay {
      position: absolute;
      bottom: 0;
      width: 100%;
      padding: 12px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    }

    .empty {
      opacity: 0.6;
      font-size: 14px;
    }
  </style>
</head>

<body>

<header>
  <h1>ðŸŽ¬ SS Films Creator Dashboard</h1>

  <div>
    <div id="userEmail" style="font-size:13px;opacity:0.7;"></div>
    <button class="logoutBtn" onclick="logoutUser()">Logout</button>
  </div>
</header>

<!-- âœ… Earnings -->
<section class="section">
  <h2>ðŸ’° Earnings</h2>
  <div class="earnBox">
    Total Views: <b id="totalViews">0</b><br>
    Estimated Earnings: <b id="totalEarnings">$0.00</b>
  </div>
</section>

<!-- âœ… Upload Studio -->
<section class="section">
  <h2>ðŸŽ¥ Upload Film (Instant Publish)</h2>

  <div class="studio">
    <input id="filmTitle" placeholder="Film Title" />
    <textarea id="filmDesc" placeholder="Description"></textarea>

    <label style="opacity:0.7;">Thumbnail Upload</label>
    <input id="filmThumb" type="file" accept="image/*" />

    <label style="opacity:0.7;">Video Upload</label>
    <input id="filmVideo" type="file" accept="video/mp4" />

    <button onclick="uploadFilm()">Upload & Publish</button>

    <div id="uploadMsg" style="margin-top:12px;"></div>
  </div>
</section>

<!-- âœ… My Films -->
<section class="section">
  <h2>ðŸ“‚ My Uploaded Films</h2>
  <div class="row" id="myFilmsRow"></div>
</section>

</body>
</html>