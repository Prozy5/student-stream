<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SS Films Dashboard V6</title>

  <!-- âœ… SUPABASE -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ===========================
       SUPABASE CONFIG
    =========================== */
    const supabaseUrl = "https://iabzmoxzbqzcqgypxctr.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

    const supabase = createClient(supabaseUrl, supabaseKey);

    let user = null;
    let isAdmin = false;

    /* ===========================
       REQUIRE LOGIN
    =========================== */
    async function requireAuth() {
      const { data } = await supabase.auth.getSession();

      if (!data.session) {
        window.location.href = "login.html?redirect=dashboard.html";
        return;
      }

      user = data.session.user;
      document.getElementById("userEmail").innerText = user.email;

      // âœ… ADMIN CHECK (your email)
      if (user.email === "deondrestreams1@gmail.com") {
        isAdmin = true;
        document.getElementById("adminPanel").style.display = "block";
      }
    }

    /* ===========================
       LOGOUT
    =========================== */
    window.logoutUser = async function () {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    };

    /* ===========================
       LOAD FILMS (APPROVED ONLY)
    =========================== */
    async function loadApproved() {
      const { data } = await supabase
        .from("films")
        .select("*")
        .eq("status", "approved")
        .order("created_at", { ascending: false });

      renderRow("approvedRow", data);
    }

    /* ===========================
       LOAD PENDING FILMS
    =========================== */
    async function loadPending() {
      const { data } = await supabase
        .from("films")
        .select("*")
        .eq("status", "pending")
        .order("created_at", { ascending: false });

      renderPending(data);
    }

    /* ===========================
       RENDER APPROVED FILMS
    =========================== */
    function renderRow(rowId, films) {
      const row = document.getElementById(rowId);
      row.innerHTML = "";

      if (!films || films.length === 0) {
        row.innerHTML = `<p class="empty">Nothing approved yet...</p>`;
        return;
      }

      films.forEach(film => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img src="${film.thumbnail_url}">
          <div class="overlay">
            <h4>${film.title}</h4>
          </div>
        `;

        row.appendChild(card);
      });
    }

    /* ===========================
       RENDER PENDING (ADMIN)
    =========================== */
    function renderPending(films) {
      const row = document.getElementById("pendingRow");
      row.innerHTML = "";

      if (!films || films.length === 0) {
        row.innerHTML = `<p class="empty">No pending uploads...</p>`;
        return;
      }

      films.forEach(film => {
        const card = document.createElement("div");
        card.className = "pendingCard";

        card.innerHTML = `
          <h4>${film.title}</h4>
          <p>${film.description || ""}</p>
          <button onclick="approveFilm('${film.id}')">âœ… Approve</button>
        `;

        row.appendChild(card);
      });
    }

    /* ===========================
       APPROVE FILM (ADMIN ONLY)
    =========================== */
    window.approveFilm = async function (filmId) {
      if (!isAdmin) return;

      await supabase
        .from("films")
        .update({ status: "approved" })
        .eq("id", filmId);

      alert("Film Approved!");
      loadApproved();
      loadPending();
    };

    /* ===========================
       UPLOAD VIDEO FILE (STORAGE)
    =========================== */
    window.uploadFilm = async function () {
      const title = document.getElementById("filmTitle").value.trim();
      const desc = document.getElementById("filmDesc").value.trim();
      const thumb = document.getElementById("filmThumb").value.trim();
      const file = document.getElementById("filmFile").files[0];

      const msg = document.getElementById("uploadMsg");
      msg.innerText = "";

      if (!title || !thumb || !file) {
        msg.innerText = "âŒ Title, thumbnail, and video file required.";
        return;
      }

      msg.style.color = "#00ff99";
      msg.innerText = "Uploading video...";

      /* Upload to Storage */
      const filePath = `${user.id}/${Date.now()}-${file.name}`;

      const { error: uploadError } = await supabase.storage
        .from("films")
        .upload(filePath, file);

      if (uploadError) {
        msg.style.color = "red";
        msg.innerText = uploadError.message;
        return;
      }

      /* Get Public URL */
      const { data: urlData } = supabase.storage
        .from("films")
        .getPublicUrl(filePath);

      const videoUrl = urlData.publicUrl;

      /* Insert Pending Film */
      await supabase.from("films").insert([
        {
          title,
          description: desc,
          thumbnail_url: thumb,
          video_url: videoUrl,
          creator_id: user.id,
          status: "pending",
          views: 0
        }
      ]);

      msg.innerText = "âœ… Uploaded! Waiting for approval.";

      setTimeout(() => location.reload(), 1000);
    };

    /* ===========================
       CREATOR EARNINGS
    =========================== */
    async function loadEarnings() {
      const { data } = await supabase
        .from("films")
        .select("views")
        .eq("creator_id", user.id);

      let totalViews = 0;
      data.forEach(f => totalViews += f.views || 0);

      // Example payout model: $2 per 1,000 views
      const earnings = (totalViews / 1000) * 2;

      document.getElementById("totalViews").innerText = totalViews;
      document.getElementById("totalEarnings").innerText =
        "$" + earnings.toFixed(2);
    }

    /* ===========================
       INIT DASHBOARD
    =========================== */
    requireAuth().then(() => {
      loadApproved();
      loadPending();
      loadEarnings();
    });
  </script>

  <style>
    body {
      margin: 0;
      font-family: Inter, Arial;
      background: #050507;
      color: white;
    }

    header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
    }

    h1 {
      color: #00ff99;
      font-size: 24px;
    }

    .logoutBtn {
      padding: 8px 14px;
      border-radius: 12px;
      border: none;
      background: rgba(255,255,255,0.08);
      color: white;
      cursor: pointer;
    }

    .section {
      padding: 20px;
    }

    .row {
      display: flex;
      gap: 14px;
      overflow-x: auto;
    }

    .card {
      min-width: 160px;
      height: 220px;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
    }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .overlay {
      position: absolute;
      bottom: 0;
      padding: 12px;
      width: 100%;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    }

    .studio input, textarea {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: none;
      background: rgba(255,255,255,0.08);
      color: white;
    }

    .studio button {
      width: 100%;
      margin-top: 14px;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: #00ff99;
      font-weight: bold;
    }

    .pendingCard {
      background: rgba(255,255,255,0.06);
      padding: 14px;
      border-radius: 14px;
      min-width: 220px;
    }

    .pendingCard button {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 12px;
      background: #00ff99;
    }

    .earnBox {
      background: rgba(255,255,255,0.06);
      padding: 18px;
      border-radius: 16px;
      margin-top: 12px;
    }
  </style>
</head>

<body>

<header>
  <h1>ðŸŽ¬ SS Films Dashboard V6</h1>

  <div>
    <div id="userEmail"></div>
    <button class="logoutBtn" onclick="logoutUser()">Logout</button>
  </div>
</header>

<!-- âœ… CREATOR EARNINGS -->
<section class="section">
  <h2>ðŸ’° Creator Earnings</h2>
  <div class="earnBox">
    Total Views: <b id="totalViews">0</b><br>
    Estimated Earnings: <b id="totalEarnings">$0.00</b>
  </div>
</section>

<!-- âœ… APPROVED FILMS -->
<section class="section">
  <h2>âœ… Approved Films</h2>
  <div class="row" id="approvedRow"></div>
</section>

<!-- âœ… UPLOAD STUDIO -->
<section class="section">
  <h2>ðŸŽ¥ Upload Film (Pending Approval)</h2>

  <div class="studio">
    <input id="filmTitle" placeholder="Film Title" />
    <textarea id="filmDesc" placeholder="Description"></textarea>
    <input id="filmThumb" placeholder="Thumbnail URL" />

    <input id="filmFile" type="file" accept="video/mp4" />

    <button onclick="uploadFilm()">Upload Film</button>
    <div id="uploadMsg"></div>
  </div>
</section>

<!-- âœ… ADMIN PANEL -->
<section class="section" id="adminPanel" style="display:none;">
  <h2>ðŸ›  Admin Approval Panel</h2>
  <div class="row" id="pendingRow"></div>
</section>

</body>
</html>