<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Watch | SS Films V3</title>

  <style>
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: #050507;
      color: white;
    }

    header {
      padding: 18px 20px;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 999;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(14px);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      color: #00ff99;
      font-size: 18px;
      margin: 0;
    }

    .back-btn {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,0.1);
      color: white;
      font-weight: bold;
    }

    video, iframe {
      width: 100%;
      height: 70vh;
      margin-top: 75px;
      background: black;
      border: none;
    }

    iframe {
      display: none;
    }

    .info {
      max-width: 950px;
      margin: auto;
      padding: 25px;
    }

    h2 {
      font-size: 38px;
      margin: 0;
      font-weight: 900;
    }

    .desc {
      margin-top: 12px;
      opacity: 0.8;
      line-height: 1.5;
    }

    .like-area {
      margin-top: 20px;
      display: flex;
      gap: 14px;
      align-items: center;
    }

    #likeBtn {
      padding: 12px 18px;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      background: rgba(255,255,255,0.08);
      color: white;
      transition: 0.2s;
    }

    #likeBtn:hover {
      transform: scale(1.05);
    }

    .comments {
      margin-top: 35px;
    }

    textarea {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      outline: none;
      background: rgba(255,255,255,0.08);
      color: white;
      resize: none;
      height: 80px;
    }

    #commentBtn {
      margin-top: 10px;
      padding: 12px 18px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      background: #00ff99;
      font-weight: bold;
    }

    .comment {
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
    }

    .comment b {
      color: #00ff99;
    }

    .suggest-row {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      margin-top: 15px;
    }

    .suggest-card {
      min-width: 160px;
      cursor: pointer;
    }

    .suggest-card img {
      width: 160px;
      height: 220px;
      border-radius: 14px;
      object-fit: cover;
    }

    .suggest-card p {
      font-size: 13px;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<header>
  <h1>üé¨ SS Films</h1>
  <button class="back-btn" onclick="window.location.href='index.html'">
    ‚¨Ö Back
  </button>
</header>

<!-- üé• Player -->
<video id="player" controls></video>
<iframe id="youtubeFrame" allowfullscreen></iframe>

<div class="info">
  <h2 id="filmTitle"></h2>
  <p class="desc" id="filmDesc"></p>

  <!-- ‚ù§Ô∏è Likes -->
  <div class="like-area">
    <button id="likeBtn">ü§ç Like</button>
    <span><b id="likeCount">0</b> likes</span>
  </div>

  <!-- üí¨ Comments -->
  <div class="comments">
    <h3>Comments</h3>

    <textarea id="commentText" placeholder="Write a comment..."></textarea>
    <button id="commentBtn">Post Comment</button>

    <div id="commentsList"></div>
  </div>

  <!-- Suggestions -->
  <div class="suggestions">
    <h3>More Like This</h3>
    <div class="suggest-row" id="suggestionsRow"></div>
  </div>
</div>

<!-- ‚úÖ SCRIPT GOES AT BOTTOM -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabaseUrl = "https://iabzmoxzbqzcqgypxctr.supabase.co";
  const supabaseKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

  const supabase = createClient(supabaseUrl, supabaseKey);

  const params = new URLSearchParams(window.location.search);
  const filmId = params.get("id");

  const titleEl = document.getElementById("filmTitle");
  const descEl = document.getElementById("filmDesc");
  const player = document.getElementById("player");
  const youtubeFrame = document.getElementById("youtubeFrame");

  const likeBtn = document.getElementById("likeBtn");
  const likeCountEl = document.getElementById("likeCount");

  const commentBox = document.getElementById("commentText");
  const commentBtn = document.getElementById("commentBtn");
  const commentsList = document.getElementById("commentsList");

  const suggestionsRow = document.getElementById("suggestionsRow");

  let currentUser = null;

  /* ‚úÖ FIX DRIVE LINKS */
  function fixDrive(url) {
    if (!url.includes("drive.google.com/file/d/")) return url;
    const fileId = url.split("/d/")[1].split("/")[0];
    return `https://drive.google.com/uc?export=download&id=${fileId}`;
  }

  /* ‚úÖ FIX YOUTUBE LINKS */
  function getYoutubeEmbed(url) {
    if (!url.includes("youtu")) return null;

    let id = null;

    if (url.includes("youtu.be/")) {
      id = url.split("youtu.be/")[1].split("?")[0];
    }

    if (url.includes("watch?v=")) {
      id = url.split("watch?v=")[1].split("&")[0];
    }

    if (!id) return null;

    return `https://www.youtube.com/embed/${id}?autoplay=1`;
  }

  async function checkAuth() {
    const { data } = await supabase.auth.getSession();
    if (!data.session) {
      window.location.href = `login.html?redirect=watch.html?id=${filmId}`;
      return;
    }
    currentUser = data.session.user;
  }

  async function loadFilm() {
    const { data } = await supabase
      .from("films")
      .select("*")
      .eq("id", filmId)
      .single();

    titleEl.innerText = data.title;
    descEl.innerText = data.description;

    const yt = getYoutubeEmbed(data.video_url);

    if (yt) {
      player.style.display = "none";
      youtubeFrame.style.display = "block";
      youtubeFrame.src = yt;
      return;
    }

    player.src = fixDrive(data.video_url);
  }

  async function loadLikes() {
    const { data } = await supabase
      .from("likes")
      .select("*")
      .eq("film_id", filmId);

    likeCountEl.innerText = data.length;

    const liked = data.some(l => l.user_id === currentUser.id);
    likeBtn.innerText = liked ? "‚ù§Ô∏è Liked" : "ü§ç Like";
    likeBtn.dataset.liked = liked;
  }

  likeBtn.onclick = async () => {
    const liked = likeBtn.dataset.liked === "true";

    if (!liked) {
      await supabase.from("likes").insert([
        { film_id: filmId, user_id: currentUser.id }
      ]);
    } else {
      await supabase.from("likes")
        .delete()
        .eq("film_id", filmId)
        .eq("user_id", currentUser.id);
    }

    loadLikes();
  };

  async function loadComments() {
    const { data } = await supabase
      .from("comments")
      .select("*")
      .eq("film_id", filmId)
      .order("created_at", { ascending: false });

    commentsList.innerHTML = "";

    data.forEach(c => {
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `<b>${c.user_email}</b><p>${c.text}</p>`;
      commentsList.appendChild(div);
    });
  }

  commentBtn.onclick = async () => {
    const text = commentBox.value.trim();
    if (!text) return;

    await supabase.from("comments").insert([
      {
        film_id: filmId,
        user_id: currentUser.id,
        user_email: currentUser.email,
        text
      }
    ]);

    commentBox.value = "";
    loadComments();
  };

  async function init() {
    await checkAuth();
    await loadFilm();
    await loadLikes();
    await loadComments();
  }

  init();
</script>

</body>
</html>