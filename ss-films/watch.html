<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Watch ‚Äì SS Films</title>

<style>
body{
  margin:0;
  background:#070b10;
  color:#fff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}

.player-wrap{
  position:relative;
  background:black;
}

video{
  width:100%;
  max-height:60vh;
  background:black;
}

.top-bar{
  position:absolute;
  top:10px;
  left:10px;
  z-index:10;
}

.top-bar button{
  background:#0009;
  border:none;
  color:white;
  padding:8px 12px;
  border-radius:10px;
}

.info{
  padding:14px;
}

.title{
  font-size:20px;
  font-weight:700;
}

.meta{
  font-size:13px;
  opacity:.7;
  margin-top:4px;
}

.actions{
  display:flex;
  gap:12px;
  margin:12px 0;
}

.actions button{
  background:#141a22;
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:12px;
}

.creator-card{
  display:flex;
  gap:10px;
  align-items:center;
  background:#0e141c;
  padding:10px;
  border-radius:12px;
  margin-top:10px;
}

.creator-avatar{
  width:42px;
  height:42px;
  border-radius:50%;
  background:#333;
}

.description{
  font-size:14px;
  opacity:.8;
  margin-top:10px;
}

.comments{
  padding:14px;
}

.comment{
  padding:8px 0;
  border-bottom:1px solid #1a2330;
  font-size:14px;
}

.comment small{
  opacity:.6;
}

.comment-box{
  display:flex;
  gap:8px;
  margin-top:10px;
}

.comment-box input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:none;
  background:#141a22;
  color:white;
}

.comment-box button{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  background:#4da3ff;
  color:black;
}

.section{
  padding:14px;
}

.row{
  display:flex;
  gap:10px;
  overflow-x:auto;
}

.card{
  min-width:120px;
}

.card img{
  width:120px;
  height:170px;
  border-radius:10px;
  object-fit:cover;
}

.card .title{
  font-size:12px;
}
</style>
</head>
<body>

<div class="player-wrap">
  <div class="top-bar">
    <button onclick="history.back()">‚Üê Back</button>
  </div>
  <video id="player" controls></video>
</div>

<div class="info">
  <div class="title" id="title"></div>
  <div class="meta" id="meta"></div>

  <div class="actions">
    <button onclick="toggleLike()">‚ù§Ô∏è Like</button>
    <button onclick="toggleSave()">üíæ Save</button>
  </div>

  <div class="creator-card" id="creator"></div>

  <div class="description" id="description"></div>
</div>

<div class="comments">
  <h3>Comments</h3>
  <div id="commentList"></div>

  <div class="comment-box">
    <input id="commentInput" placeholder="Write a comment...">
    <button onclick="postComment()">Send</button>
  </div>
</div>

<div class="section">
  <h3>Related</h3>
  <div class="row" id="related"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient("YOUR_URL","YOUR_PUBLIC_KEY");

const id = new URLSearchParams(location.search).get("id");

let user=null, film=null, liked=false, saved=false;

const player=document.getElementById("player");

async function init(){
  const {data:u}=await supabase.auth.getUser();
  user=u.user;

  await loadFilm();
  await loadLikes();
  await loadSave();
  await loadComments();
  await loadRelated();
  setupProgressTracking();
  addView();
}

async function loadFilm(){
  const {data}=await supabase
    .from("films")
    .select("*, film_creators(name,avatar_url)")
    .eq("id",id)
    .single();

  film=data;

  player.src=data.video_url;

  document.getElementById("title").textContent=data.title;
  document.getElementById("meta").textContent=`${data.views||0} views`;

  document.getElementById("description").textContent=data.description||"";

  document.getElementById("creator").innerHTML=`
    <div class="creator-avatar"></div>
    <div>
      <div>${data.film_creators?.name||"Creator"}</div>
      <small>Creator</small>
    </div>`;
}

async function addView(){
  await supabase.from("film_views").insert({film_id:id,user_id:user?.id||null});
}

async function loadLikes(){
  if(!user) return;
  const {data}=await supabase.from("film_likes")
    .select("*").eq("film_id",id).eq("user_id",user.id);
  liked=!!data.length;
}

async function toggleLike(){
  if(!user) return alert("Login required");

  if(liked){
    await supabase.from("film_likes").delete().eq("film_id",id).eq("user_id",user.id);
  }else{
    await supabase.from("film_likes").insert({film_id:id,user_id:user.id});
  }
  liked=!liked;
}

async function loadSave(){
  if(!user) return;
  const {data}=await supabase.from("saved_films")
    .select("*").eq("film_id",id).eq("user_id",user.id);
  saved=!!data.length;
}

async function toggleSave(){
  if(!user) return alert("Login required");

  if(saved){
    await supabase.from("saved_films").delete().eq("film_id",id).eq("user_id",user.id);
  }else{
    await supabase.from("saved_films").insert({film_id:id,user_id:user.id});
  }
  saved=!saved;
}

function setupProgressTracking(){
  let last=0;
  player.addEventListener("timeupdate",async()=>{
    if(!user) return;
    if(player.currentTime-last<10) return;
    last=player.currentTime;

    const progress=Math.floor((player.currentTime/player.duration)*100);

    await supabase.from("film_progress").upsert({
      film_id:id,
      user_id:user.id,
      progress
    });
  });
}

async function loadComments(){
  const {data}=await supabase
    .from("film_comments")
    .select("*, users(email)")
    .eq("film_id",id)
    .order("created_at",{ascending:false});

  const box=document.getElementById("commentList");
  box.innerHTML="";

  data.forEach(c=>{
    box.innerHTML+=`
      <div class="comment">
        <strong>${c.users?.email||"User"}</strong>
        <div>${c.content}</div>
        <small>${new Date(c.created_at).toLocaleString()}</small>
      </div>`;
  });
}

async function postComment(){
  if(!user) return alert("Login required");
  const text=document.getElementById("commentInput").value.trim();
  if(!text) return;

  await supabase.from("film_comments").insert({
    film_id:id,
    user_id:user.id,
    content:text
  });

  document.getElementById("commentInput").value="";
  loadComments();
}

async function loadRelated(){
  const {data}=await supabase.from("films")
    .select("id,title,thumbnail_url")
    .neq("id",id)
    .limit(10);

  const row=document.getElementById("related");
  row.innerHTML="";

  data.forEach(f=>{
    row.innerHTML+=`
      <div class="card" onclick="location.href='watch.html?id=${f.id}'">
        <img src="${f.thumbnail_url}">
        <div class="title">${f.title}</div>
      </div>`;
  });
}

init();
</script>

</body>
</html>