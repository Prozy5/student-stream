<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
 margin:0;
 font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
 background: radial-gradient(circle at top, #0f172a, #020617);
 color: #e5e7eb;
}

header {
 padding: 24px;
 display:flex;
 justify-content:space-between;
 align-items:center;
 border-bottom: 1px solid #1e293b;
}

h1 { margin:0; font-size:22px; }

.badge {
 padding:6px 12px;
 border-radius:999px;
 font-size:13px;
 font-weight:600;
}

.ok { background:#16a34a; }
.warn { background:#f59e0b; }
.down { background:#dc2626; }

main {
 max-width:900px;
 margin:40px auto;
 padding:0 20px;
}

.section {
 margin-bottom:40px;
}

.card {
 background:#020617;
 border:1px solid #1e293b;
 border-radius:12px;
 padding:16px;
 margin-bottom:12px;
 display:flex;
 justify-content:space-between;
 align-items:center;
}

small { color:#94a3b8; }

.loading {
 text-align:center;
 padding:60px;
 color:#94a3b8;
}
</style>
</head>
<body>

<header>
 <h1>StudentStream System Status</h1>
 <div id="globalStatus" class="badge ok">Loading</div>
</header>

<main>

<div class="section">
 <h2>Components</h2>
 <div id="components" class="loading">Loading componentsâ€¦</div>
</div>

<div class="section">
 <h2>Incidents</h2>
 <div id="incidents" class="loading">No incidents reported</div>
</div>

</main>

<script>
console.log("Status page loaded");

const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

console.log("Supabase connected");

const componentsDiv = document.getElementById("components");
const incidentsDiv = document.getElementById("incidents");
const globalBadge = document.getElementById("globalStatus");

function badgeClass(status){
 if(status === "operational") return "ok";
 if(status === "degraded") return "warn";
 return "down";
}

function computeGlobal(components){
 if(components.some(c => c.status === "down")) return "down";
 if(components.some(c => c.status === "degraded")) return "degraded";
 return "operational";
}

function renderComponents(data){
 componentsDiv.innerHTML = "";
 data.forEach(c => {
 const el = document.createElement("div");
 el.className = "card";
 el.innerHTML = `
 <div>
 <strong>${c.name}</strong><br>
 <small>Updated ${new Date(c.created_at).toLocaleString()}</small>
 </div>
 <span class="badge ${badgeClass(c.status)}">${c.status}</span>
 `;
 componentsDiv.appendChild(el);
 });

 const global = computeGlobal(data);
 globalBadge.textContent = global;
 globalBadge.className = "badge " + badgeClass(global);
}

async function loadComponents(){
 const { data, error } = await db
 .from("status_components")
 .select("*")
 .order("id");

 if(error){
 console.error(error);
 componentsDiv.innerHTML = "Failed to load components";
 return;
 }

 renderComponents(data);
}

async function loadIncidents(){
 const { data } = await db
 .from("status_incidents")
 .select("*")
 .order("created_at", { ascending:false })
 .limit(5);

 if(!data || data.length === 0){
 incidentsDiv.innerHTML = "<small>No active incidents</small>";
 return;
 }

 incidentsDiv.innerHTML = "";
 data.forEach(i=>{
 const el = document.createElement("div");
 el.className="card";
 el.innerHTML = `
 <div>
 <strong>${i.title}</strong><br>
 <small>${i.description}</small>
 </div>
 <small>${new Date(i.created_at).toLocaleString()}</small>
 `;
 incidentsDiv.appendChild(el);
 });
}

function subscribeRealtime(){
 db.channel("status-live")
 .on("postgres_changes", { event:"*", schema:"public", table:"status_components" }, () => loadComponents())
 .on("postgres_changes", { event:"*", schema:"public", table:"status_incidents" }, () => loadIncidents())
 .subscribe();
}

loadComponents();
loadIncidents();
subscribeRealtime();
</script>

</body>
</html>
