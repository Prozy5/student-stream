<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
--bg1:#070b1a;
--bg2:#0c1b3a;
--card:#0f2450;
--border:#1b3b7a;
--ok:#16c784;
--deg:#facc15;
--down:#ef4444;
}

*{box-sizing:border-box}
body{
margin:0;
font-family:system-ui,-apple-system,Segoe UI,Roboto;
background:radial-gradient(circle at top,var(--bg2),var(--bg1));
color:#eaf1ff;
}

.container{
max-width:1000px;
margin:auto;
padding:30px 20px 80px;
}

header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:30px;
}

h1{margin:0;font-size:28px}

.badge{
padding:6px 14px;
border-radius:999px;
font-size:13px;
font-weight:600;
}

.ok{background:var(--ok);color:#003b26}
.deg{background:var(--deg);color:#3b2f00}
.down{background:var(--down);color:#3b0000}

.section{margin-top:35px}
.section h2{margin-bottom:12px}

.card{
background:linear-gradient(180deg,#0f2450,#0a1633);
border:1px solid var(--border);
border-radius:14px;
padding:16px 18px;
margin-bottom:12px;
display:flex;
justify-content:space-between;
align-items:center;
animation:fade .3s ease;
}

@keyframes fade{from{opacity:0;transform:translateY(5px)}to{opacity:1}}

.name{font-weight:600}
.time{font-size:12px;color:#9fb4ff}

.pulse{
animation:pulse 2s infinite;
}
@keyframes pulse{
0%{box-shadow:0 0 0 0 rgba(22,199,132,.6)}
70%{box-shadow:0 0 0 12px rgba(22,199,132,0)}
100%{box-shadow:0 0 0 0 rgba(22,199,132,0)}
}

.incident{background:#2a0f16;border-color:#7a1b2d}

footer{
margin-top:50px;
text-align:center;
font-size:13px;
color:#7f94c9;
}

.loading{text-align:center;color:#9fb4ff;margin-top:20px}
</style>
</head>
<body>

<div class="container">

<header>
<h1>StudentStream Status</h1>
<span id="overall" class="badge ok pulse">Operational</span>
</header>

<div class="section">
<h2>Components</h2>
<div id="components" class="loading">Loadingâ€¦</div>
</div>

<div class="section">
<h2>Incidents</h2>
<div id="incidents" class="loading">Loadingâ€¦</div>
</div>

<footer>
Live status â€¢ Powered by Supabase Realtime â€¢ StudentStream Â© 2026
</footer>

</div>

<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function badgeClass(s){
if(s==="operational") return "ok";
if(s==="degraded") return "deg";
return "down";
}

async function loadComponents(){
const { data } = await supabase
.from("status_components")
.select("*")
.order("created_at",{ascending:false});

const map = {};
data.forEach(r=>{
if(!map[r.name]) map[r.name]=r;
});

const list = Object.values(map);
const el = document.getElementById("components");
el.innerHTML="";

let overall="operational";

list.forEach(c=>{
if(c.status==="outage") overall="outage";
else if(c.status==="degraded" && overall==="operational") overall="degraded";

const card=document.createElement("div");
card.className="card";
card.innerHTML=`
<div>
<div class="name">${c.name}</div>
<div class="time">${new Date(c.created_at).toLocaleString()}</div>
</div>
<span class="badge ${badgeClass(c.status)}">${c.status}</span>
`;
el.appendChild(card);
});

const badge=document.getElementById("overall");
badge.className="badge pulse "+badgeClass(overall);
badge.textContent=overall.charAt(0).toUpperCase()+overall.slice(1);
}

async function loadIncidents(){
const el=document.getElementById("incidents");

const { data, error } = await supabase
.from("status_incidents")
.select("*")
.order("created_at",{ascending:false})
.limit(5);

if(error || !data.length){
el.textContent="No active incidents ðŸŽ‰";
return;
}

el.innerHTML="";
data.forEach(i=>{
const card=document.createElement("div");
card.className="card incident";
card.innerHTML=`
<div>
<div class="name">${i.title}</div>
<div class="time">${i.description||""}</div>
</div>
<span class="badge down">${i.status}</span>
`;
el.appendChild(card);
});
}

async function refresh(){
await loadComponents();
await loadIncidents();
}

refresh();

/* Realtime subscriptions */

supabase.channel("status-live")
.on("postgres_changes",{event:"*",schema:"public",table:"status_components"},refresh)
.on("postgres_changes",{event:"*",schema:"public",table:"status_incidents"},refresh)
.subscribe();

/* Backup refresh every 60s */
setInterval(refresh,60000);
</script>

</body>
</html>
