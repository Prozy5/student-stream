<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream Status</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: system-ui; background:#0f172a; color:#e5e7eb; padding:30px }
.card { background:#111827; padding:20px; border-radius:10px; margin-bottom:20px }
.comp { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #1f2933 }
.ok { color:#22c55e } .down { color:#ef4444 } .deg { color:#f59e0b }
</style>
</head>
<body>

<h1>StudentStream Status</h1>
<div id="overall" class="card">Loading system status...</div>

<div class="card">
<h2>System Components</h2>
<div id="components">Loading...</div>
</div>

<div class="card">
<h2>Incidents</h2>
<div id="incidents">Loading...</div>
</div>

<script>
const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const SUPABASE_KEY = "sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function badge(status){
if(status==="operational") return "<span class='ok'>Operational</span>";
if(status==="degraded") return "<span class='deg'>Degraded</span>";
return "<span class='down'>Down</span>";
}

async function loadAll(){
try {

// Components
const { data: comps, error: cErr } = await supabase
.from("status_components")
.select("*")
.order("order_index");

if(cErr) throw cErr;

let worst = "operational";
let html = "";

comps.forEach(c=>{
if(c.status==="down") worst="down";
else if(c.status==="degraded" && worst!=="down") worst="degraded";

html += `<div class="comp"><b>${c.name}</b>${badge(c.status)}</div>`;
});

document.getElementById("components").innerHTML = html || "No components";

document.getElementById("overall").innerHTML =
worst==="operational" ? "üü¢ All systems operational" :
worst==="degraded" ? "üü° Partial outage" :
"üî¥ Major outage";

// Incidents
const { data: inc } = await supabase
.from("status_incidents")
.select("*")
.order("created_at",{ascending:false})
.limit(5);

let ih = "No incidents";
if(inc && inc.length){
ih = inc.map(i=>`<div>‚ö†Ô∏è ${i.title}</div>`).join("");
}
document.getElementById("incidents").innerHTML = ih;

} catch(err){
document.body.innerHTML = `<pre style="color:red">${err.message}</pre>`;
}
}

loadAll();

// realtime updates
supabase.channel("status-live")
.on("postgres_changes",{event:"*",schema:"public"},()=>loadAll())
.subscribe();

// auto refresh backup
setInterval(loadAll, 30000);
</script>

</body>
</html>
