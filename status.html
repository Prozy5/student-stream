<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>StudentStream Status â€” V3.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
      font-family: Inter, system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: #070b12;
      color: white;
    }

    header {
      padding: 22px 26px;
      border-bottom: 1px solid #1c2533;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 20px;
      font-weight: 900;
      color: #4da3ff;
    }

    .sub {
      font-size: 14px;
      opacity: 0.6;
    }

    .container {
      max-width: 1150px;
      margin: 40px auto;
      padding: 0 24px;
    }

    /* OVERALL STATUS */
    .overall {
      background: #0e1522;
      border: 1px solid #1f2a3a;
      border-radius: 16px;
      padding: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .overall b {
      font-size: 18px;
    }

    .pill {
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
    }

    .pill.good {
      background: rgba(60,255,122,0.15);
      color: #3cff7a;
    }

    .pill.warn {
      background: rgba(255,184,77,0.15);
      color: #ffb84d;
    }

    .pill.bad {
      background: rgba(255,77,77,0.15);
      color: #ff4d4d;
    }

    /* MAINTENANCE */
    .maintenance-box {
      background: rgba(255,184,77,0.12);
      border: 1px solid rgba(255,184,77,0.25);
      padding: 18px;
      border-radius: 14px;
      margin-bottom: 25px;
      display: none;
    }

    .maintenance-box b {
      color: #ffb84d;
    }

    /* INCIDENTS */
    .incidents {
      margin-bottom: 35px;
    }

    .incident-card {
      background: rgba(255,77,77,0.08);
      border: 1px solid rgba(255,77,77,0.25);
      padding: 18px;
      border-radius: 14px;
      margin-top: 12px;
    }

    .incident-card small {
      opacity: 0.7;
      display: block;
      margin-top: 6px;
    }

    /* SERVICES GRID */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .card {
      background: #0e1522;
      border: 1px solid #1f2a3a;
      border-radius: 16px;
      padding: 18px;
    }

    .card b {
      font-size: 16px;
      display: block;
      margin-bottom: 10px;
    }

    .service {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 9px 0;
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .service:last-child {
      border-bottom: none;
    }

    .dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 7px;
    }

    .operational { background: #3cff7a; }
    .degraded { background: #ffb84d; }
    .down { background: #ff4d4d; }
    .maintenance { background: #4da3ff; }

    footer {
      margin-top: 70px;
      border-top: 1px solid #1c2533;
      padding: 35px;
      text-align: center;
      font-size: 13px;
      opacity: 0.55;
    }
  </style>
</head>

<body>

<header>
  <div class="logo">StudentStream Status</div>
  <div class="sub">System Health â€¢ Live Updates</div>
</header>

<div class="container">

  <!-- OVERALL STATUS -->
  <div class="overall">
    <div>
      <b id="overallText">Loading system health...</b>
      <div class="sub">Real-time platform availability</div>
    </div>
    <div id="overallPill" class="pill good">Checking...</div>
  </div>

  <!-- MAINTENANCE -->
  <div class="maintenance-box" id="maintenanceBox">
    <b>Scheduled Maintenance:</b>
    <span id="maintenanceText"></span>
  </div>

  <!-- INCIDENTS -->
  <div class="incidents">
    <h2 style="margin:0;font-size:18px;">Active Incidents</h2>
    <div id="incidentList" class="sub">Loading...</div>
  </div>

  <!-- SERVICES -->
  <h2 style="margin:0;font-size:18px;">Service Status</h2>
  <p class="sub">Divisions across StudentStreamHQ infrastructure</p>

  <div class="grid" id="servicesGrid"></div>

</div>

<footer>
  Â© 2026 StudentStreamHQ â€¢ Status Page V3.0 â€¢ Infrastructure Monitoring
</footer>

<!-- SUPABASE -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://iabzmoxzbqzcqgypxctr.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
  );

  const overallText = document.getElementById("overallText");
  const overallPill = document.getElementById("overallPill");

  const servicesGrid = document.getElementById("servicesGrid");
  const incidentList = document.getElementById("incidentList");

  const maintenanceBox = document.getElementById("maintenanceBox");
  const maintenanceText = document.getElementById("maintenanceText");

  // ===============================
  // LOAD STATUS SERVICES
  // ===============================
  async function loadServices() {
    const { data, error } = await supabase
      .from("status_services")
      .select("*")
      .order("division");

    if (error) {
      overallText.textContent = "Unable to load services.";
      return;
    }

    renderServices(data);
  }

  function renderServices(rows) {
    servicesGrid.innerHTML = "";

    let hasDown = false;
    let hasDegraded = false;

    const grouped = {};

    rows.forEach((s) => {
      if (!grouped[s.division]) grouped[s.division] = [];
      grouped[s.division].push(s);

      if (s.current_status === "down") hasDown = true;
      if (s.current_status === "degraded") hasDegraded = true;
    });

    // OVERALL SYSTEM
    if (hasDown) {
      overallText.textContent = "Major System Outage";
      overallPill.className = "pill bad";
      overallPill.textContent = "Outage";
    } else if (hasDegraded) {
      overallText.textContent = "Partial Service Disruption";
      overallPill.className = "pill warn";
      overallPill.textContent = "Degraded";
    } else {
      overallText.textContent = "All Systems Operational";
      overallPill.className = "pill good";
      overallPill.textContent = "Operational";
    }

    // BUILD CARDS
    Object.entries(grouped).forEach(([division, services]) => {
      const card = document.createElement("div");
      card.className = "card";

      let html = `<b>${division}</b>`;

      services.forEach((s) => {
        html += `
          <div class="service">
            <span>
              <span class="dot ${s.current_status}"></span>
              ${s.service_name}
            </span>
            <span style="opacity:.75">${s.current_status}</span>
          </div>
        `;
      });

      card.innerHTML = html;
      servicesGrid.appendChild(card);
    });
  }

  // ===============================
  // LOAD INCIDENTS
  // ===============================
  async function loadIncidents() {
    const { data, error } = await supabase
      .from("status_incidents")
      .select("*")
      .neq("status", "resolved")
      .order("created_at", { ascending: false });

    if (error) {
      incidentList.textContent = "Unable to load incidents.";
      return;
    }

    if (!data.length) {
      incidentList.textContent = "No active incidents ðŸŽ‰";
      return;
    }

    incidentList.innerHTML = "";

    data.forEach((i) => {
      const div = document.createElement("div");
      div.className = "incident-card";

      div.innerHTML = `
        <b>${i.title}</b>
        <p style="margin:8px 0;opacity:.8">${i.description}</p>
        <small>Status: ${i.status} â€¢ Severity: ${i.severity}</small>
      `;

      incidentList.appendChild(div);
    });
  }

  // ===============================
  // LOAD MAINTENANCE
  // ===============================
  async function loadMaintenance() {
    const { data } = await supabase
      .from("status_maintenance")
      .select("*")
      .eq("active", true)
      .order("scheduled_start");

    if (!data || !data.length) {
      maintenanceBox.style.display = "none";
      return;
    }

    const m = data[0];

    maintenanceBox.style.display = "block";
    maintenanceText.textContent =
      `${m.title} (Starts: ${new Date(m.scheduled_start).toLocaleString()})`;
  }

  // ===============================
  // INIT LOAD
  // ===============================
  async function refreshAll() {
    await loadServices();
    await loadIncidents();
    await loadMaintenance();
  }

  refreshAll();

  // Auto refresh every 20 seconds
  setInterval(refreshAll, 20000);
</script>

</body>
</html>