<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudentStream Status</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0e14;color:#e5e7eb}
.container{max-width:1000px;margin:auto;padding:30px}
header{display:flex;justify-content:space-between;align-items:center}
h1{margin:0}
.badge{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600}
.operational{background:#16a34a}
.degraded{background:#f59e0b}
.down{background:#dc2626}
.maintenance{background:#6366f1}
.card{background:#111827;padding:16px;border-radius:12px;margin-top:12px}
.flex{display:flex;gap:10px;align-items:center}
select,input,textarea,button{
background:#1f2933;color:white;border:1px solid #333;padding:8px;border-radius:6px
}
button{cursor:pointer}
.admin{border-top:1px solid #333;margin-top:40px;padding-top:20px}
.hidden{display:none}
.small{font-size:12px;color:#9ca3af}
.incident-update{margin-left:15px;border-left:2px solid #333;padding-left:10px;margin-top:6px}
</style>
</head>

<body>
<div class="container">

<header>
<h1>StudentStream System Status</h1>
<span id="overallBadge" class="badge operational">Operational</span>
</header>

<h2>Components</h2>
<div id="components"></div>

<h2>Incidents</h2>
<div id="incidents"></div>

<div id="adminPanel" class="admin hidden">
<h2>Admin Panel</h2>

<h3>Add Component</h3>
<input id="newComponent" placeholder="Component name">
<button onclick="addComponent()">Add</button>

<h3>Create Incident</h3>
<input id="incTitle" placeholder="Title"><br><br>
<textarea id="incDesc" placeholder="Description"></textarea><br><br>
<select id="incSeverity">
<option>minor</option>
<option>major</option>
<option>critical</option>
</select>
<button onclick="createIncident()">Create</button>

</div>

</div>

<script>
const OWNER_UID = "0801d47e-6bc7-4916-bf0a-e2de667d21ea";

const supabase = window.supabase.createClient(
"https://iabzmoxzbqzcqgypxctr.supabase.co",
"sb_publishable_ipn8wnT_TIvaT6r44j8YBw_t5oMhOPC"
);

async function init(){
await supabase.auth.signInAnonymously();
checkAdmin();
loadAll();
realtime();
}

async function checkAdmin(){
const {data} = await supabase.auth.getUser();
if(data.user?.id === OWNER_UID){
document.getElementById("adminPanel").classList.remove("hidden");
}
}

async function loadAll(){
loadComponents();
loadIncidents();
}

async function loadComponents(){
const {data} = await supabase.from("status_components").select("*");
const el = document.getElementById("components");
el.innerHTML = "";
let worst = "operational";

data.forEach(c=>{
if(c.status==="down") worst="down";
else if(c.status==="degraded" && worst!=="down") worst="degraded";

el.innerHTML += `
<div class="card flex">
<strong>${c.name}</strong>
<span class="badge ${c.status}">${c.status}</span>
${adminControls(c)}
</div>`;
});

updateOverall(worst);
}

function updateOverall(status){
const badge = document.getElementById("overallBadge");
badge.className = "badge "+status;
badge.innerText = status.toUpperCase();
}

function adminControls(c){
if(!document.getElementById("adminPanel").classList.contains("hidden")){
return `
<select onchange="updateComponent(${c.id},this.value)">
<option ${c.status==="operational"?"selected":""}>operational</option>
<option ${c.status==="degraded"?"selected":""}>degraded</option>
<option ${c.status==="down"?"selected":""}>down</option>
<option ${c.status==="maintenance"?"selected":""}>maintenance</option>
</select>`;
}
return "";
}

async function updateComponent(id,status){
await supabase.from("status_components").update({status}).eq("id",id);
}

async function addComponent(){
const name = newComponent.value;
if(!name) return;
await supabase.from("status_components").insert({name});
newComponent.value="";
}

async function loadIncidents(){
const {data} = await supabase
.from("status_incidents")
.select("*, status_updates(*)")
.order("created_at",{ascending:false});

const el = document.getElementById("incidents");
el.innerHTML="";

data.forEach(i=>{
let updatesHTML = "";
i.status_updates.forEach(u=>{
updatesHTML+=`<div class="incident-update small">${u.message}</div>`;
});

el.innerHTML+=`
<div class="card">
<strong>${i.title}</strong> (${i.severity})<br>
${i.description}<br>
<span class="small">Status: ${i.status}</span>
${updatesHTML}
${incidentAdmin(i)}
</div>`;
});
}

function incidentAdmin(i){
if(!document.getElementById("adminPanel").classList.contains("hidden")){
return `
<br>
<input placeholder="Update message" id="upd${i.id}">
<button onclick="addUpdate(${i.id})">Add update</button>
<button onclick="resolveIncident(${i.id})">Resolve</button>
`;
}
return "";
}

async function addUpdate(id){
const msg = document.getElementById("upd"+id).value;
if(!msg) return;
await supabase.from("status_updates").insert({incident_id:id,message:msg});
}

async function resolveIncident(id){
await supabase.from("status_incidents").update({
status:"resolved",
resolved_at:new Date()
}).eq("id",id);
}

async function createIncident(){
await supabase.from("status_incidents").insert({
title:incTitle.value,
description:incDesc.value,
severity:incSeverity.value,
status:"investigating"
});
}

function realtime(){
supabase.channel("status")
.on("postgres_changes",{event:"*",schema:"public",table:"status_components"},loadComponents)
.on("postgres_changes",{event:"*",schema:"public",table:"status_incidents"},loadIncidents)
.on("postgres_changes",{event:"*",schema:"public",table:"status_updates"},loadIncidents)
.subscribe();
}

init();
</script>

</body>
</html>
