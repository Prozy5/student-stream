<!DOCTYPE html>
<html>
<head>
<title>Case File</title>
<script type="module">
import { supabase } from './supabase.js';

const url = new URLSearchParams(window.location.search);
const caseId = url.get("id");

async function loadCase(){
  const { data:caseData } = await supabase.from("cases").select("*").eq("id",caseId).single();
  document.getElementById("title").innerText = caseData.title;
  document.getElementById("status").value = caseData.status;

  const { data:notes } = await supabase.from("case_notes").select("*").eq("case_id",caseId).single();
  if(notes) document.getElementById("notes").value = notes.content;

  loadUpdates();
}

async function saveNotes(){
  await supabase.from("case_notes").upsert({
    case_id:caseId,
    content:document.getElementById("notes").value
  });
  alert("Notes saved");
}

async function updateStatus(){
  await supabase.from("cases").update({
    status:document.getElementById("status").value
  }).eq("id",caseId);
  alert("Status updated");
}

async function postUpdate(){
  const txt = document.getElementById("updateText").value;
  if(!txt) return;

  await supabase.from("case_updates").insert({
    case_id:caseId,
    content:txt
  });

  document.getElementById("updateText").value="";
  loadUpdates();
}

async function loadUpdates(){
  const { data } = await supabase.from("case_updates")
    .select("*").eq("case_id",caseId).order("created_at",{ascending:false});

  const box = document.getElementById("updates");
  box.innerHTML="";
  data.forEach(u=>{
    const div=document.createElement("div");
    div.className="update";
    div.innerHTML=`<small>${new Date(u.created_at).toLocaleString()}</small><br>${u.content}`;
    box.appendChild(div);
  });
}

window.onload = loadCase;
window.saveNotes = saveNotes;
window.updateStatus = updateStatus;
window.postUpdate = postUpdate;
</script>

<style>
body{background:#070b12;color:#9cc3ff;font-family:arial}
.box{background:#0c1626;padding:15px;border-radius:10px;margin-bottom:20px}
textarea,select,button{width:100%;padding:10px;margin-top:10px;background:#111d33;color:white;border:none}
.update{border-bottom:1px solid #1a2b45;padding:10px 0}
</style>
</head>
<body>

<a href="cases.html">‚Üê Back to cases</a>

<h1 id="title"></h1>

<div class="box">
<h3>Case Notes</h3>
<textarea id="notes"></textarea>
<button onclick="saveNotes()">Save Notes</button>
</div>

<div class="box">
<h3>Status</h3>
<select id="status">
<option>Open</option>
<option>Active</option>
<option>Closed</option>
</select>
<button onclick="updateStatus()">Update Status</button>
</div>

<div class="box">
<h3>Add Update</h3>
<textarea id="updateText"></textarea>
<button onclick="postUpdate()">Submit</button>
</div>

<div class="box">
<h3>Timeline</h3>
<div id="updates"></div>
</div>

</body>
</html>