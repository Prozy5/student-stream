<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Payouts | Studios Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex,nofollow" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#070A12;
  --panel:rgba(14,20,36,0.82);
  --text:#EAF0FF;
  --muted:#A9B4D0;
  --line:rgba(255,255,255,0.10);

  --accent:#5DA8FF;
  --accent2:#7C5CFF;

  --good:#31D18B;
  --warn:#FFD35A;
  --bad:#FF5C7A;

  --radius:18px;
}

*{
  box-sizing:border-box;
  font-family:Inter,system-ui,Arial,sans-serif;
  margin:0;
  padding:0;
}

body{
  background:
    radial-gradient(circle at top, rgba(93,168,255,0.15), transparent 55%),
    radial-gradient(circle at right, rgba(124,92,255,0.10), transparent 55%),
    var(--bg);
  color:var(--text);
}

.container{
  max-width:1200px;
  margin:auto;
  padding:70px 20px;
}

.badge{
  display:inline-block;
  background:rgba(255,82,82,.14);
  border:1px solid rgba(255,82,82,.35);
  color:var(--bad);
  padding:7px 18px;
  border-radius:999px;
  font-size:.82rem;
  margin-bottom:16px;
}

h1{
  font-size:2.9rem;
  margin-bottom:10px;
  font-weight:900;
}

p{
  color:var(--muted);
  max-width:720px;
  line-height:1.5;
  margin-bottom:24px;
}

/* KPI ROW */
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
  margin-top:20px;
}

.kpi{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:16px;
  backdrop-filter:blur(14px);
}

.kpi span{
  font-size:12px;
  color:var(--muted);
}

.kpi b{
  display:block;
  margin-top:6px;
  font-size:20px;
  font-weight:900;
  color:var(--accent);
}

/* SEARCH + FILTER */
.controls{
  margin-top:26px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

input{
  flex:1;
  min-width:220px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,0.03);
  color:var(--text);
  outline:none;
}

input:focus{
  border-color:rgba(93,168,255,0.45);
  box-shadow:0 0 0 4px rgba(93,168,255,0.14);
}

.toggle{
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--line);
  cursor:pointer;
  background:rgba(255,255,255,0.04);
  color:var(--muted);
  font-weight:700;
}

.toggle.active{
  color:white;
  border-color:rgba(93,168,255,0.35);
}

/* TABLE */
.tableWrap{
  margin-top:26px;
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:var(--radius);
  overflow:hidden;
  backdrop-filter:blur(14px);
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  text-align:left;
  font-size:.92rem;
}

th{
  color:var(--muted);
  font-weight:700;
  background:rgba(255,255,255,0.02);
}

.amount{
  font-weight:900;
  color:var(--good);
}

/* STATUS BADGES */
.status{
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  display:inline-block;
}

.status.unpaid{
  background:rgba(255,211,90,0.12);
  border:1px solid rgba(255,211,90,0.25);
  color:var(--warn);
}

.status.paid{
  background:rgba(49,209,139,0.12);
  border:1px solid rgba(49,209,139,0.25);
  color:var(--good);
}

/* BUTTON */
button{
  padding:9px 16px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-size:.85rem;
  font-weight:800;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:white;
  transition:.2s;
}

button:hover{
  transform:translateY(-2px);
  opacity:.95;
}

/* LOADING SKELETON */
.skeleton{
  height:16px;
  width:100%;
  border-radius:8px;
  background:rgba(255,255,255,0.06);
  animation:pulse 1.2s infinite;
}

@keyframes pulse{
  0%{opacity:.4;}
  50%{opacity:1;}
  100%{opacity:.4;}
}

.empty{
  padding:20px;
  text-align:center;
  color:var(--muted);
  font-weight:800;
}
</style>
</head>

<body>
<div class="container">

<span class="badge">Admin Â· Payouts</span>
<h1>Creator Payouts</h1>
<p>
Unpaid creator earnings from Studios sales. Mark payouts after sending funds manually.
Stripe automation will be added soon.
</p>

<!-- KPI SUMMARY -->
<div class="kpis">
  <div class="kpi">
    <span>Total Unpaid Sales</span>
    <b id="kpiCount">â€”</b>
  </div>

  <div class="kpi">
    <span>Total Creator Owed</span>
    <b id="kpiOwed">$0.00</b>
  </div>

  <div class="kpi">
    <span>Payout Mode</span>
    <b style="color:var(--warn)">MANUAL</b>
  </div>
</div>

<!-- SEARCH + FILTER -->
<div class="controls">
  <input id="searchBox" placeholder="Search creator or assetâ€¦" />
  <div class="toggle active" id="filterToggle">Unpaid Only</div>
</div>

<!-- TABLE -->
<div class="tableWrap">
<table>
<thead>
<tr>
  <th>Creator</th>
  <th>Asset</th>
  <th>Total Sale</th>
  <th>Creator Owed</th>
  <th>Status</th>
  <th>Action</th>
</tr>
</thead>

<tbody id="payoutTable">
<tr>
  <td colspan="6">
    <div class="skeleton"></div>
  </td>
</tr>
</tbody>
</table>
</div>

</div>

<script>
const supabase = supabaseJs.createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

function money(cents){
  return "$" + (cents / 100).toFixed(2);
}

let payouts = [];
let unpaidOnly = true;

(async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return window.location.href = "/studios/login.html";

  // Admin check
  const { data: admin } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();

  if (admin?.role !== "admin") {
    document.body.innerHTML = "<p style='padding:40px;'>Unauthorized</p>";
    return;
  }

  loadPayouts();
})();

async function loadPayouts(){
  const { data: sales } = await supabase
    .from("studio_sales")
    .select("*")
    .order("created_at", { ascending: false });

  payouts = sales || [];
  renderTable();
}

function renderTable(){
  const table = document.getElementById("payoutTable");
  const search = document.getElementById("searchBox").value.toLowerCase();

  let filtered = payouts;

  if(unpaidOnly){
    filtered = filtered.filter(p => p.paid === false);
  }

  if(search){
    filtered = filtered.filter(p =>
      p.creator_name.toLowerCase().includes(search) ||
      p.asset_title.toLowerCase().includes(search)
    );
  }

  // KPI Update
  document.getElementById("kpiCount").textContent = filtered.length;

  const totalOwed = filtered.reduce((sum,p)=>sum+p.creator_earn_cents,0);
  document.getElementById("kpiOwed").textContent = money(totalOwed);

  if(filtered.length === 0){
    table.innerHTML = `<tr><td colspan="6" class="empty">No payouts found ðŸŽ‰</td></tr>`;
    return;
  }

  table.innerHTML = filtered.map(s => `
    <tr>
      <td>${s.creator_name}</td>
      <td>${s.asset_title}</td>
      <td>${money(s.amount_cents)}</td>
      <td class="amount">${money(s.creator_earn_cents)}</td>
      <td>
        <span class="status ${s.paid ? "paid":"unpaid"}">
          ${s.paid ? "PAID" : "UNPAID"}
        </span>
      </td>
      <td>
        ${s.paid 
          ? "â€”"
          : `<button onclick="markPaid('${s.id}')">Mark Paid</button>`
        }
      </td>
    </tr>
  `).join("");
}

async function markPaid(id){
  if (!confirm("Confirm payout has been sent manually?")) return;

  const { error } = await supabase
    .from("studio_sales")
    .update({
      paid: true,
      paid_at: new Date().toISOString()
    })
    .eq("id", id);

  if (error) {
    alert(error.message);
    return;
  }

  loadPayouts();
}

/* LIVE SEARCH */
document.getElementById("searchBox").addEventListener("input", renderTable);

/* FILTER TOGGLE */
document.getElementById("filterToggle").onclick = () => {
  unpaidOnly = !unpaidOnly;
  document.getElementById("filterToggle").classList.toggle("active");
  document.getElementById("filterToggle").textContent =
    unpaidOnly ? "Unpaid Only" : "Showing All";
  renderTable();
};
</script>

</body>
</html>