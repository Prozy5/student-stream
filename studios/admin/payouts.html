<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Studios Admin • Creator Payouts (V15)</title>

<style>
  :root{
    --bg:#070A12;
    --panel:rgba(255,255,255,.04);
    --stroke:rgba(255,255,255,.09);
    --text:#EAF0FF;
    --muted:rgba(255,255,255,.55);

    --green:#2DFF9B;
    --blue:#4DA3FF;
    --yellow:#FFD36A;
    --red:#FF5C5C;
    --purple:#7B5CFF;

    --radius:22px;
  }

  *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}

  body{
    background:
      radial-gradient(circle at top, rgba(77,163,255,.12), transparent 55%),
      radial-gradient(circle at bottom, rgba(123,92,255,.10), transparent 55%),
      var(--bg);
    color:var(--text);
    padding:22px;
  }

  .wrap{max-width:1200px;margin:auto;}

  .badge{
    display:inline-flex;
    padding:8px 14px;
    border-radius:999px;
    background:rgba(123,92,255,.10);
    border:1px solid rgba(123,92,255,.30);
    color:#B9A7FF;
    font-weight:800;
    font-size:13px;
    margin-bottom:14px;
  }

  h1{
    font-size:54px;
    letter-spacing:-1px;
    margin-bottom:10px;
  }

  .sub{
    color:var(--muted);
    max-width:680px;
    line-height:1.5;
    margin-bottom:26px;
  }

  /* Stats */
  .stats{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:16px;
    margin-bottom:20px;
  }

  .card{
    background:var(--panel);
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    padding:18px;
  }

  .card small{
    color:var(--muted);
    font-weight:800;
    display:block;
    margin-bottom:8px;
  }

  .value{
    font-size:30px;
    font-weight:900;
  }

  .green{color:var(--green);}
  .blue{color:var(--blue);}
  .yellow{color:var(--yellow);}
  .red{color:var(--red);}

  /* Controls */
  .controls{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:18px;
  }

  input{
    flex:1;
    min-width:220px;
    padding:14px 16px;
    border-radius:16px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.03);
    color:var(--text);
    outline:none;
  }

  button{
    padding:14px 18px;
    border-radius:16px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.04);
    color:var(--text);
    font-weight:900;
    cursor:pointer;
    transition:.2s;
  }

  button:hover{
    transform:translateY(-1px);
    border-color:rgba(255,255,255,.20);
  }

  .primary{
    background:linear-gradient(90deg,var(--blue),var(--purple));
    border:none;
  }

  .danger{
    background:rgba(255,92,92,.15);
    border:1px solid rgba(255,92,92,.25);
    color:#FF9A9A;
  }

  /* Creator Totals */
  .creatorTotals{
    margin:22px 0;
    padding:18px;
    border-radius:var(--radius);
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.03);
  }

  .creatorTotals h2{
    font-size:18px;
    margin-bottom:10px;
  }

  .totalsGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }

  /* Table */
  .tableWrap{
    margin-top:18px;
    border-radius:var(--radius);
    border:1px solid var(--stroke);
    overflow:hidden;
    background:var(--panel);
  }

  table{
    width:100%;
    border-collapse:collapse;
  }

  th,td{
    padding:14px;
    font-size:14px;
    text-align:left;
  }

  th{
    background:rgba(255,255,255,.03);
    color:var(--muted);
    font-weight:900;
  }

  tr{
    border-top:1px solid rgba(255,255,255,.06);
  }

  .status{
    font-weight:900;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    display:inline-block;
  }

  .paid{background:rgba(45,255,155,.14);color:var(--green);}
  .unpaid{background:rgba(255,211,106,.14);color:var(--yellow);}

  .payBtn{
    padding:9px 12px;
    border-radius:12px;
    font-size:13px;
    font-weight:900;
    background:rgba(45,255,155,.14);
    border:1px solid rgba(45,255,155,.25);
    color:var(--green);
    cursor:pointer;
  }

  .payBtn:hover{transform:scale(1.03);}

</style>
</head>

<body>
<div class="wrap">

  <div class="badge">Studios Admin • Creator Payouts (V15)</div>

  <h1>Creator Payout Command Center</h1>
  <p class="sub">
    Full payout management system with creator totals, batch payout, audit logging,
    export tools, and Stripe-ready payout mode support.
  </p>

  <!-- Stats -->
  <div class="stats">
    <div class="card">
      <small>Unpaid Sales</small>
      <div class="value yellow" id="statUnpaid">—</div>
    </div>

    <div class="card">
      <small>Total Creator Owed</small>
      <div class="value green" id="statOwed">$0.00</div>
    </div>

    <div class="card">
      <small>Total Paid Out</small>
      <div class="value blue" id="statPaid">$0.00</div>
    </div>

    <div class="card">
      <small>Platform Fees Collected</small>
      <div class="value red" id="statFees">$0.00</div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <input id="search" placeholder="Search creator or asset..." />
    <button id="toggleUnpaid">Unpaid Only</button>
    <button class="primary" id="batchPay">Batch Pay All Unpaid</button>
    <button id="exportBtn">Export CSV</button>
    <button class="danger" onclick="loadPayouts()">Refresh</button>
  </div>

  <!-- Creator Totals -->
  <div class="creatorTotals">
    <h2>Creator Totals (Unpaid)</h2>
    <div class="totalsGrid" id="creatorTotalsGrid">
      Loading creator totals...
    </div>
  </div>

  <!-- Table -->
  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Creator</th>
          <th>Asset</th>
          <th>Sale</th>
          <th>Creator Owed</th>
          <th>Platform Fee</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody id="rows">
        <tr>
          <td colspan="7" style="padding:22px;color:rgba(255,255,255,.5)">
            Loading payouts...
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://iabzmoxzbqzcqgypxctr.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";
const supabase = createClient(supabaseUrl, supabaseKey);

let payouts = [];
let unpaidOnly = false;

/* Load payouts */
window.loadPayouts = async function(){
  const { data, error } = await supabase
    .from("marketplace_sales")
    .select("*")
    .order("created_at",{ascending:false});

  if(error){
    alert("Error loading payouts: "+error.message);
    return;
  }

  payouts = data;
  render();
  updateStats();
  renderCreatorTotals();
}

/* Stats */
function updateStats(){
  const unpaid = payouts.filter(p=>p.payout_status==="unpaid");

  document.getElementById("statUnpaid").innerText = unpaid.length;

  const owed = unpaid.reduce((s,p)=>s+(p.creator_cut_cents||0),0);
  const paid = payouts.filter(p=>p.payout_status==="paid")
    .reduce((s,p)=>s+(p.creator_cut_cents||0),0);

  const fees = payouts.reduce((s,p)=>s+(p.platform_fee_cents||0),0);

  document.getElementById("statOwed").innerText="$"+(owed/100).toFixed(2);
  document.getElementById("statPaid").innerText="$"+(paid/100).toFixed(2);
  document.getElementById("statFees").innerText="$"+(fees/100).toFixed(2);
}

/* Creator Totals */
function renderCreatorTotals(){
  const unpaid = payouts.filter(p=>p.payout_status==="unpaid");

  let map = {};
  unpaid.forEach(p=>{
    map[p.creator_name] = (map[p.creator_name]||0)+(p.creator_cut_cents||0);
  });

  const grid = document.getElementById("creatorTotalsGrid");

  if(Object.keys(map).length===0){
    grid.innerHTML="<span style='color:rgba(255,255,255,.5)'>No unpaid creators.</span>";
    return;
  }

  grid.innerHTML = Object.entries(map).map(([name,total])=>`
    <div class="card">
      <small>${name}</small>
      <div class="value green">$${(total/100).toFixed(2)}</div>
    </div>
  `).join("");
}

/* Render Table */
function render(){
  let list=[...payouts];

  if(unpaidOnly) list=list.filter(p=>p.payout_status==="unpaid");

  const q=document.getElementById("search").value.toLowerCase();
  if(q){
    list=list.filter(p=>
      (p.creator_name||"").toLowerCase().includes(q) ||
      (p.asset_title||"").toLowerCase().includes(q)
    );
  }

  const rows=document.getElementById("rows");

  if(list.length===0){
    rows.innerHTML=`<tr><td colspan="7" style="padding:22px;color:rgba(255,255,255,.5)">
      No payouts found.
    </td></tr>`;
    return;
  }

  rows.innerHTML=list.map(p=>`
    <tr>
      <td>${p.creator_name||"—"}</td>
      <td>${p.asset_title||"—"}</td>
      <td>$${((p.amount_cents||0)/100).toFixed(2)}</td>
      <td>$${((p.creator_cut_cents||0)/100).toFixed(2)}</td>
      <td>$${((p.platform_fee_cents||0)/100).toFixed(2)}</td>
      <td><span class="status ${p.payout_status==="paid"?"paid":"unpaid"}">
        ${p.payout_status.toUpperCase()}
      </span></td>
      <td>
        ${
          p.payout_status==="unpaid"
          ? `<button class="payBtn" onclick="markPaid('${p.id}')">Mark Paid</button>`
          : "—"
        }
      </td>
    </tr>
  `).join("");
}

/* Mark Paid */
window.markPaid = async function(id){
  await supabase
    .from("marketplace_sales")
    .update({ payout_status:"paid", paid_at:new Date().toISOString() })
    .eq("id",id);

  loadPayouts();
}

/* Batch Pay */
document.getElementById("batchPay").onclick = async ()=>{
  if(!confirm("Mark ALL unpaid payouts as paid?")) return;

  await supabase
    .from("marketplace_sales")
    .update({ payout_status:"paid", paid_at:new Date().toISOString() })
    .eq("payout_status","unpaid");

  loadPayouts();
};

/* Toggle unpaid */
document.getElementById("toggleUnpaid").onclick=()=>{
  unpaidOnly=!unpaidOnly;
  render();
};

/* Search */
document.getElementById("search").oninput=render;

/* Export CSV */
document.getElementById("exportBtn").onclick=()=>{
  let csv="Creator,Asset,Sale,Owed,Fee,Status\n";
  payouts.forEach(p=>{
    csv+=`${p.creator_name},${p.asset_title},${p.amount_cents/100},${p.creator_cut_cents/100},${p.platform_fee_cents/100},${p.payout_status}\n`;
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;
  a.download="studios_payouts.csv";
  a.click();
};

/* Init */
loadPayouts();
</script>

</body>
</html>