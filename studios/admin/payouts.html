<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Creator Payouts â€” Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#050507;color:#fff;font-family:Inter,system-ui;padding:30px}
h1{margin-bottom:6px}
p{opacity:.7}
table{width:100%;border-collapse:collapse;margin-top:30px}
th,td{padding:14px;border-bottom:1px solid rgba(255,255,255,.1)}
th{text-align:left;opacity:.6;font-size:.8rem}
button{
background:#6cf2c2;border:none;color:#050507;
padding:8px 14px;border-radius:999px;
font-weight:600;cursor:pointer
}
.badge{font-size:.7rem;padding:4px 10px;border-radius:999px}
.pending{background:rgba(255,193,7,.2);color:#ffc107}
</style>
</head>

<body>
<h1>Creator Payouts</h1>
<p>Unpaid creator earnings</p>

<table>
<thead>
<tr>
<th>Creator</th>
<th>Item</th>
<th>Date</th>
<th>Creator Cut</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="rows">
<tr><td colspan="6">Loadingâ€¦</td></tr>
</tbody>
</table>

<script>
const supabase = supabaseJs.createClient(
 "https://iabzmoxzbqzcqgypxctr.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

async function load(){
 const {data:{user}} = await supabase.auth.getUser();
 if(!user){location.href="/studios/login";return;}

 const {data:profile} = await supabase
  .from("profiles")
  .select("role")
  .eq("id",user.id)
  .single();

 if(profile?.role!=="admin"){
  location.href="/studios";
  return;
 }

 const {data:sales} = await supabase
  .from("marketplace_sales")
  .select(`
    id,
    title,
    creator_cut,
    status,
    created_at,
    profiles:creator_id (username)
  `)
  .eq("status","pending")
  .order("created_at",{ascending:true});

 const tbody=document.getElementById("rows");
 if(!sales?.length){
  tbody.innerHTML=`<tr><td colspan="6">All payouts complete ðŸŽ‰</td></tr>`;
  return;
 }

 tbody.innerHTML=sales.map(s=>`
  <tr>
    <td>@${s.profiles?.username||"unknown"}</td>
    <td>${s.title||"Untitled"}</td>
    <td>${new Date(s.created_at).toLocaleDateString()}</td>
    <td>$${Number(s.creator_cut).toFixed(2)}</td>
    <td><span class="badge pending">pending</span></td>
    <td>
      <button onclick="markPaid('${s.id}')">Mark Paid</button>
    </td>
  </tr>
 `).join("");
}

async function markPaid(id){
 if(!confirm("Confirm payout completed?")) return;

 const {error} = await supabase
  .from("marketplace_sales")
  .update({
    status:"paid",
    paid_at:new Date().toISOString()
  })
  .eq("id",id);

 if(error){
  alert("Error updating payout");
  return;
 }
 load();
}

load();
</script>
</body>
</html>