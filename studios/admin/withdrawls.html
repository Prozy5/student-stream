<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================
       STUDENTSTREAM HQ — ADMIN WITHDRAWALS
       withdrawals.html (V30 UPGRADE)
       ========================================= -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Withdrawal Requests • StudentStream Admin</title>

  <style>
    :root{
      --bg:#070A12;
      --panel:#0E1424;
      --text:#EAF0FF;
      --muted:#A9B4D0;
      --line:rgba(255,255,255,0.08);
      --glow:rgba(120,180,255,0.22);
      --good:#31D18B;
      --warn:#FFD35A;
      --bad:#FF5C7A;
      --accent:#5DA8FF;
      --radius:18px;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:system-ui,Segoe UI,Roboto;
      background:
        radial-gradient(circle at top, rgba(93,168,255,0.14), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{
      max-width:1150px;
      margin:auto;
      padding:30px 18px 80px;
    }

    h1{
      font-size:32px;
      margin-bottom:6px;
    }

    p{
      color:var(--muted);
      margin-bottom:20px;
      line-height:1.4;
    }

    .panel{
      background:rgba(14,20,36,0.75);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      backdrop-filter:blur(14px);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
    }

    .btn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      transition:0.2s;
      text-decoration:none;
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 0 0 4px var(--glow);
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }

    th,td{
      padding:12px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:14px;
    }

    th{
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:1px;
    }

    .status{
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      display:inline-block;
    }

    .pending{background:rgba(255,211,90,0.15);color:var(--warn);}
    .approved{background:rgba(49,209,139,0.15);color:var(--good);}
    .denied{background:rgba(255,92,122,0.15);color:var(--bad);}
    .paid{background:rgba(93,168,255,0.15);color:var(--accent);}

    .actionBtn{
      padding:8px 10px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      margin-right:6px;
      font-size:12px;
    }

    .approve{
      background:rgba(49,209,139,0.20);
      color:var(--good);
    }

    .deny{
      background:rgba(255,92,122,0.20);
      color:var(--bad);
    }

    .pay{
      background:rgba(93,168,255,0.20);
      color:var(--accent);
    }

    .actionBtn:hover{opacity:0.85;}

    footer{
      margin-top:20px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="panel">

    <div class="topbar">
      <div>
        <h1>Withdrawal Requests</h1>
        <p>Admin-only payout control panel for StudentStream creators.</p>
      </div>

      <a href="/studios/index.html" class="btn">← Back Dashboard</a>
    </div>

    <table>
      <thead>
        <tr>
          <th>Creator</th>
          <th>Creator ID</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Status</th>
          <th>Requested</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody id="withdrawTable">
        <tr>
          <td colspan="7" style="color:var(--muted);padding:20px;">
            Loading withdrawal requests...
          </td>
        </tr>
      </tbody>
    </table>

  </div>

  <footer>
    © <span id="year"></span> StudentStream HQ — Admin Withdrawals
  </footer>

</div>

<!-- =========================================
     SUPABASE ADMIN WITHDRAWAL SYSTEM (V30)
     ========================================= -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://iabzmoxzbqzcqgypxctr.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
  );

  document.getElementById("year").textContent = new Date().getFullYear();

  // =========================================
  // ADMIN PROTECTION
  // =========================================
  const { data: sessionData } = await supabase.auth.getSession();

  if (!sessionData.session) {
    window.location.href = "/studios/login.html";
  }

  const userId = sessionData.session.user.id;

  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", userId)
    .single();

  if (profile?.role !== "admin") {
    alert("Access Denied — Admins Only.");
    window.location.href = "/studios/index.html";
  }

  // =========================================
  // LOAD WITHDRAWALS
  // =========================================
  async function loadWithdrawals() {
    const table = document.getElementById("withdrawTable");

    const { data, error } = await supabase
      .from("creator_withdrawals")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      table.innerHTML = `<tr><td colspan="7">Error loading withdrawals.</td></tr>`;
      return;
    }

    if (!data || data.length === 0) {
      table.innerHTML = `<tr><td colspan="7">No withdrawal requests yet.</td></tr>`;
      return;
    }

    table.innerHTML = "";

    data.forEach(req => {
      table.innerHTML += `
        <tr>
          <td>${req.creator_name || "Unknown"}</td>
          <td style="color:var(--muted);font-size:12px;">
            ${req.creator_id}
          </td>
          <td><b>$${Number(req.amount).toFixed(2)}</b></td>
          <td>${req.method}</td>
          <td>
            <span class="status ${req.status}">
              ${req.status.toUpperCase()}
            </span>
          </td>
          <td>${new Date(req.created_at).toLocaleString()}</td>
          <td>
            ${
              req.status === "pending"
              ? `
                <button class="actionBtn approve"
                  onclick="updateStatus('${req.id}','approved')">
                  Approve
                </button>

                <button class="actionBtn deny"
                  onclick="updateStatus('${req.id}','denied')">
                  Deny
                </button>
              `
              : req.status === "approved"
              ? `
                <button class="actionBtn pay"
                  onclick="updateStatus('${req.id}','paid')">
                  Mark Paid
                </button>
              `
              : `<span style="color:var(--muted)">Complete</span>`
            }
          </td>
        </tr>
      `;
    });
  }

  // =========================================
  // UPDATE STATUS
  // =========================================
  window.updateStatus = async function(id, newStatus) {

    if (!confirm(`Are you sure you want to mark this as ${newStatus}?`)) {
      return;
    }

    const { error } = await supabase
      .from("creator_withdrawals")
      .update({ status: newStatus })
      .eq("id", id);

    if (error) {
      alert("Failed update.");
      return;
    }

    loadWithdrawals();
  };

  loadWithdrawals();
</script>

</body>
</html>