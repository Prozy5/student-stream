<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================
       STUDENTSTREAM STUDIOS ‚Äî ADMIN HQ V200
       Ultimate Owner Dashboard (Realtime + Logs)
       ========================================= -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

  <title>Studios Admin HQ ‚Ä¢ StudentStream</title>

  <style>
    :root{
      --bg:#070A12;
      --panel:#0E1424;
      --text:#EAF0FF;
      --muted:#A9B4D0;
      --line:rgba(255,255,255,0.08);
      --glow:rgba(120,180,255,0.22);

      --good:#31D18B;
      --warn:#FFD35A;
      --bad:#FF5C7A;

      --radius:18px;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      font-family:system-ui,Segoe UI,Roboto;
      background:
        radial-gradient(circle at top, rgba(93,168,255,0.14), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{
      max-width:1400px;
      margin:auto;
      padding:30px 18px 90px;
    }

    h1{font-size:30px;}
    p{color:var(--muted);margin-top:4px;}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px;
      border-radius:var(--radius);
      background:rgba(14,20,36,0.82);
      border:1px solid var(--line);
      backdrop-filter:blur(18px);
    }

    .btn{
      padding:10px 15px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.05);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      transition:.2s;
      text-decoration:none;
    }

    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 0 0 4px var(--glow);
    }

    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:14px;
      margin-top:20px;
    }

    .stat{
      padding:18px;
      border-radius:18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(93,168,255,0.12), rgba(255,255,255,0.02));
    }

    .stat b{
      font-size:24px;
      display:block;
      margin-bottom:5px;
    }

    .grid{
      margin-top:25px;
      display:grid;
      grid-template-columns:1.25fr 0.75fr;
      gap:18px;
    }

    @media(max-width:900px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      padding:18px;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:rgba(14,20,36,0.82);
      backdrop-filter:blur(16px);
    }

    .listing{
      padding:14px;
      border-radius:15px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.02);
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .status{
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
    }

    .pending{background:rgba(255,211,90,0.15);color:var(--warn);}
    .paid{background:rgba(49,209,139,0.15);color:var(--good);}
    .denied{background:rgba(255,92,122,0.15);color:var(--bad);}

    .actions{
      display:flex;
      gap:8px;
    }

    .mini{
      padding:7px 10px;
      border-radius:10px;
      font-size:12px;
      border:none;
      cursor:pointer;
      font-weight:900;
    }

    .approveBtn{background:var(--good);color:black;}
    .denyBtn{background:var(--bad);color:white;}

    footer{
      margin-top:35px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar">
    <div>
      <h1>üé¨ Studios Admin HQ</h1>
      <p>Owner Dashboard ‚Äî Withdrawals ‚Ä¢ Sales ‚Ä¢ Creator Earnings</p>
    </div>
    <a href="/studios/index.html" class="btn">‚Üê Back Studios</a>
  </div>

  <!-- KPI -->
  <div class="stats">
    <div class="stat"><b id="statCreators">0</b><span>Total Creators</span></div>
    <div class="stat"><b id="statSales">$0.00</b><span>Total Revenue</span></div>
    <div class="stat"><b id="statCreatorEarn">$0.00</b><span>Total Creator Earnings</span></div>
    <div class="stat"><b id="statPending">0</b><span>Pending Withdrawals</span></div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid">

    <!-- WITHDRAWALS -->
    <div class="card">
      <h2>üí∏ Pending Withdrawals</h2>
      <div id="withdrawalsBox">
        <p style="color:var(--muted);">Loading‚Ä¶</p>
      </div>
    </div>

    <!-- SALES -->
    <div class="card">
      <h2>üìà Recent Marketplace Sales</h2>
      <div id="salesBox">
        <p style="color:var(--muted);">Loading‚Ä¶</p>
      </div>
    </div>

  </div>

  <footer>
    ¬© <span id="year"></span> StudentStream Studios Admin HQ V200
  </footer>

</div>

<!-- =========================================
     SUPABASE SYSTEM V200 (FIXED)
     ========================================= -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

document.getElementById("year").textContent = new Date().getFullYear();

function dollars(cents){
  return "$" + ((cents||0)/100).toFixed(2);
}

/* LOAD KPI STATS */
async function loadStats(){

  const creators = await supabase.from("creators").select("id");
  document.getElementById("statCreators").textContent =
    creators.data?.length || 0;

  const sales = await supabase
    .from("marketplace_sales")
    .select("amount_cents, creator_earn_cents");

  let rev=0, earn=0;
  sales.data?.forEach(s=>{
    rev += s.amount_cents||0;
    earn += s.creator_earn_cents||0;
  });

  document.getElementById("statSales").textContent = dollars(rev);
  document.getElementById("statCreatorEarn").textContent = dollars(earn);

  const pending = await supabase
    .from("creator_withdrawals")
    .select("id")
    .eq("status","pending");

  document.getElementById("statPending").textContent =
    pending.data?.length || 0;
}

/* LOAD WITHDRAWALS (FIXED JOIN VIEW) */
async function loadWithdrawals(){

  const box=document.getElementById("withdrawalsBox");

  const { data } = await supabase
    .from("creator_withdrawals_admin")
    .select("*")
    .eq("status","pending")
    .limit(6);

  if(!data || data.length===0){
    box.innerHTML="<p style='color:var(--muted);'>No pending withdrawals.</p>";
    return;
  }

  box.innerHTML="";

  data.forEach(req=>{
    box.innerHTML += `
      <div class="listing">
        <div>
          <b>${req.display_name || req.username}</b><br/>
          <span>${dollars(req.amount_cents)}</span><br/>
          <small style="color:var(--muted);">
            Method: ${req.payout_method}
          </small>
        </div>

        <div class="actions">
          <button class="mini approveBtn"
            onclick="approve('${req.id}')">
            Approve
          </button>

          <button class="mini denyBtn"
            onclick="deny('${req.id}')">
            Deny
          </button>
        </div>
      </div>
    `;
  });
}

/* APPROVE */
window.approve = async function(id){
  await supabase
    .from("creator_withdrawals")
    .update({ status:"paid", processed_at:new Date() })
    .eq("id",id);

  alert("Marked Paid ‚úÖ");
  loadWithdrawals();
  loadStats();
};

/* DENY */
window.deny = async function(id){
  const reason = prompt("Reason for denial?");
  await supabase
    .from("creator_withdrawals")
    .update({ status:"denied", note:reason, processed_at:new Date() })
    .eq("id",id);

  alert("Denied ‚ùå");
  loadWithdrawals();
  loadStats();
};

/* LOAD SALES */
async function loadSales(){
  const box=document.getElementById("salesBox");

  const { data } = await supabase
    .from("marketplace_sales_admin")
    .select("*")
    .limit(6);

  if(!data || data.length===0){
    box.innerHTML="<p style='color:var(--muted);'>No sales yet.</p>";
    return;
  }

  box.innerHTML="";

  data.forEach(sale=>{
    box.innerHTML += `
      <div class="listing">
        <div>
          <b>${sale.asset_title}</b><br/>
          <span>${dollars(sale.amount_cents)}</span>
        </div>
        <span class="status ${
          sale.payout_status==="paid" ? "paid" : "pending"
        }">
          ${sale.payout_status.toUpperCase()}
        </span>
      </div>
    `;
  });
}

/* REALTIME AUTO REFRESH */
supabase.channel("admin-live")
.on("postgres_changes",
  { event:"*", schema:"public", table:"creator_withdrawals" },
  ()=>loadWithdrawals()
)
.subscribe();

loadStats();
loadWithdrawals();
loadSales();
</script>

</body>
</html>