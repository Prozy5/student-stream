<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Studios Admin — StudentStream</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
body{
margin:0;
background:#040406;
color:#fff;
}
.container{
max-width:1200px;
margin:auto;
padding:60px 20px;
}
h1{
font-size:2.8rem;
margin-bottom:6px;
}
p{opacity:.7}

table{
width:100%;
border-collapse:collapse;
margin-top:30px;
}
th,td{
padding:14px;
border-bottom:1px solid rgba(255,255,255,.12);
text-align:left;
font-size:.95rem;
}
th{opacity:.6}

.status{
padding:4px 10px;
border-radius:999px;
font-size:.75rem;
}
.pending{background:rgba(255,193,7,.25);color:#ffc107}
.approved{background:rgba(108,242,194,.25);color:#6cf2c2}
.rejected{background:rgba(244,67,54,.25);color:#f44336}

button{
padding:8px 14px;
border-radius:999px;
border:none;
cursor:pointer;
font-weight:600;
font-size:.8rem;
margin-right:6px;
}
.approve{background:#6cf2c2;color:#040406}
.reject{background:#f44336;color:#fff}
.logout{
margin-top:30px;
background:transparent;
border:1px solid rgba(255,255,255,.3);
color:#fff;
}
</style>
</head>

<body>
<div class="container">

<h1>Studios Admin</h1>
<p>Review, approve, and manage creator submissions.</p>

<table>
<thead>
<tr>
  <th>Title</th>
  <th>Type</th>
  <th>Creator</th>
  <th>Cash App</th>
  <th>Status</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<button class="logout" onclick="logout()">Log out</button>

</div>

<script>
const supabase = supabaseJs.createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

async function guardAdmin(){
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    location.href = "/studios/login.html";
    return;
  }

  const { data: admin } = await supabase
    .from("admins")
    .select("user_id")
    .eq("user_id", user.id)
    .single();

  if (!admin) {
    alert("Access denied");
    location.href = "/studios";
  }
}

async function loadSubmissions(){
  const { data, error } = await supabase
    .from("creator_uploads")
    .select(`
      id,
      title,
      type,
      status,
      creators (
        display_name,
        cashapp_tag
      )
    `)
    .order("created_at", { ascending: false });

  if (error) {
    alert(error.message);
    return;
  }

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  data.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.title}</td>
      <td>${item.type}</td>
      <td>${item.creators?.display_name || "—"}</td>
      <td>${item.creators?.cashapp_tag || "—"}</td>
      <td>
        <span class="status ${item.status}">
          ${item.status}
        </span>
      </td>
      <td>
        ${item.status === "pending" ? `
          <button class="approve" onclick="updateStatus('${item.id}','approved')">Approve</button>
          <button class="reject" onclick="updateStatus('${item.id}','rejected')">Reject</button>
        ` : "—"}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function updateStatus(id, status){
  const { error } = await supabase
    .from("creator_uploads")
    .update({ status })
    .eq("id", id);

  if (error) {
    alert(error.message);
    return;
  }

  loadSubmissions();
}

async function logout(){
  await supabase.auth.signOut();
  location.href = "/studios";
}

guardAdmin();
loadSubmissions();
</script>

</body>
</html>