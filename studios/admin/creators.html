<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================
       STUDIOS ADMIN CREATOR DIRECTORY
       creators.html • Manual Payout Control
       ========================================= -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Creator Directory • Admin</title>
  <meta name="description" content="Studios Admin Creator Directory — balances, earnings, payouts." />

  <style>
    :root{
      --bg:#070A12;
      --panel:#0E1424;
      --text:#EAF0FF;
      --muted:#A9B4D0;
      --line:rgba(255,255,255,0.12);
      --accent:#5DA8FF;
      --good:#31D18B;
      --bad:#FF5C7A;
      --radius:18px;
    }

    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(circle at top, rgba(93,168,255,0.14), transparent 65%),
        radial-gradient(circle at right, rgba(124,92,255,0.10), transparent 65%),
        var(--bg);
      color:var(--text);
      padding:24px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
    }

    h1{
      font-size:22px;
      font-weight:900;
    }

    a{
      color:var(--muted);
      font-size:13px;
      font-weight:700;
      text-decoration:none;
    }

    table{
      width:100%;
      margin-top:22px;
      border-collapse:collapse;
      background:rgba(14,20,36,0.80);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
    }

    th,td{
      padding:14px;
      font-size:13px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      text-align:left;
    }

    th{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      text-transform:uppercase;
    }

    .paid{
      color:var(--good);
      font-weight:900;
    }

    .unpaid{
      color:var(--bad);
      font-weight:900;
    }

    button{
      border:none;
      padding:8px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      background:linear-gradient(135deg,var(--accent),#7C5CFF);
      color:white;
      font-size:12px;
    }

    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }

    .error{
      margin-top:18px;
      color:var(--bad);
      font-weight:800;
      display:none;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <h1>Creator Directory</h1>
    <a href="/studios/admin/index.html">← Back to Admin HQ</a>
  </header>

  <p style="color:var(--muted);max-width:720px;font-size:14px;">
    View creator balances and manage manual payouts.  
    Creators earn <b>70%</b> of each sale. Stripe automation will be enabled later.
  </p>

  <!-- TABLE -->
  <table>
    <thead>
      <tr>
        <th>Creator ID</th>
        <th>Total Sales</th>
        <th>Owed (70%)</th>
        <th>Status</th>
        <th>Payout</th>
      </tr>
    </thead>
    <tbody id="creatorTable">
      <tr><td colspan="5">Loading creators…</td></tr>
    </tbody>
  </table>

  <p id="errorBox" class="error"></p>

  <!-- =========================================
       SUPABASE CREATOR DIRECTORY LOGIC
       ========================================= -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const errorBox = document.getElementById("errorBox");
    const table = document.getElementById("creatorTable");

    // Require login
    const { data: sessionData } = await supabase.auth.getSession();
    if (!sessionData.session) {
      window.location.href = "/studios/login.html";
    }

    // Load sales grouped by seller
    const { data: sales, error } = await supabase
      .from("marketplace_sales")
      .select("seller_id, amount, status");

    if (error) {
      errorBox.style.display = "block";
      errorBox.textContent = "Error loading creators: " + error.message;
      throw error;
    }

    // Group totals
    const creators = {};

    sales.forEach(sale => {
      if (!creators[sale.seller_id]) {
        creators[sale.seller_id] = {
          total: 0,
          unpaid: 0
        };
      }

      creators[sale.seller_id].total += sale.amount;

      if (sale.status === "unpaid") {
        creators[sale.seller_id].unpaid += sale.amount;
      }
    });

    const creatorIDs = Object.keys(creators);

    if (!creatorIDs.length) {
      table.innerHTML = `<tr><td colspan="5">No creators yet.</td></tr>`;
    } else {
      table.innerHTML = "";

      creatorIDs.forEach(id => {
        const totalSales = creators[id].total;
        const unpaid = creators[id].unpaid;
        const owed = unpaid * 0.7;

        table.innerHTML += `
          <tr>
            <td>${id.slice(0,8)}…</td>
            <td>$${totalSales.toFixed(2)}</td>
            <td>$${owed.toFixed(2)}</td>
            <td class="${owed > 0 ? "unpaid" : "paid"}">
              ${owed > 0 ? "UNPAID" : "PAID"}
            </td>
            <td>
              <button
                ${owed === 0 ? "disabled" : ""}
                onclick="payCreator('${id}', ${owed})">
                Mark Paid
              </button>
            </td>
          </tr>
        `;
      });
    }

    // Manual payout action
    window.payCreator = async (sellerId, amount) => {
      if (!confirm("Mark payout as complete?")) return;

      // Insert payout record
      await supabase.from("creator_payouts").insert({
        seller_id: sellerId,
        payout_amount: amount,
        payout_method: "manual",
        notes: "Admin marked paid"
      });

      // Mark sales as paid
      await supabase
        .from("marketplace_sales")
        .update({ status: "paid" })
        .eq("seller_id", sellerId)
        .eq("status", "unpaid");

      alert("Creator marked as paid.");
      location.reload();
    };
  </script>

</body>
</html>