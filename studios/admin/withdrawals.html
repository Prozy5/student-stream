<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================
       STUDENTSTREAM STUDIOS ‚Äî WITHDRAWALS HQ
       withdrawals.html (Admin Panel V30)
       ========================================= -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Withdrawals ‚Ä¢ StudentStream Admin</title>

  <style>
    :root{
      --bg:#070A12;
      --panel:#0E1424;
      --text:#EAF0FF;
      --muted:#A9B4D0;
      --line:rgba(255,255,255,0.08);

      --good:#31D18B;
      --warn:#FFD35A;
      --bad:#FF5C7A;

      --radius:18px;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      font-family:system-ui,Segoe UI,Roboto;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{
      max-width:1250px;
      margin:auto;
      padding:30px 18px 80px;
    }

    h1{
      font-size:28px;
      margin-bottom:6px;
    }

    p{
      color:var(--muted);
      margin-bottom:18px;
    }

    /* TOPBAR */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 18px;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:rgba(14,20,36,0.85);
    }

    .btn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      transition:0.2s;
    }

    .btn:hover{
      transform:translateY(-1px);
    }

    /* SEARCH + FILTER */
    .controls{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-top:18px;
    }

    .search{
      flex:1;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.03);
      color:var(--text);
      outline:none;
    }

    .filterBtn{
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
    }

    .filterBtn.active{
      color:var(--text);
      border-color:rgba(120,180,255,0.4);
    }

    /* TABLE */
    .table{
      margin-top:18px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
    }

    .row{
      display:grid;
      grid-template-columns:
        1.3fr
        0.7fr
        1fr
        0.9fr
        1fr
        1.2fr;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      align-items:center;
      font-size:14px;
    }

    .row.head{
      background:rgba(255,255,255,0.04);
      font-weight:900;
      color:var(--muted);
    }

    .status{
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      display:inline-block;
      text-align:center;
      width:95px;
    }

    .pending{background:rgba(255,211,90,0.15);color:var(--warn);}
    .paid{background:rgba(49,209,139,0.15);color:var(--good);}
    .denied{background:rgba(255,92,122,0.15);color:var(--bad);}

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .mini{
      padding:7px 10px;
      border-radius:10px;
      font-size:12px;
      border:none;
      cursor:pointer;
      font-weight:800;
    }

    .approveBtn{background:var(--good);color:black;}
    .denyBtn{background:var(--bad);color:white;}
    .payBtn{background:var(--warn);color:black;}

    footer{
      margin-top:25px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }

    /* MODAL */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:99;
    }

    .modalBox{
      background:var(--panel);
      border:1px solid var(--line);
      padding:20px;
      border-radius:18px;
      width:340px;
      text-align:center;
    }

    .modalBox h2{
      margin-bottom:10px;
    }

    .modalBox p{
      font-size:14px;
      color:var(--muted);
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar">
    <div>
      <h1>üí∏ Withdrawals HQ</h1>
      <p>Approve, deny, or process creator payout requests</p>
    </div>

    <a href="admin.html" class="btn">‚Üê Back Dashboard</a>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <input
      id="searchBox"
      class="search"
      placeholder="Search creator name..."
    />

    <button class="filterBtn active" onclick="setFilter('all')">All</button>
    <button class="filterBtn" onclick="setFilter('pending')">Pending</button>
    <button class="filterBtn" onclick="setFilter('paid')">Paid</button>
    <button class="filterBtn" onclick="setFilter('denied')">Denied</button>
  </div>

  <!-- TABLE -->
  <div class="table" id="withdrawalsTable"></div>

  <footer>
    StudentStream Studios Admin ‚Ä¢ Withdrawals System V30
  </footer>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modalBox">
    <h2 id="modalTitle">Confirm</h2>
    <p id="modalText"></p>

    <br/>
    <button class="mini approveBtn" id="confirmBtn">Yes</button>
    <button class="mini denyBtn" onclick="closeModal()">Cancel</button>
  </div>
</div>

<!-- =========================================
     SUPABASE WITHDRAWAL CONTROL V30
     ========================================= -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let allRequests = [];
  let currentFilter = "all";
  let modalAction = null;

  function dollars(cents){
    return "$" + (cents/100).toFixed(2);
  }

  function formatDate(dateStr){
    return new Date(dateStr).toLocaleString();
  }

  /* LOAD WITHDRAWALS */
  async function loadWithdrawals(){

    const { data } = await supabase
      .from("creator_withdrawals")
      .select("*")
      .order("created_at",{ascending:false});

    allRequests = data || [];
    renderTable();
  }

  /* RENDER TABLE */
  function renderTable(){

    const table = document.getElementById("withdrawalsTable");

    table.innerHTML = `
      <div class="row head">
        <div>Creator</div>
        <div>Amount</div>
        <div>Method</div>
        <div>Date</div>
        <div>Status</div>
        <div>Actions</div>
      </div>
    `;

    let filtered = allRequests;

    if (currentFilter !== "all"){
      filtered = filtered.filter(r => r.status === currentFilter);
    }

    const search = document.getElementById("searchBox").value.toLowerCase();
    if (search){
      filtered = filtered.filter(r =>
        (r.creator_name || "").toLowerCase().includes(search)
      );
    }

    if (filtered.length === 0){
      table.innerHTML += `
        <div class="row">
          <div style="color:var(--muted);">
            No withdrawal requests found.
          </div>
        </div>
      `;
      return;
    }

    filtered.forEach(req=>{

      let statusClass =
        req.status==="paid" ? "paid" :
        req.status==="denied" ? "denied" :
        "pending";

      table.innerHTML += `
        <div class="row">
          <div>
            <b>${req.creator_name}</b><br/>
            <span style="color:var(--muted);font-size:12px;">
              ${req.creator_email || "No email"}
            </span>
          </div>

          <div>${dollars(req.amount)}</div>

          <div>${req.payout_method || "manual"}</div>

          <div style="color:var(--muted);font-size:12px;">
            ${formatDate(req.created_at)}
          </div>

          <div>
            <span class="status ${statusClass}">
              ${req.status.toUpperCase()}
            </span>
          </div>

          <div class="actions">
            ${
              req.status==="pending"
              ? `
                <button class="mini approveBtn"
                  onclick="openModal('approve','${req.id}')">
                  Approve
                </button>

                <button class="mini denyBtn"
                  onclick="openModal('deny','${req.id}')">
                  Deny
                </button>

                <button class="mini payBtn"
                  onclick="alert('Stripe payout integration coming soon üí≥')">
                  Pay Creator
                </button>
              `
              : `<span style="color:var(--muted);">Done</span>`
            }
          </div>
        </div>
      `;
    });
  }

  /* FILTER */
  function setFilter(filter){
    currentFilter = filter;

    document.querySelectorAll(".filterBtn").forEach(btn=>{
      btn.classList.remove("active");
    });

    event.target.classList.add("active");
    renderTable();
  }

  window.setFilter = setFilter;

  /* SEARCH */
  document.getElementById("searchBox").addEventListener("input", renderTable);

  /* MODAL */
  function openModal(type,id){

    const modal = document.getElementById("modal");
    modal.style.display="flex";

    modalAction = async ()=>{
      await supabase
        .from("creator_withdrawals")
        .update({
          status: type==="approve" ? "paid" : "denied",
          processed_at: new Date()
        })
        .eq("id",id);

      closeModal();
      loadWithdrawals();
    };

    document.getElementById("modalTitle").textContent =
      type==="approve" ? "Approve Withdrawal?" : "Deny Withdrawal?";

    document.getElementById("modalText").textContent =
      "This action will update payout status permanently.";

    document.getElementById("confirmBtn").onclick = modalAction;
  }

  function closeModal(){
    document.getElementById("modal").style.display="none";
  }

  window.openModal = openModal;
  window.closeModal = closeModal;

  loadWithdrawals();
</script>

</body>
</html>