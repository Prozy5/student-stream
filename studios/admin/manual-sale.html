<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manual Sale Entry â€” Studios Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;background:#050507;color:#fff;padding:30px}
h1{margin-bottom:6px}
p{opacity:.7}

form{
max-width:520px;
background:rgba(255,255,255,.06);
border:1px solid rgba(255,255,255,.12);
border-radius:22px;
padding:28px;
margin-top:30px;
}
label{display:block;font-size:.8rem;opacity:.6;margin-top:18px}
input,select{
width:100%;
margin-top:6px;
padding:12px 14px;
border-radius:12px;
border:1px solid rgba(255,255,255,.15);
background:#0b0b0f;
color:#fff;
}
button{
margin-top:26px;
padding:14px;
width:100%;
border:none;
border-radius:999px;
font-weight:600;
cursor:pointer;
background:linear-gradient(135deg,#6cf2c2,#7aa2ff);
color:#050507;
}
.success{color:#6cf2c2;margin-top:16px}
.error{color:#ff6b6b;margin-top:16px}
</style>
</head>

<body>

<h1>Manual Sale Entry</h1>
<p>Record off-platform or custom sales</p>

<form id="saleForm">
  <label>Sale Title</label>
  <input id="title" placeholder="Brand license / Custom project" required>

  <label>Creator</label>
  <select id="creator" required></select>

  <label>Total Sale Amount ($)</label>
  <input id="amount" type="number" step="0.01" required>

  <label>Creator Cut ($)</label>
  <input id="creatorCut" type="number" step="0.01" required>

  <label>Status</label>
  <select id="status">
    <option value="pending">Pending</option>
    <option value="paid">Paid</option>
  </select>

  <button type="submit">Record Sale</button>
  <div id="msg"></div>
</form>

<script>
const supabase = supabaseJs.createClient(
 "https://iabzmoxzbqzcqgypxctr.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

(async()=>{
 const {data:{user}} = await supabase.auth.getUser();
 if(!user){location.href="/studios/login";return;}

 const {data:profile} = await supabase
  .from("profiles")
  .select("role")
  .eq("id",user.id)
  .single();

 if(profile?.role!=="admin"){
  document.body.innerHTML="<h2>Access denied</h2>";
  return;
 }

 // Load creators
 const {data:creators} = await supabase
  .from("profiles")
  .select("id, full_name")
  .eq("role","creator");

 document.getElementById("creator").innerHTML =
  creators.map(c=>`<option value="${c.id}">${c.full_name||c.id}</option>`).join("");
})();

document.getElementById("saleForm").addEventListener("submit", async e=>{
 e.preventDefault();
 const msg=document.getElementById("msg");
 msg.textContent="";

 const title=titleInput.value;
 const creator_id=creator.value;
 const amount=Number(amountInput.value);
 const creator_cut=Number(creatorCut.value);
 const status=statusSelect.value;

 const {error} = await supabase
  .from("marketplace_sales")
  .insert({
    title,
    creator_id,
    amount,
    creator_cut,
    platform_cut: amount - creator_cut,
    status,
    paid_at: status==="paid" ? new Date().toISOString() : null
  });

 if(error){
  msg.textContent=error.message;
  msg.className="error";
 }else{
  msg.textContent="Sale recorded successfully";
  msg.className="success";
  saleForm.reset();
 }
});

// inputs
const titleInput=document.getElementById("title");
const amountInput=document.getElementById("amount");
const creatorCut=document.getElementById("creatorCut");
const statusSelect=document.getElementById("status");
const creator=document.getElementById("creator");
const saleForm=document.getElementById("saleForm");
</script>

</body>
</html>