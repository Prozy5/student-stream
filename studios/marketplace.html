<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================
       STUDIOS PUBLIC MARKETPLACE (LIVE v20000)
       marketplace.html • Supabase Listings
       Manual Purchase Requests (No Stripe Yet)
       ========================================= -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Marketplace • Studios</title>
  <meta name="description" content="Browse licensed creative assets, design packs, visuals, and production-ready work from Studios creators." />

  <style>
    :root{
      --bg:#070A12;
      --panel:#0E1424;
      --text:#EAF0FF;
      --muted:#A9B4D0;
      --line:rgba(255,255,255,0.12);
      --accent:#5DA8FF;
      --radius:20px;
    }

    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(circle at top, rgba(93,168,255,0.14), transparent 65%),
        radial-gradient(circle at right, rgba(124,92,255,0.10), transparent 65%),
        var(--bg);
      color:var(--text);
      padding:24px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
      gap:14px;
    }

    h1{
      font-size:24px;
      font-weight:900;
    }

    a{
      color:var(--muted);
      font-size:13px;
      font-weight:700;
      text-decoration:none;
      transition:0.2s;
    }

    a:hover{
      color:white;
    }

    .notice{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width:800px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:18px;
      margin-top:26px;
    }

    .card{
      background:rgba(14,20,36,0.88);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      transition:.25s;
      animation:fadeUp 0.4s ease;
    }

    .card:hover{
      transform:translateY(-6px);
      border-color:rgba(93,168,255,0.4);
    }

    .title{
      font-size:16px;
      font-weight:900;
      margin-bottom:6px;
    }

    .desc{
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
      margin-bottom:12px;
    }

    .meta{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .price{
      font-size:15px;
      font-weight:900;
      color:var(--accent);
    }

    button{
      width:100%;
      border:none;
      padding:12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      background:linear-gradient(135deg,var(--accent),#7C5CFF);
      color:white;
      font-size:13px;
      transition:0.2s;
    }

    button:hover{
      opacity:0.92;
      transform:translateY(-2px);
    }

    .empty{
      margin-top:40px;
      color:var(--muted);
      font-weight:800;
    }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:999;
      padding:18px;
    }

    .modal{
      background:rgba(14,20,36,0.96);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:18px;
      padding:20px;
      max-width:420px;
      width:100%;
    }

    .modal h2{
      margin:0 0 10px;
      font-size:18px;
      font-weight:900;
    }

    .modal p{
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }

    .modalActions{
      display:flex;
      gap:10px;
      margin-top:16px;
    }

    .modalActions button{
      flex:1;
    }

    .secondaryBtn{
      background:transparent;
      border:1px solid rgba(255,255,255,0.18);
    }

    @keyframes fadeUp{
      from{opacity:0; transform:translateY(10px);}
      to{opacity:1; transform:translateY(0);}
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <h1>Studios Marketplace</h1>
    <a id="backLink" href="/studios/index.html">← Back to Studios</a>
  </header>

  <p style="color:var(--muted);max-width:780px;">
    Browse licensed creative assets, production packs, visuals, and digital work.
  </p>

  <!-- Manual checkout notice -->
  <div class="notice">
    <b>Manual Purchase Requests Active</b><br>
    Checkout is currently handled manually while Stripe integration is being prepared.
    Click “Request Purchase” and the Studios team will contact you.
  </div>

  <!-- Listings Grid -->
  <section class="grid" id="listingGrid">
    <p class="empty">Loading marketplace…</p>
  </section>

  <!-- PURCHASE MODAL -->
  <div class="modalOverlay" id="purchaseModal">
    <div class="modal">
      <h2 id="modalTitle">Request Purchase</h2>
      <p id="modalDesc"></p>

      <div class="modalActions">
        <button id="copyBtn" class="secondaryBtn">Copy Listing ID</button>
        <button onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- =========================================
       SUPABASE LISTINGS FETCH (UPGRADED)
       ========================================= -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const grid = document.getElementById("listingGrid");

    // Load listings
    const { data: listings, error } = await supabase
      .from("marketplace_listings")
      .select("*")
      .eq("status", "active")
      .order("created_at", { ascending: false });

    if (error) {
      grid.innerHTML = `<p class="empty">Error loading marketplace. Try again soon.</p>`;
      console.error(error);
      throw error;
    }

    if (!listings || listings.length === 0) {
      grid.innerHTML = `<p class="empty">No listings yet. Check back soon.</p>`;
    } else {
      grid.innerHTML = "";

      listings.forEach(item => {
        const safePrice = item.price ? Number(item.price).toFixed(2) : "0.00";

        grid.innerHTML += `
          <div class="card">
            <div class="title">${item.title}</div>
            <div class="desc">${item.description || "No description provided."}</div>

            <div class="meta">
              <span>${item.category || "General"}</span>
              <span class="price">$${safePrice}</span>
            </div>

            <button onclick="requestPurchase('${item.title}', '${item.id}')">
              Request Purchase
            </button>
          </div>
        `;
      });
    }

    // Manual purchase request modal
    window.requestPurchase = (title, id) => {
      document.getElementById("purchaseModal").style.display = "flex";

      document.getElementById("modalTitle").textContent =
        "Purchase Request Submitted";

      document.getElementById("modalDesc").innerHTML =
        `<b>${title}</b><br><br>
        Listing ID: <code>${id}</code><br><br>
        Studios will contact you manually for payment + delivery.`;

      document.getElementById("copyBtn").onclick = async () => {
        await navigator.clipboard.writeText(id);
        alert("Listing ID copied.");
      };
    };

    window.closeModal = () => {
      document.getElementById("purchaseModal").style.display = "none";
    };
  </script>

</body>
</html>