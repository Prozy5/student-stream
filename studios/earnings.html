<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ============================================
      STUDENTSTREAM STUDIOS ‚Äî EARNINGS PANEL V400
      Creator + Monetization Club Dashboard
  ============================================ -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Earnings ‚Ä¢ StudentStream Studios</title>

  <style>
    :root{
      --bg:#070A12;
      --panel:#0E1424;
      --text:#EAF0FF;
      --muted:#A9B4D0;
      --line:rgba(255,255,255,0.08);
      --glow:rgba(120,180,255,0.22);

      --good:#31D18B;
      --warn:#FFD35A;
      --bad:#FF5C7A;
      --brand:#5DA8FF;

      --radius:18px;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      font-family:system-ui,Segoe UI,Roboto;
      background:
        radial-gradient(circle at top, rgba(93,168,255,0.14), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{
      max-width:1200px;
      margin:auto;
      padding:30px 18px 90px;
    }

    h1{font-size:28px;margin-bottom:6px;}
    p{color:var(--muted);margin-bottom:18px;}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 18px;
      border-radius:var(--radius);
      background:rgba(14,20,36,0.75);
      border:1px solid var(--line);
      backdrop-filter:blur(14px);
    }

    .btn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      transition:0.2s;
      text-decoration:none;
      display:inline-block;
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 0 0 4px var(--glow);
    }

    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:14px;
      margin-top:20px;
    }

    .stat{
      padding:16px;
      border-radius:18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(93,168,255,0.10), rgba(255,255,255,0.02));
    }

    .stat b{
      font-size:24px;
      display:block;
      margin-bottom:4px;
    }

    .stat span{
      color:var(--muted);
      font-size:13px;
    }

    .grid{
      margin-top:22px;
      display:grid;
      grid-template-columns:1.2fr 0.8fr;
      gap:18px;
    }

    @media(max-width:900px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      padding:18px;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:rgba(14,20,36,0.75);
      backdrop-filter:blur(14px);
    }

    input,select{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      margin-top:8px;
      outline:none;
    }

    .monoBadge{
      display:inline-block;
      padding:7px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      margin-top:10px;
    }

    .activeClub{
      background:rgba(49,209,139,0.15);
      color:var(--good);
    }

    .inactiveClub{
      background:rgba(255,92,122,0.15);
      color:var(--bad);
    }

    .listing{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.02);
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .status{
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
    }

    .pending{background:rgba(255,211,90,0.15);color:var(--warn);}
    .paid{background:rgba(49,209,139,0.15);color:var(--good);}
    .denied{background:rgba(255,92,122,0.15);color:var(--bad);}

    footer{
      margin-top:30px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar">
    <div>
      <h1>üí∞ Creator Earnings</h1>
      <p>Your Studios balance, payouts & Monetization Club access</p>
    </div>
    <a href="/studios/index.html" class="btn">‚Üê Back Studios</a>
  </div>

  <!-- KPI STATS -->
  <div class="stats">
    <div class="stat">
      <b id="totalSales">$0.00</b>
      <span>Total Marketplace Sales</span>
    </div>

    <div class="stat">
      <b id="creatorEarned">$0.00</b>
      <span>Total Creator Earnings</span>
    </div>

    <div class="stat">
      <b id="withdrawn">$0.00</b>
      <span>Total Withdrawn</span>
    </div>

    <div class="stat">
      <b id="available">$0.00</b>
      <span>Available Balance</span>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid">

    <!-- LEFT SIDE -->
    <div class="card">
      <h2>üé¨ Monetization Club Status</h2>
      <p style="font-size:13px;">
        SS-Films Monetization Club gives you access to ad revenue + paid film payouts.
      </p>

      <div id="clubBadge" class="monoBadge inactiveClub">
        Loading status...
      </div>

      <hr style="margin:18px 0;border:0;border-top:1px solid var(--line);">

      <h2>üí∏ Request Withdrawal</h2>
      <p style="font-size:13px;">
        Withdraw your available earnings manually (admin approves).
      </p>

      <input id="withdrawAmount" type="number" placeholder="Amount in dollars (ex: 25)" />
      
      <select id="withdrawMethod">
        <option value="paypal">PayPal</option>
        <option value="cashapp">CashApp</option>
        <option value="manual">Manual</option>
      </select>

      <button class="btn" style="margin-top:12px;width:100%;" onclick="requestWithdrawal()">
        Submit Withdrawal Request
      </button>

      <p id="withdrawMsg" style="margin-top:10px;font-size:13px;color:var(--muted);"></p>
    </div>

    <!-- RIGHT SIDE -->
    <div class="card">
      <h2>üìú Withdrawal History</h2>
      <p style="font-size:13px;">
        Track all cashout requests + status updates.
      </p>

      <div id="historyBox">
        <p style="color:var(--muted);">Loading withdrawals‚Ä¶</p>
      </div>
    </div>

  </div>

  <footer>
    ¬© <span id="year"></span> StudentStream Studios ‚Äî Earnings Panel V400
  </footer>

</div>

<!-- ============================================
     SUPABASE SYSTEM
============================================ -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://iabzmoxzbqzcqgypxctr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  document.getElementById("year").textContent = new Date().getFullYear();

  function dollars(cents){
    return "$" + (cents/100).toFixed(2);
  }

  /* AUTH */
  const { data: sessionData } = await supabase.auth.getSession();
  if (!sessionData.session){
    window.location.href="/studios/login.html";
  }

  const userId = sessionData.session.user.id;

  /* LOAD CREATOR DASHBOARD VIEW */
  async function loadEarnings(){

    const { data } = await supabase
      .from("creator_earnings_dashboard")
      .select("*")
      .eq("creator_id", userId)
      .single();

    if (!data){
      alert("No creator earnings profile found.");
      return;
    }

    document.getElementById("totalSales").textContent =
      dollars(data.total_sales_cents);

    document.getElementById("creatorEarned").textContent =
      dollars(data.total_creator_earned_cents);

    document.getElementById("withdrawn").textContent =
      dollars(data.total_withdrawn_cents);

    let available =
      data.total_creator_earned_cents - data.total_withdrawn_cents;

    document.getElementById("available").textContent =
      dollars(Math.max(available,0));

    // Monetization Club Status
    const badge = document.getElementById("clubBadge");

    if (available >= 5000){
      badge.textContent = "‚úÖ Active Monetization Club Member";
      badge.className = "monoBadge activeClub";
    } else {
      badge.textContent = "‚ùå Not Yet Eligible (Need $50+)";
      badge.className = "monoBadge inactiveClub";
    }
  }

  /* LOAD WITHDRAWALS */
  async function loadHistory(){

    const box = document.getElementById("historyBox");

    const { data } = await supabase
      .from("creator_withdrawals")
      .select("*")
      .eq("creator_id", userId)
      .order("created_at",{ascending:false})
      .limit(10);

    if (!data || data.length===0){
      box.innerHTML="<p style='color:var(--muted);'>No withdrawals yet.</p>";
      return;
    }

    box.innerHTML="";

    data.forEach(w=>{
      box.innerHTML += `
        <div class="listing">
          <div>
            <b>${(w.amount_cents/100).toFixed(2)} USD</b><br/>
            <small style="color:var(--muted);">
              Method: ${w.method}
            </small>
          </div>

          <span class="status ${w.status}">
            ${w.status.toUpperCase()}
          </span>
        </div>
      `;
    });
  }

  /* REQUEST WITHDRAWAL */
  window.requestWithdrawal = async function(){

    const amount = Number(document.getElementById("withdrawAmount").value);
    const method = document.getElementById("withdrawMethod").value;
    const msg = document.getElementById("withdrawMsg");

    if (!amount || amount < 5){
      msg.textContent = "Minimum withdrawal is $5.";
      return;
    }

    const cents = Math.floor(amount * 100);

    const { error } = await supabase
      .from("creator_withdrawals")
      .insert({
        creator_id: userId,
        amount_cents: cents,
        method: method,
        status: "pending"
      });

    if (error){
      msg.textContent = "Error: " + error.message;
      return;
    }

    msg.textContent = "Withdrawal request submitted ‚úÖ";
    loadHistory();
    loadEarnings();
  };

  loadEarnings();
  loadHistory();
</script>

</body>
</html>