<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Topic ‚Ä¢ StudentStream DevForum</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:system-ui;
  background:radial-gradient(circle at top,#0d1b3a,#05070c);
  color:white;
  min-height:100vh;
}

header{
  position:sticky;
  top:0;
  z-index:100;
  padding:18px 26px;
  border-bottom:1px solid rgba(255,255,255,.08);
  backdrop-filter:blur(18px);
  background:rgba(5,7,12,.85);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logo{font-size:18px;font-weight:950}
.logo span{color:#4da3ff}
.back{opacity:.65;cursor:pointer;font-weight:700}

.wrap{
  max-width:950px;
  margin:55px auto;
  padding:0 20px;
  padding-bottom:160px;
}

/* Topic */
.topicHero{
  padding:38px;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.035);
  margin-bottom:35px;
}

.topicHero h1{
  font-size:38px;
  font-weight:950;
  margin-bottom:14px;
}

.topicBody{
  font-size:15px;
  line-height:1.9;
  opacity:.95;
  white-space:pre-wrap;
  margin-top:18px;
}

.lockedBanner,.pinnedBanner,.deletedBanner{
  padding:10px 14px;
  border-radius:14px;
  font-size:13px;
  font-weight:900;
  margin-bottom:14px;
  display:inline-block;
}

.lockedBanner{
  background:rgba(255,77,77,.15);
  border:1px solid rgba(255,77,77,.35);
  color:#ff4d4d;
}

.pinnedBanner{
  background:rgba(255,215,0,.12);
  border:1px solid rgba(255,215,0,.25);
  color:gold;
}

.deletedBanner{
  background:rgba(255,255,255,.05);
  border:1px dashed rgba(255,255,255,.2);
  color:#aaa;
}

.userRow{
  display:flex;
  align-items:center;
  gap:14px;
  margin-top:18px;
}

.avatar{
  width:44px;
  height:44px;
  border-radius:50%;
  background:linear-gradient(135deg,#2f6fff,#4da3ff);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
}

.staffBadge{
  font-size:11px;
  font-weight:950;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.05);
  text-transform:uppercase;
  margin-left:8px;
}

.modTools{
  margin-top:22px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.modBtn{
  padding:10px 14px;
  border-radius:14px;
  font-size:12px;
  font-weight:850;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.06);
  cursor:pointer;
}

.modBtn:hover{transform:scale(1.05)}

.danger{
  border-color:rgba(255,77,77,.35);
  color:#ff4d4d;
}

/* Replies */
.replyCard{
  padding:22px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.02);
  margin-bottom:18px;
}

.replyCard.accepted{
  border:1px solid rgba(0,255,150,.4);
  background:rgba(0,255,150,.06);
}

.replyText{
  margin-top:12px;
  font-size:14px;
  line-height:1.7;
  white-space:pre-wrap;
  padding-left:58px;
}

.reactionBar{
  margin-top:12px;
  padding-left:58px;
  display:flex;
  gap:10px;
}

.reactBtn{
  padding:6px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);
  cursor:pointer;
  font-size:13px;
}

.replyActions{
  margin-top:10px;
  padding-left:58px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.composerBar{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  padding:16px;
  backdrop-filter:blur(18px);
  background:rgba(5,7,12,.92);
  border-top:1px solid rgba(255,255,255,.08);
}

.composerInner{
  max-width:900px;
  margin:auto;
  display:flex;
  gap:12px;
}

textarea{
  flex:1;
  min-height:52px;
  padding:14px 16px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  color:white;
  resize:none;
}

button{
  border:none;
  cursor:pointer;
  padding:13px 20px;
  border-radius:16px;
  font-weight:850;
  font-size:13px;
  color:white;
  background:linear-gradient(135deg,#2f6fff,#4da3ff);
}
</style>
</head>
<body>

<header>
  <div class="logo">StudentStream <span>DevForum</span></div>
  <div class="back" onclick="history.back()">‚Üê Back</div>
</header>

<div class="wrap">

<div class="topicHero">
  <div id="topicFlags"></div>
  <h1 id="topicTitle">Loading‚Ä¶</h1>

  <div class="userRow">
    <div class="avatar" id="topicAvatar"></div>
    <div>
      <div id="topicAuthor"></div>
      <div id="topicDate" style="font-size:12px;opacity:.6"></div>
    </div>
  </div>

  <div class="topicBody" id="topicBody"></div>

  <div class="modTools" id="modTools" style="display:none;">
    <div class="modBtn" onclick="toggleLock()">üîí Lock</div>
    <div class="modBtn" onclick="togglePin()">üìå Pin</div>
    <div class="modBtn" onclick="editTopic()">‚úè Edit</div>
    <div class="modBtn" onclick="softDeleteTopic()">üóë Soft Delete</div>
    <div class="modBtn danger" onclick="hardDeleteTopic()">‚ùå Hard Delete</div>
    <div class="modBtn" onclick="clearReplies()">üßπ Clear Replies</div>
  </div>
</div>

<h2>Replies</h2>
<div id="replyList"></div>

</div>

<div class="composerBar">
  <div class="composerInner">
    <textarea id="replyInput" maxlength="5000" placeholder="Write a reply‚Ä¶"></textarea>
    <button onclick="submitReply()">Post</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient("https://iabzmoxzbqzcqgypxctr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ");
const topicId = new URLSearchParams(location.search).get("id");

let topicData=null;
let currentUser=null;

/* LOAD USER */
async function loadUser(){
  const { data:{user} } = await supabase.auth.getUser();
  currentUser=user;
}

/* LOAD TOPIC */
async function loadTopic(){
  const { data } = await supabase
    .from("forum_topics")
    .select("*")
    .eq("id",topicId)
    .single();

  topicData=data;
  document.getElementById("topicTitle").textContent=data.title;
  document.getElementById("topicBody").textContent=data.content;
  document.getElementById("topicDate").textContent =
    new Date(data.created_at).toLocaleString();

  if(data.locked){
    document.getElementById("topicFlags").innerHTML+=
      `<div class="lockedBanner">Locked</div>`;
    document.getElementById("replyInput").disabled=true;
  }

  if(data.pinned){
    document.getElementById("topicFlags").innerHTML+=
      `<div class="pinnedBanner">Pinned</div>`;
  }

  if(data.deleted){
    document.getElementById("topicFlags").innerHTML+=
      `<div class="deletedBanner">Deleted (Soft)</div>`;
  }
}

/* LOAD REPLIES (Realtime) */
async function loadReplies(){
  const { data } = await supabase
    .from("forum_replies")
    .select("*")
    .eq("topic_id",topicId)
    .order("created_at");

  const list=document.getElementById("replyList");
  list.innerHTML="";

  data.forEach(r=>{
    const div=document.createElement("div");
    div.className="replyCard"+(topicData.accepted_reply_id===r.id?" accepted":"");

    div.innerHTML=`
      <div class="replyText">${r.deleted?"[deleted]":r.content}</div>
      <div class="reactionBar">
        <div class="reactBtn" onclick="reactReply('${r.id}','like')">üëç</div>
        <div class="reactBtn" onclick="reactReply('${r.id}','heart')">‚ù§Ô∏è</div>
      </div>
      <div class="replyActions">
        <div class="reactBtn" onclick="acceptReply('${r.id}')">‚úÖ Accept</div>
        <div class="reactBtn" onclick="editReply('${r.id}')">‚úè Edit</div>
        <div class="reactBtn" onclick="softDeleteReply('${r.id}')">üóë Soft</div>
        <div class="reactBtn danger" onclick="hardDeleteReply('${r.id}')">‚ùå Hard</div>
      </div>
    `;
    list.appendChild(div);
  });
}

/* REPLY */
window.submitReply=async()=>{
  const text=document.getElementById("replyInput").value.trim();
  if(!text||!currentUser) return;

  await supabase.from("forum_replies").insert([{
    topic_id:topicId,
    user_id:currentUser.id,
    content:text
  }]);

  document.getElementById("replyInput").value="";
};

/* MODERATION FUNCTIONS */
window.toggleLock=()=>supabase.from("forum_topics")
  .update({locked:!topicData.locked}).eq("id",topicId).then(loadTopic);

window.togglePin=()=>supabase.from("forum_topics")
  .update({pinned:!topicData.pinned}).eq("id",topicId).then(loadTopic);

window.softDeleteTopic=()=>supabase.from("forum_topics")
  .update({deleted:true}).eq("id",topicId).then(loadTopic);

window.hardDeleteTopic=()=>supabase.from("forum_topics")
  .delete().eq("id",topicId).then(()=>location.href="index.html");

window.clearReplies=()=>supabase.from("forum_replies")
  .delete().eq("topic_id",topicId).then(loadReplies);

window.acceptReply=id=>supabase.from("forum_topics")
  .update({accepted_reply_id:id}).eq("id",topicId).then(loadReplies);

window.softDeleteReply=id=>supabase.from("forum_replies")
  .update({deleted:true}).eq("id",id).then(loadReplies);

window.hardDeleteReply=id=>supabase.from("forum_replies")
  .delete().eq("id",id).then(loadReplies);

window.editReply=id=>{
  const newText=prompt("Edit reply:");
  if(!newText) return;
  supabase.from("forum_replies")
    .update({content:newText}).eq("id",id).then(loadReplies);
};

window.reactReply=id=>{
  if(!currentUser) return;
  supabase.from("forum_reply_reactions")
    .insert([{reply_id:id,user_id:currentUser.id,reaction:"like"}]);
};

/* REALTIME */
supabase.channel("replies")
  .on("postgres_changes",{event:"*",schema:"public",table:"forum_replies"},
    ()=>loadReplies()
  ).subscribe();

(async()=>{
  await loadUser();
  await loadTopic();
  await loadReplies();
})();
</script>

</body>
</html>