<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Category • StudentStream DevForum</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui,-apple-system;
  background:radial-gradient(circle at top,#0d1b3a,#05070c 60%);
  color:white;
  min-height:100vh;
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:100;
  padding:18px 26px;
  backdrop-filter:blur(18px);
  background:rgba(5,7,12,.85);
  border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logo{font-weight:900;font-size:20px}
.logo span{color:#4da3ff}
.back{opacity:.7;cursor:pointer}

/* CONTAINER */
.container{
  max-width:1100px;
  margin:60px auto;
  padding:0 20px;
}

/* HERO */
.categoryHero{
  padding:32px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
  margin-bottom:25px;
}

.categoryHero h1{font-size:34px;font-weight:900}
.categoryHero p{margin-top:10px;opacity:.6;font-size:14px}

.actionBar{
  margin-top:22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:15px;
}

.meta{font-size:13px;opacity:.5}

.sortSelect{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);
  color:white;
  font-size:13px;
}

.newBtn{
  border:none;
  cursor:pointer;
  padding:10px 18px;
  border-radius:14px;
  font-weight:800;
  font-size:13px;
  color:white;
  background:linear-gradient(135deg,#2f6fff,#4da3ff);
  transition:.2s;
}
.newBtn:hover{transform:scale(1.05)}
.newBtn:disabled{opacity:.5;cursor:not-allowed}

/* TOPICS */
.topicCard{
  padding:22px;
  border-radius:18px;
  margin-bottom:14px;
  border:1px solid rgba(255,255,255,.07);
  background:rgba(255,255,255,.03);
  cursor:pointer;
  transition:.2s;
  display:flex;
  justify-content:space-between;
  gap:20px;
}
.topicCard:hover{
  border-color:rgba(77,163,255,.5);
  transform:translateY(-3px);
}

.topicLeft{flex:1}
.topicTitle{font-size:17px;font-weight:850}
.topicMeta{margin-top:8px;font-size:13px;opacity:.6}

.topicRight{text-align:right;font-size:12px;opacity:.7}

.replyBadge{
  background:rgba(255,255,255,.08);
  padding:6px 12px;
  border-radius:999px;
  font-weight:700;
}

.pin{
  font-size:12px;
  background:#ffcc00;
  color:black;
  padding:4px 8px;
  border-radius:999px;
  margin-right:8px;
}

/* PAGINATION */
.pagination{
  margin-top:25px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}

.pageBtn{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.05);
  cursor:pointer;
}
.pageBtn.active{
  background:#4da3ff;
  border-color:#4da3ff;
}

/* EMPTY */
.empty{
  text-align:center;
  opacity:.5;
  padding:45px;
  border:1px dashed rgba(255,255,255,.15);
  border-radius:18px;
}

/* MODAL */
.modalOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal{
  width:100%;
  max-width:600px;
  padding:25px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(15,20,35,.98);
}

.modal input,
.modal textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  color:white;
  margin-top:10px;
  font-size:14px;
}

textarea{min-height:180px}

.counter{
  margin-top:6px;
  font-size:12px;
  opacity:.5;
  text-align:right;
}

footer{
  text-align:center;
  padding:40px;
  opacity:.4;
  margin-top:80px;
  border-top:1px solid rgba(255,255,255,.08);
}
</style>
</head>

<body>

<header>
  <div class="logo">StudentStream <span>DevForum</span></div>
  <div class="back" onclick="history.back()">← Back</div>
</header>

<div class="container">

  <div class="categoryHero">
    <h1 id="catTitle">Loading...</h1>
    <p id="catDesc"></p>

    <div class="actionBar">
      <span class="meta" id="topicCount">Loading…</span>

      <div style="display:flex;gap:10px;align-items:center;">
        <select class="sortSelect" id="sortSelect">
          <option value="latest">Latest</option>
          <option value="oldest">Oldest</option>
          <option value="replies">Most Replies</option>
        </select>
        <button class="newBtn" id="newTopicBtn">+ New Topic</button>
      </div>
    </div>
  </div>

  <div id="topicList"></div>
  <div class="pagination" id="pagination"></div>

</div>

<footer>
© 2026 StudentStreamHQ • Category
</footer>

<!-- MODAL -->
<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <h2>Create Topic</h2>
    <input id="titleInput" placeholder="Topic title..." maxlength="120"/>
    <textarea id="bodyInput" placeholder="Write your post..." maxlength="5000"></textarea>
    <div class="counter" id="charCount">0 / 5000</div>
    <div style="margin-top:18px;text-align:right;">
      <button class="newBtn" onclick="closeModal()">Cancel</button>
      <button class="newBtn" id="submitBtn" onclick="submitTopic()">Post</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient("https://iabzmoxzbqzcqgypxctr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ");

const categoryId = new URLSearchParams(location.search).get("id");
const topicList = document.getElementById("topicList");
const topicCount = document.getElementById("topicCount");
const pagination = document.getElementById("pagination");
const sortSelect = document.getElementById("sortSelect");
const newTopicBtn = document.getElementById("newTopicBtn");

let currentPage = 1;
const perPage = 10;
let currentUser = null;

/* AUTH CHECK */
async function checkUser(){
  const { data:{user} } = await supabase.auth.getUser();
  currentUser = user;
  if(!user){
    newTopicBtn.disabled = true;
    newTopicBtn.textContent = "Login to Post";
  }
}

/* LOAD CATEGORY */
async function loadCategory(){
  const { data,error } = await supabase
    .from("forum_categories")
    .select("*")
    .eq("id", categoryId)
    .single();

  if(error || !data) return;

  document.getElementById("catTitle").textContent=data.name;
  document.getElementById("catDesc").textContent=data.description||"";
}

/* LOAD TOPICS */
async function loadTopics(){
  topicList.innerHTML="";

  let ascending = sortSelect.value==="oldest";
  let orderColumn = sortSelect.value==="replies" ? "reply_count" : "created_at";

  const from = (currentPage-1)*perPage;
  const to = from + perPage -1;

  const { data, count, error } = await supabase
    .from("forum_topics")
    .select(`
      id,title,created_at,pinned,
      forum_replies(count)
    `,{count:"exact"})
    .eq("category_id", categoryId)
    .order("pinned",{ascending:false})
    .order(orderColumn,{ascending})
    .range(from,to);

  if(error) return console.error(error);

  if(!data || data.length===0){
    topicList.innerHTML=`<div class="empty">No discussions yet.</div>`;
    topicCount.textContent="0 discussions";
    return;
  }

  topicCount.textContent=`${count} discussions`;

  data.forEach(topic=>{
    const replies = topic.forum_replies?.[0]?.count || 0;

    const card=document.createElement("div");
    card.className="topicCard";
    card.innerHTML=`
      <div class="topicLeft">
        <div class="topicTitle">
          ${topic.pinned ? `<span class="pin">Pinned</span>` : ""}
          ${topic.title}
        </div>
        <div class="topicMeta">
          ${new Date(topic.created_at).toLocaleString()}
        </div>
      </div>
      <div class="topicRight">
        <div class="replyBadge">${replies} Replies</div>
      </div>
    `;
    card.onclick=()=>location.href="topic.html?id="+topic.id;
    topicList.appendChild(card);
  });

  renderPagination(count);
}

/* PAGINATION */
function renderPagination(total){
  pagination.innerHTML="";
  const pages = Math.ceil(total/perPage);

  for(let i=1;i<=pages;i++){
    const btn=document.createElement("div");
    btn.className="pageBtn";
    if(i===currentPage) btn.classList.add("active");
    btn.textContent=i;
    btn.onclick=()=>{
      currentPage=i;
      loadTopics();
    };
    pagination.appendChild(btn);
  }
}

/* MODAL */
const modalOverlay=document.getElementById("modalOverlay");
newTopicBtn.onclick=()=>{ if(currentUser) modalOverlay.style.display="flex"; };
window.closeModal=()=>modalOverlay.style.display="none";

/* CHARACTER COUNT */
const bodyInput=document.getElementById("bodyInput");
const charCount=document.getElementById("charCount");
bodyInput.addEventListener("input",()=>{
  charCount.textContent=bodyInput.value.length+" / 5000";
});

/* SUBMIT */
window.submitTopic=async()=>{
  if(!currentUser) return alert("Login required.");

  const title=document.getElementById("titleInput").value.trim();
  const content=bodyInput.value.trim();
  if(title.length<3) return alert("Title too short");

  document.getElementById("submitBtn").disabled=true;

  const { error } = await supabase.from("forum_topics")
    .insert([{
      title,
      content,
      category_id:categoryId,
      user_id:currentUser.id
    }]);

  document.getElementById("submitBtn").disabled=false;

  if(error) return alert(error.message);

  closeModal();
  loadTopics();
};

sortSelect.onchange=()=>{currentPage=1;loadTopics();};

(async()=>{
  await checkUser();
  await loadCategory();
  await loadTopics();
})();
</script>

</body>
</html>