<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>StudentStream DevForum</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#090c12;
  --panel:#0f172a;
  --panel2:#111827;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#22c55e;
  --blue:#3b82f6;
  --amber:#f59e0b;
  --red:#ef4444;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,sans-serif;
}

/* HEADER */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  border-bottom:1px solid var(--border);
}
header h1{font-size:15px;margin:0}
header span{font-size:12px;color:var(--muted)}
header input{
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  padding:7px 10px;
  border-radius:6px;
  width:260px;
}

/* LAYOUT */
.layout{
  display:grid;
  grid-template-columns:300px 1fr;
  min-height:calc(100vh - 60px);
}

/* SIDEBAR */
aside{
  background:var(--panel);
  border-right:1px solid var(--border);
  padding:12px;
}
.group{
  margin-bottom:16px;
}
.group-title{
  font-size:11px;
  color:var(--muted);
  margin-bottom:6px;
  text-transform:uppercase;
}
.cat{
  padding:10px 12px;
  border-radius:6px;
  cursor:pointer;
}
.cat.active{
  background:#1f2937;
  border-left:3px solid var(--accent);
}
.cat-name{
  display:flex;
  justify-content:space-between;
  font-size:14px;
}
.cat-desc{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
}

/* MAIN */
main{padding:16px}

/* TABS */
.tabs{
  display:flex;
  gap:10px;
  margin-bottom:14px;
}
.tab{
  padding:6px 14px;
  border-radius:999px;
  background:#1f2937;
  font-size:13px;
  cursor:pointer;
}
.tab.active{
  background:var(--accent);
  color:#052e16;
  font-weight:600;
}

/* THREAD */
.thread{
  display:grid;
  grid-template-columns:1fr 120px 140px;
  gap:14px;
  padding:14px;
  border-bottom:1px solid var(--border);
  cursor:pointer;
}
.thread:hover{background:var(--panel2)}

.thread h3{
  margin:0;
  font-size:15px;
  display:flex;
  gap:8px;
  align-items:center;
}

.badge{
  font-size:10px;
  padding:2px 6px;
  border-radius:999px;
}
.pin{background:#1e3a8a;color:#bfdbfe}
.lock{background:#27272a}
.ann{background:#1d4ed8}
.update{background:#92400e}
.rfc{background:#065f46}
.incident{background:#7f1d1d}

.preview{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
  max-width:720px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.stats, .activity{
  font-size:12px;
  color:var(--muted);
  text-align:right;
}

/* EMPTY */
.empty{
  padding:60px;
  text-align:center;
  color:var(--muted);
}

/* MOBILE */
@media(max-width:1000px){
  .layout{grid-template-columns:1fr}
  aside{display:none}
  .thread{grid-template-columns:1fr}
  .stats,.activity{text-align:left}
}
</style>
</head>

<body>

<header>
  <div>
    <h1>StudentStream DevForum</h1>
    <span>Engineering ‚Ä¢ Platform ‚Ä¢ Systems</span>
  </div>
  <input id="search" placeholder="Search DevForum‚Ä¶" />
</header>

<div class="layout">
  <aside id="categories"></aside>

  <main>
    <div class="tabs">
      <div class="tab active" data-mode="hot">üî• Hot</div>
      <div class="tab" data-mode="new">üïí New</div>
      <div class="tab" data-mode="trending">üìà Trending</div>
    </div>

    <div id="threads"></div>
  </main>
</div>

<script>
const supabase = supabase.createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
)

let categories=[], threads=[]
let activeCategory=null
let mode="hot"

/* CATEGORY LOAD */
async function loadCategories(){
  const {data}=await supabase
    .from("forum_categories")
    .select("id,name,description,group,forum_threads(count)")
  categories=data||[]

  const el=document.getElementById("categories")
  el.innerHTML=""
  const groups={}

  categories.forEach(c=>{
    groups[c.group]=groups[c.group]||[]
    groups[c.group].push(c)
  })

  Object.keys(groups).forEach(g=>{
    const wrap=document.createElement("div")
    wrap.className="group"
    wrap.innerHTML=`<div class="group-title">${g}</div>`
    groups[g].forEach((c,i)=>{
      const d=document.createElement("div")
      d.className="cat"
      d.innerHTML=`
        <div class="cat-name">
          <span>${c.name}</span>
          <span>${c.forum_threads?.[0]?.count||0}</span>
        </div>
        <div class="cat-desc">${c.description||""}</div>
      `
      d.onclick=()=>{
        document.querySelectorAll(".cat").forEach(x=>x.classList.remove("active"))
        d.classList.add("active")
        activeCategory=c.id
        render()
      }
      if(!activeCategory){activeCategory=c.id; d.classList.add("active")}
      wrap.appendChild(d)
    })
    el.appendChild(wrap)
  })
}

/* THREAD LOAD */
async function loadThreads(){
  const {data}=await supabase
    .from("forum_threads")
    .select(`
      id,title,preview,created_at,last_activity,
      views,is_pinned,is_locked,type,category_id,
      forum_replies(count),
      forum_likes(count)
    `)
  threads=data||[]
  render()
}

/* ALGORITHMS */
function hotScore(t){
  const r=t.forum_replies?.[0]?.count||0
  const l=t.forum_likes?.[0]?.count||0
  const age=(Date.now()-new Date(t.created_at))/36e5
  return (l*2+r*3)/Math.max(age,1)
}

/* RENDER */
function render(){
  const q=document.getElementById("search").value.toLowerCase()
  const el=document.getElementById("threads")
  el.innerHTML=""

  let list=threads.filter(t=>
    (!activeCategory||t.category_id===activeCategory) &&
    t.title.toLowerCase().includes(q)
  )

  if(mode==="new") list.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))
  if(mode==="hot") list.sort((a,b)=>hotScore(b)-hotScore(a))
  if(mode==="trending"){
    const cut=Date.now()-12*3600*1000
    list=list.filter(t=>new Date(t.last_activity||t.created_at)>=cut)
    list.sort((a,b)=>hotScore(b)-hotScore(a))
  }

  list.sort((a,b)=>b.is_pinned-a.is_pinned)

  if(!list.length){
    el.innerHTML=`<div class="empty">No threads yet.</div>`
    return
  }

  list.forEach(t=>{
    const r=t.forum_replies?.[0]?.count||0
    const l=t.forum_likes?.[0]?.count||0

    const d=document.createElement("div")
    d.className="thread"
    d.innerHTML=`
      <div>
        <h3>
          ${t.is_pinned?'<span class="badge pin">PIN</span>':''}
          ${t.is_locked?'<span class="badge lock">LOCKED</span>':''}
          ${t.type?`<span class="badge ${t.type}">${t.type.toUpperCase()}</span>`:''}
          ${t.title}
        </h3>
        <div class="preview">${t.preview||""}</div>
      </div>
      <div class="stats">
        üëÅÔ∏è ${t.views||0}<br>
        üí¨ ${r} ¬∑ üëç ${l}
      </div>
      <div class="activity">
        ${new Date(t.last_activity||t.created_at).toLocaleString()}
      </div>
    `
    d.onclick=()=>location.href="/thread.html?id="+t.id
    el.appendChild(d)
  })
}

/* EVENTS */
document.getElementById("search").addEventListener("input",render)
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"))
    t.classList.add("active")
    mode=t.dataset.mode
    render()
  }
})

/* INIT */
loadCategories()
loadThreads()
</script>

</body>
</html>