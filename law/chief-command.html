<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chief Command ¬∑ StudentStream Law</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="/js/platform-guard.js"></script>

<style>
:root{
  --bg:#05080f;
  --panel:#0c1626;
  --panel2:#101f35;
  --accent:#ff5d5d;
  --accent2:#ff2f2f;
  --text:#eaf1ff;
  --muted:#9fb0cc;
  --border:rgba(255,255,255,0.08);
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:system-ui;
  background:radial-gradient(circle at top,#0c1b33,#05080f);
  color:var(--text);
}

/* HEADER */
header{
  padding:18px 24px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(10,20,40,.85);
  backdrop-filter:blur(14px);
}

header h1{
  font-size:18px;
  font-weight:950;
}

.chiefTag{
  color:var(--accent);
  font-weight:950;
}

.wrap{
  max-width:1200px;
  margin:auto;
  padding:40px 22px;
}

.section{
  margin-top:35px;
}

.section h2{
  font-size:18px;
  font-weight:950;
  margin-bottom:14px;
}

/* ALERT SYSTEM */
.alertBox{
  padding:18px;
  border-radius:18px;
  border:1px solid rgba(255,93,93,.35);
  background:rgba(255,93,93,.08);
}

.alertBox input{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.05);
  color:white;
  outline:none;
}

button{
  margin-top:12px;
  padding:11px 16px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  font-weight:900;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#200000;
}

button.secondary{
  background:rgba(255,255,255,.06);
  border:1px solid var(--border);
  color:var(--text);
}

/* TABLE */
.table{
  width:100%;
  border-collapse:collapse;
  overflow:hidden;
  border-radius:16px;
  border:1px solid var(--border);
}

.table th{
  text-align:left;
  padding:12px;
  font-size:13px;
  color:var(--muted);
  background:rgba(255,255,255,.03);
}

.table td{
  padding:12px;
  border-top:1px solid rgba(255,255,255,.06);
}

select{
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.05);
  color:white;
}

.actionBtn{
  padding:7px 12px;
  border-radius:10px;
  font-size:12px;
  font-weight:850;
  cursor:pointer;
  border:none;
}

.banBtn{
  background:rgba(255,93,93,.18);
  color:var(--accent);
}

.suspendBtn{
  background:rgba(255,255,255,.08);
  color:white;
}

.archiveBtn{
  background:rgba(255,255,255,.08);
  color:var(--muted);
}
</style>
</head>

<body>

<header>
  <h1>‚≠ê Chief Command Center</h1>
  <div id="chiefName" class="chiefTag">Loading...</div>
</header>

<div class="wrap">

  <!-- NATIONAL ALERT -->
  <div class="section">
    <h2>üö® National Enforcement Alert System</h2>

    <div class="alertBox">
      <p style="color:var(--muted);font-size:14px;">
        Publish an official enforcement-wide alert visible to all users.
      </p>

      <input id="alertMessage" placeholder="Type enforcement alert..." />

      <button onclick="publishAlert()">Publish Alert</button>
    </div>
  </div>

  <!-- STAFF RANK CONTROL -->
  <div class="section">
    <h2>‚öñÔ∏è Staff Rank Management</h2>

    <table class="table" id="staffTable">
      <thead>
        <tr>
          <th>User</th>
          <th>Rank</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ACCOUNT CONTROL -->
  <div class="section">
    <h2>üö´ Suspension & Ban Control</h2>

    <table class="table" id="accountTable">
      <thead>
        <tr>
          <th>User</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- CASE CONTROL -->
  <div class="section">
    <h2>üìÇ Case Assignment + Archive</h2>

    <table class="table" id="caseTable">
      <thead>
        <tr>
          <th>Case</th>
          <th>Assigned To</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iabzmoxzbqzcqgypxctr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYnptb3h6YnF6Y3FneXB4Y3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDgzNzAsImV4cCI6MjA4MjY4NDM3MH0.mHke56jh8WSlzzQxa7o2PIxqLRk1eyPRZerJ3avuGkQ"
);

let chiefUser=null;

/* CHIEF LOCK */
async function chiefOnly(){
  const { data:{user} } = await supabase.auth.getUser();
  if(!user){
    alert("Chief login required.");
    location.href="law-login.html";
    return;
  }

  const { data:profile } = await supabase
    .from("profiles")
    .select("username, law_rank")
    .eq("id", user.id)
    .single();

  if(profile.law_rank !== "chief"){
    alert("‚ùå Chief Authority Only.");
    location.href="law.html";
    return;
  }

  chiefUser=user;
  document.getElementById("chiefName").textContent =
    "Chief: " + profile.username;
}

/* ALERT */
window.publishAlert = async()=>{
  const msg=document.getElementById("alertMessage").value.trim();
  if(msg.length<5) return alert("Alert too short.");

  await supabase.from("enforcement_alerts").insert([
    { message:msg }
  ]);

  alert("‚úÖ Alert Published.");
  document.getElementById("alertMessage").value="";
};

/* LOAD STAFF */
async function loadStaff(){
  const { data:staff } = await supabase
    .from("profiles")
    .select("id, username, law_rank")
    .neq("law_rank","none");

  const body=document.querySelector("#staffTable tbody");
  body.innerHTML="";

  staff.forEach(s=>{
    body.innerHTML += `
      <tr>
        <td>${s.username}</td>
        <td>
          <select id="rank-${s.id}">
            <option ${s.law_rank=="officer"?"selected":""}>officer</option>
            <option ${s.law_rank=="detective"?"selected":""}>detective</option>
            <option ${s.law_rank=="commander"?"selected":""}>commander</option>
            <option ${s.law_rank=="chief"?"selected":""}>chief</option>
          </select>
        </td>
        <td>
          <button class="actionBtn suspendBtn"
            onclick="updateRank('${s.id}')">
            Update
          </button>
        </td>
      </tr>
    `;
  });
}

/* UPDATE RANK */
window.updateRank = async(id)=>{
  const newRank=document.getElementById("rank-"+id).value;

  const { error } = await supabase
    .from("profiles")
    .update({ law_rank:newRank })
    .eq("id", id);

  if(error) return alert("‚ùå " + error.message);

  alert("‚úÖ Rank Updated.");
};

/* ACCOUNT CONTROL */
async function loadAccounts(){
  const { data:users } = await supabase
    .from("profiles")
    .select("id, username, suspended, banned");

  const body=document.querySelector("#accountTable tbody");
  body.innerHTML="";

  users.forEach(u=>{
    let status="Active";
    if(u.suspended) status="Suspended";
    if(u.banned) status="Banned";

    body.innerHTML += `
      <tr>
        <td>${u.username}</td>
        <td>${status}</td>
        <td>
          <button class="actionBtn suspendBtn"
            onclick="toggleSuspend('${u.id}',${u.suspended})">
            Suspend
          </button>
          <button class="actionBtn banBtn"
            onclick="banUser('${u.id}')">
            Ban
          </button>
        </td>
      </tr>
    `;
  });
}

window.toggleSuspend = async(id,current)=>{
  await supabase.from("profiles")
    .update({ suspended:!current })
    .eq("id",id);

  loadAccounts();
};

window.banUser = async(id)=>{
  const reason=prompt("Ban reason?");
  if(!reason) return;

  await supabase.from("profiles")
    .update({ banned:true, ban_reason:reason })
    .eq("id",id);

  loadAccounts();
};

/* CASE CONTROL */
async function loadCases(){
  const { data:cases } = await supabase
    .from("law_cases")
    .select("id,title,assigned_to,archived");

  const { data:staff } = await supabase
    .from("profiles")
    .select("id,username")
    .neq("law_rank","none");

  const body=document.querySelector("#caseTable tbody");
  body.innerHTML="";

  cases.forEach(c=>{
    let dropdown=`<select id="assign-${c.id}">
      <option value="">Unassigned</option>`;

    staff.forEach(s=>{
      dropdown+=`
        <option value="${s.id}"
          ${c.assigned_to==s.id?"selected":""}>
          ${s.username}
        </option>`;
    });

    dropdown+=`</select>`;

    body.innerHTML += `
      <tr>
        <td>${c.title}</td>
        <td>${dropdown}</td>
        <td>
          <button class="actionBtn suspendBtn"
            onclick="assignCase('${c.id}')">
            Assign
          </button>
          <button class="actionBtn archiveBtn"
            onclick="archiveCase('${c.id}')">
            Archive
          </button>
        </td>
      </tr>
    `;
  });
}

window.assignCase = async(caseId)=>{
  const staffId=document.getElementById("assign-"+caseId).value || null;

  await supabase.from("law_cases")
    .update({ assigned_to:staffId })
    .eq("id",caseId);

  alert("‚úÖ Case Assigned.");
};

window.archiveCase = async(caseId)=>{
  await supabase.from("law_cases")
    .update({ archived:true, closed_at:new Date() })
    .eq("id",caseId);

  alert("üìÅ Case Archived.");
  loadCases();
};

/* INIT */
(async()=>{
  await chiefOnly();
  await loadStaff();
  await loadAccounts();
  await loadCases();
})();
</script>

</body>
</html>